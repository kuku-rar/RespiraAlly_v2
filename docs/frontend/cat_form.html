<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>è¬èŠ³CATå¥åº·å•å·</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family: Arial, "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
        color: #333;
        font-size: 20px;
        line-height: 1.5;
        transition: background-color 0.3s, color 0.3s;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: background-color 0.3s, border 0.3s;
      }

      h2 {
        font-size: 28px;
        color: #007bff;
        text-align: center;
        margin-bottom: 25px;
        font-weight: bold;
        padding: 10px 0;
        border-bottom: 2px solid #eaeaea;
        transition: color 0.3s, border-bottom-color 0.3s;
      }

      #options {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }

      #options li {
        margin-bottom: 15px;
      }

      button {
        width: 100%;
        padding: 20px 15px;
        font-size: 22px;
        border: none;
        border-radius: 10px;
        background-color: #f0f7ff;
        color: #333;
        text-align: left;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        display: flex;
        align-items: flex-start;
        line-height: 1.4;
      }

      button:hover,
      button:focus {
        background-color: #d4e6ff;
        transform: translateY(-2px);
      }

      button:active {
        transform: translateY(0);
      }

      .score {
        font-size: 32px;
        font-weight: bold;
        margin-right: 15px;
        color: #007bff;
        min-width: 50px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e8f4f8;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
      }

      .emoji {
        font-size: 28px;
        margin-right: 15px;
        display: inline-block;
        min-width: 40px;
        text-align: center;
      }

      .description {
        flex: 1;
        padding-left: 10px;
      }

      .helper-text {
        text-align: center;
        margin-top: 20px;
        font-size: 18px;
        color: #666;
        transition: color 0.3s;
      }

      .contrast-toggle {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ddd;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      body.high-contrast {
        background-color: #000;
        color: #fff;
      }

      body.high-contrast .container {
        background-color: #000;
        border: 2px solid #fff;
      }

      body.high-contrast h2 {
        color: #ffff00;
        border-bottom-color: #fff;
      }

      body.high-contrast .score {
        background-color: #333;
        color: #ffff00;
      }

      body.high-contrast button {
        background-color: #000;
        color: #fff;
        border: 2px solid #fff;
      }

      body.high-contrast .helper-text {
        color: #fff;
      }

      body.high-contrast button:hover,
      body.high-contrast button:focus {
        background-color: #333;
      }

      #loading-text {
        display: none;
        color: #007bff;
        text-align: center;
        font-size: 20px;
        margin-top: 10px;
        transition: color 0.3s;
      }

      body.high-contrast #loading-text {
        color: #ffff00;
      }

      @media screen and (max-width: 480px) {
        body {
          font-size: 24px;
        }

        button {
          font-size: 26px;
        }

        .score {
          font-size: 28px;
          width: 45px;
          height: 45px;
        }
      }
    </style>
  </head>

  <body>
    <button
      class="contrast-toggle"
      onclick="toggleContrast()"
      aria-label="åˆ‡æ›é«˜å°æ¯”åº¦æ¨¡å¼"
    >
      ğŸ‘ï¸
    </button>
    <div class="container" role="main">
      <h2 id="questionText">è«‹å•æ‚¨æœ€è¿‘å’³å—½çš„æƒ…å½¢ï¼Ÿ</h2>
      <ul id="options" role="list"></ul>
      <p id="loading-text">æ­£åœ¨æäº¤ä¸­ï¼Œè«‹ç¨å€™...</p>
      <p class="helper-text">è«‹é»é¸æœ€ç¬¦åˆæ‚¨æƒ…æ³çš„é¸é …</p>
    </div>
    <script>
      const questions = [
        "è«‹å•æ‚¨æœ€è¿‘å’³å—½çš„æƒ…å½¢ï¼Ÿ",
        "æ‚¨è¦ºå¾—è‚ºè£¡é¢æœ‰ç—°å¡ä½å—ï¼Ÿ",
        "æ‚¨æœ‰è¦ºå¾—èƒ¸å£æœƒæ‚¶ã€æœƒç·Šå—ï¼Ÿ",
        "æ‚¨èµ°æ¨“æ¢¯æˆ–ä¸Šå¡æœƒå–˜å—ï¼Ÿ",
        "åœ¨å®¶è£¡æ´»å‹•æœ‰æ²’æœ‰å—åˆ°å½±éŸ¿ï¼Ÿ",
        "æ‚¨æœ‰ä¿¡å¿ƒè‡ªå·±å‡ºé–€èµ°èµ°å—ï¼Ÿ",
        "æœ€è¿‘ç¡çœ æƒ…æ³æ€éº¼æ¨£ï¼Ÿ",
        "æœ€è¿‘ç²¾ç¥ç‹€æ³å¦‚ä½•ï¼Ÿ",
      ];

      const optionsList = [
        [
          "âœ… å®Œå…¨æ²’å’³å—½/nï¼ˆæ•´å¤©éƒ½æ²’æœ‰ï¼‰",
          "ğŸ˜Š å¶çˆ¾å’³ä¸€ä¸‹/nï¼ˆä¸€å¤©1~2æ¬¡ï¼‰",
          "ğŸ˜ æœ‰æ™‚æœƒå’³ï¼ˆä¸å¤ªå½±éŸ¿ï¼‰",
          "ğŸ™ å¸¸å¸¸å’³ï¼ˆæœ‰é»å›°æ“¾ï¼‰",
          "ğŸ¤¢ å¹¾ä¹æ¯å¤©å’³ï¼ˆå¾ˆä¸èˆ’æœï¼‰",
          "ğŸ¥µ ä¸€ç›´å’³ä¸åœï¼ˆéå¸¸é›£å—ï¼‰",
        ],
        [
          "âœ… å®Œå…¨æ²’ç—°ï¼ˆè‚ºéƒ¨æ¸…çˆ½ï¼‰",
          "ğŸ˜Š å¶çˆ¾å¡ç—°ï¼ˆä½†èƒ½æ’å‡ºï¼‰",
          "ğŸ˜ æœ‰é»ç—°ï¼ˆå¶çˆ¾å’³å‡ºï¼‰",
          "ğŸ™ å¸¸æœ‰ç—°ï¼ˆä¸èˆ’æœï¼‰",
          "ğŸ¤¢ ç¶“å¸¸å¾ˆå¤šç—°ï¼ˆå½±éŸ¿èªªè©±ï¼‰",
          "ğŸ¥µ ç—°å¤šåˆ°å‘¼å¸å›°é›£",
        ],
        [
          "âœ… å®Œå…¨ä¸æ‚¶ä¸ç·Š",
          "ğŸ˜Š å¶çˆ¾è¦ºå¾—èƒ¸æ‚¶",
          "ğŸ˜ æœ‰æ™‚æœƒç·Šä¸€ä¸‹",
          "ğŸ™ å¸¸å¸¸æ‚¶ä½ä¸èˆ’æœ",
          "ğŸ¤¢ å¹¾ä¹æ¯å¤©èƒ¸å£ç·Š",
          "ğŸ¥µ èƒ¸æ‚¶é›£å—åˆ°åä¸ä½",
        ],
        [
          "âœ… å®Œå…¨ä¸å–˜ï¼ˆè¼•é¬†èµ°ï¼‰",
          "ğŸ˜Š å¶çˆ¾æœƒå–˜ä¸€ä¸‹",
          "ğŸ˜ æœ‰æ™‚æœƒå–˜ï¼ˆèµ°å¿«ä¸€é»ï¼‰",
          "ğŸ™ å¸¸å¸¸ä¸€èµ°å°±å–˜",
          "ğŸ¤¢ å¹¾ä¹æ¯å¤©ä¸€èµ°å°±å–˜",
          "ğŸ¥µ å¤ªå–˜æ²’è¾¦æ³•èµ°",
        ],
        [
          "âœ… æ´»å‹•å¾ˆæ–¹ä¾¿",
          "ğŸ˜Š å¶çˆ¾æœƒæ‡¶å¾—å‹•",
          "ğŸ˜ æœ‰äº›å®¶å‹™æ²’åŠ›åš",
          "ğŸ™ å¸¸å¸¸è¦ºå¾—åšä¸ä¾†",
          "ğŸ¤¢ å¹¾ä¹ä¸å¤ªèƒ½å‹•",
          "ğŸ¥µ å®Œå…¨ç„¡æ³•è‡ªå·±æ´»å‹•",
        ],
        [
          "âœ… å¾ˆæœ‰ä¿¡å¿ƒè‡ªå·±å‡ºé–€",
          "ğŸ˜Š å¤§éƒ¨åˆ†éƒ½å¯ä»¥å‡ºé–€",
          "ğŸ˜ æœ‰æ™‚æœƒæ“”å¿ƒå‡ºé–€",
          "ğŸ™ å¸¸å¸¸ä¸æ•¢è‡ªå·±èµ°",
          "ğŸ¤¢ å¹¾ä¹éƒ½ä¸å‡ºé–€",
          "ğŸ¥µ å®Œå…¨ä¸æ•¢é›¢å®¶",
        ],
        [
          "âœ… ç¡å¾—å¾ˆå¥½",
          "ğŸ˜Š å¶çˆ¾ç¡ä¸å¥½",
          "ğŸ˜ æœ‰æ™‚æœƒé†’ä¾†",
          "ğŸ™ å¸¸å¸¸ç¡ä¸å¥½",
          "ğŸ¤¢ å¹¾ä¹æ¯å¤©ç¡ä¸å¥½",
          "ğŸ¥µ å®Œå…¨ç¡ä¸å¥½ã€ç²¾ç¥å·®",
        ],
        [
          "âœ… ç²¾ç¥å¾ˆå¥½ï¼ˆæ´»åŠ›å……æ²›ï¼‰",
          "ğŸ˜Š å¶çˆ¾è¦ºå¾—ç´¯",
          "ğŸ˜ æœ‰é»æ²’ç²¾ç¥",
          "ğŸ™ å¸¸å¸¸æä¸èµ·å‹",
          "ğŸ¤¢ å¹¾ä¹æ•´å¤©éƒ½ç´¯",
          "ğŸ¥µ å®Œå…¨æ²’åŠ›åšäº‹",
        ],
      ];

      let current = 0;
      let userId = "unknown_user";
      let patientId = null;
      let accessToken = null;
      let authenticationFailed = false;
      const answers = [];
      const LIFF_ID = "ä½ çš„LIFF_ID"; // è«‹æ›¿æ›ç‚ºå¯¦éš›çš„ LIFF ID

      // ä¿®æ­£ï¼šå®šç¾©ç¼ºå°‘çš„è®Šæ•¸
      let isTaiwanese = true; // é è¨­ä½¿ç”¨åœ‹èª

      async function main() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const context = liff.getContext();
          if (context && context.userId) {
            userId = context.userId;
            // ç²å– LIFF access token
            accessToken = liff.getAccessToken();

            // å˜—è©¦ç²å– patient_id å’Œèªè­‰
            try {
              await authenticateAndGetPatientId();
            } catch (authError) {
              console.error("èªè­‰å¤±æ•—:", authError);
              authenticationFailed = true;
              alert(
                "èªè­‰å¤±æ•—ï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜åˆ°æ‚¨çš„å¸³æˆ¶ä¸­ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚"
              );
            }
          } else {
            authenticationFailed = true;
            alert(
              "ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Šï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚"
            );
          }

          renderQuestion();
          checkSavedContrast();
        } catch (err) {
          console.error("LIFF åˆå§‹åŒ–å¤±æ•—:", err);
          authenticationFailed = true;
          alert("LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œå•å·æ•¸æ“šå°‡ç„¡æ³•å„²å­˜ï¼Œä½†æ‚¨ä»å¯ç¹¼çºŒå¡«å¯«å•å·ã€‚");
          // ç¹¼çºŒæ¸²æŸ“å•é¡Œï¼Œå³ä½¿LIFFå¤±æ•—ä¹Ÿèƒ½ä½¿ç”¨
          renderQuestion();
          checkSavedContrast();
        }
      }

      // æ–°å¢ï¼šèªè­‰ä¸¦ç²å– patient_id çš„å‡½æ•¸
      async function authenticateAndGetPatientId() {
        try {
          const response = await fetch("/api/auth/line/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ lineUserId: userId }),
          });

          if (response.ok) {
            const data = await response.json();
            patientId = data.user.id;
            accessToken = data.access_token; // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ JWT token
            console.log("èªè­‰æˆåŠŸï¼ŒPatient ID:", patientId);
          } else {
            throw new Error(`èªè­‰è«‹æ±‚å¤±æ•—: ${response.status}`);
          }
        } catch (error) {
          console.error("èªè­‰éç¨‹ç™¼ç”ŸéŒ¯èª¤:", error);
          throw error;
        }
      }

      function renderQuestion() {
        const questionElement = document.getElementById("questionText");
        questionElement.innerText = questions[current];
        speak(questions[current]);

        const list = document.getElementById("options");
        list.innerHTML = "";

        optionsList[current].forEach((text, index) => {
          const li = document.createElement("li");
          li.setAttribute("role", "listitem");

          const button = document.createElement("button");
          button.onclick = () => submitScore(index);
          button.tabIndex = 0;
          button.setAttribute(
            "aria-label",
            `åˆ†æ•¸${index}ï¼š${text.replace("/n", " ")}`
          );

          const scoreElement = document.createElement("div");
          scoreElement.className = "score";
          scoreElement.textContent = index;

          const descriptionElement = document.createElement("div");
          descriptionElement.className = "description";
          // è™•ç†æ›è¡Œç¬¦è™Ÿ
          const formattedText = text.replace("/n", "<br>");
          descriptionElement.innerHTML = formattedText;

          button.appendChild(scoreElement);
          button.appendChild(descriptionElement);

          li.appendChild(button);
          list.appendChild(li);
        });
      }

      function speak(text) {
        if (!("speechSynthesis" in window)) return;

        const synth = window.speechSynthesis;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "zh-TW"; // ä½¿ç”¨å°ç£ä¸­æ–‡

        // å–æ¶ˆä»»ä½•æ­£åœ¨é€²è¡Œçš„èªéŸ³
        synth.cancel();

        // ç²å–æ‰€æœ‰å¯ç”¨çš„èªéŸ³
        const voices = synth.getVoices();

        // å°‹æ‰¾ä¸­æ–‡èªéŸ³
        const chineseVoice = voices.find(
          (voice) => voice.lang.includes("zh-TW") || voice.lang.includes("cmn")
        );

        if (chineseVoice) {
          utter.voice = chineseVoice;
        }

        // æ’­æ”¾èªéŸ³
        synth.speak(utter);
      }

      async function submitScore(score) {
        answers.push(score);

        if (current < questions.length - 1) {
          current++;
          renderQuestion();
        } else {
          // CAT é‡è¡¨å®Œæˆï¼Œæäº¤æ•¸æ“š
          showLoading(true);
          await submitCATResults();
        }
      }

      async function submitCATResults() {
        if (authenticationFailed || !patientId || !accessToken) {
          alert(
            "ç”±æ–¼èªè­‰å¤±æ•—ï¼ŒCATå•å·æ•¸æ“šç„¡æ³•å„²å­˜åˆ°æ‚¨çš„å¸³æˆ¶ï¼Œä½†å°‡ç¹¼çºŒé€²è¡Œä¸‹ä¸€å€‹é‡è¡¨ã€‚"
          );
          setTimeout(() => {
            window.location.href = "mmrc_form.html";
          }, 1000);
          return;
        }

        try {
          // å°‡æ•¸çµ„ç­”æ¡ˆæ˜ å°„ç‚ºå¾Œç«¯æœŸæœ›çš„æ ¼å¼
          const scoreFields = [
            "cough_score",
            "phlegm_score",
            "chest_score",
            "breath_score",
            "limit_score",
            "confidence_score",
            "sleep_score",
            "energy_score",
          ];

          const payload = {};
          scoreFields.forEach((field, index) => {
            payload[field] = answers[index] || 0;
          });

          payload.record_date = new Date().toISOString().split("T")[0]; // YYYY-MM-DD æ ¼å¼

          const response = await fetch(
            `/api/v1/patients/${patientId}/questionnaires/cat`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `æäº¤å¤±æ•—: ${response.status} - ${
                errorData.error?.message || "Unknown error"
              }`
            );
          }

          const result = await response.json();
          console.log("CAT å•å·æäº¤æˆåŠŸ:", result);
          alert("CATå•å·æäº¤æˆåŠŸï¼");
        } catch (error) {
          console.error("CATæäº¤å¤±æ•—:", error);
          alert(`CATå•å·æäº¤å¤±æ•—: ${error.message}ï¼Œä½†å°‡ç¹¼çºŒé€²è¡Œä¸‹ä¸€å€‹é‡è¡¨`);
        }

        // ç„¡è«–æäº¤æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½ç¹¼çºŒé€²è¡Œæµç¨‹
        setTimeout(() => {
          window.location.href = "mmrc_form.html";
        }, 1000);
      }

      function showLoading(show) {
        document.getElementById("loading-text").style.display = show
          ? "block"
          : "none";
      }

      function toggleContrast() {
        document.body.classList.toggle("high-contrast");
        const isHighContrast =
          document.body.classList.contains("high-contrast");
        localStorage.setItem("highContrast", isHighContrast);
      }

      function checkSavedContrast() {
        const isHighContrast = localStorage.getItem("highContrast") === "true";
        if (isHighContrast) {
          document.body.classList.add("high-contrast");
        }
      }

      // ç¢ºä¿èªéŸ³å¼•æ“å·²åŠ è¼‰
      function loadVoices() {
        return new Promise((resolve) => {
          const synth = window.speechSynthesis;
          let voices = synth.getVoices();

          if (voices.length > 0) {
            resolve(voices);
            return;
          }

          // å¦‚æœèªéŸ³å°šæœªåŠ è¼‰ï¼Œç­‰å¾…voiceschangedäº‹ä»¶
          synth.onvoiceschanged = () => {
            voices = synth.getVoices();
            resolve(voices);
          };
        });
      }

      // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        // å…ˆåŠ è¼‰èªéŸ³å¼•æ“
        await loadVoices();
        main();
      });
    </script>
  </body>
</html>
