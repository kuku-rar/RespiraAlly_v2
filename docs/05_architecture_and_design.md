# RespiraAlly V2.0 æ•´åˆæ€§æ¶æ§‹èˆ‡è¨­è¨ˆæ–‡ä»¶

---

**æ–‡ä»¶ç‰ˆæœ¬:** v2.0
**æœ€å¾Œæ›´æ–°:** 2025-10-19
**ä¸»è¦ä½œè€…:** Claude Code AI - System Architect
**ç‹€æ…‹:** å¯©æ ¸ä¸­ (Under Review)

---

## 1. æ¶æ§‹æ¦‚è¿° (Architecture Overview)

### 1.1 ç³»çµ±èƒŒæ™¯èˆ‡ç›®æ¨™
- **å•é¡ŒåŸŸ**: æœ¬ç³»çµ±æ—¨åœ¨è§£æ±ºæ…¢æ€§é˜»å¡æ€§è‚ºç—…ï¼ˆCOPDï¼‰æ‚£è€…åœ¨é•·æœŸè‡ªæˆ‘ç®¡ç†ä¸­é¢è‡¨çš„æŒ‘æˆ°ï¼ŒåŒ…æ‹¬è¨˜éŒ„ç¹ç‘£ã€ç¼ºä¹å³æ™‚å›é¥‹ã€è¡›æ•™å€‹äººåŒ–ä¸è¶³ç­‰å•é¡Œã€‚åŒæ™‚ï¼Œä¹Ÿè‡´åŠ›æ–¼æ”¹å–„å‘¼å¸æ²»ç™‚å¸«çš„å·¥ä½œæµç¨‹ï¼Œè§£æ±ºå…¶è³‡æ–™åˆ†æ•£ã€é¢¨éšªè¿½è¹¤è€—æ™‚çš„ç—›é»ã€‚
- **é—œéµé©…å‹•åŠ›**:
  - **æ¥­å‹™é©…å‹•åŠ›**: æå‡ COPD ç—…æ‚£çš„å¥åº·è¡Œç‚ºä¾å¾ç‡è‡³ 75% ä»¥ä¸Šï¼Œé™ä½é†«ç™‚æ©Ÿæ§‹çš„æ…¢ç—…ç®¡ç†æˆæœ¬èˆ‡æ€¥è¨ºç‡ã€‚
  - **æŠ€è¡“é©…å‹•åŠ›**: å¾ V1 çš„ Flask å–®é«”æ¶æ§‹é·ç§»è‡³ FastAPI å¾®æœå‹™æ¶æ§‹ï¼Œå¼•å…¥ AI èªéŸ³äº’å‹•ã€RAG çŸ¥è­˜åº«ã€äº‹ä»¶é©…å‹•ç­‰ç¾ä»£æŠ€è¡“ï¼Œè§£æ±º V1 çš„æŠ€è¡“å‚µèˆ‡æ“´å±•æ€§å•é¡Œã€‚
  - **å“è³ªé©…å‹•åŠ›**: è¿½æ±‚é«˜å¯ç”¨æ€§ (99.5%)ã€é«˜æ•ˆèƒ½ (API P95 < 500ms)ã€é«˜å®‰å…¨æ€§å’Œåˆè¦æ€§ (ç¬¦åˆå°ç£å€‹è³‡æ³•)ã€‚

### 1.2 åˆ©ç›Šç›¸é—œè€…èˆ‡é—œæ³¨é»
| è§’è‰² | é—œæ³¨é» | å„ªå…ˆç´š |
|---|---|---|
| COPD ç—…æ‚£ | åŠŸèƒ½æ˜“ç”¨æ€§ã€äº’å‹•å³æ™‚æ€§ã€éš±ç§å®‰å…¨ | é«˜ |
| å‘¼å¸æ²»ç™‚å¸« | å·¥ä½œæ•ˆç‡ã€é¢¨éšªé è­¦æº–ç¢ºæ€§ã€å€‹æ¡ˆè³‡æ–™å®Œæ•´æ€§ | é«˜ |
| ç”¢å“ç¶“ç† | åŠŸèƒ½å®Œæ•´æ€§ã€åŒ—æ¥µæ˜ŸæŒ‡æ¨™é”æˆç‡ã€ä¸Šç·šæ™‚ç¨‹ | é«˜ |
| é–‹ç™¼åœ˜éšŠ | å¯ç¶­è­·æ€§ã€æŠ€è¡“æ£§ç¾ä»£åŒ–ã€CI/CD æ•ˆç‡ | é«˜ |
| é‹ç¶­åœ˜éšŠ | å¯éƒ¨ç½²æ€§ã€å¯ç›£æ§æ€§ã€ç³»çµ±ç©©å®šæ€§ | ä¸­ |
| æ³•å‹™åˆè¦ | å€‹è³‡æ³•åˆè¦ã€é†«ç™‚è³‡è¨Šå®‰å…¨ | é«˜ |

### 1.3 å“è³ªå±¬æ€§æ¬Šè¡¡ (Quality Attributes)

| å“è³ªå±¬æ€§ | ç›®æ¨™ | åº¦é‡æ–¹å¼ | å„ªå…ˆç´š | æ¬Šè¡¡è€ƒé‡ |
|---|---|---|---|---|
| **å¯ç”¨æ€§ (Availability)** | â‰¥99.5% uptime | Prometheus ç›£æ§ | P0 | vs æˆæœ¬ (åˆæœŸæ¥å—éƒ¨åˆ†å–®é») |
| **æ€§èƒ½ (Performance)** | API P95 < 500ms | Prometheus ç›£æ§ | P0 | vs é–‹ç™¼é€Ÿåº¦ (é—œéµè·¯å¾‘å„ªå…ˆå„ªåŒ–) |
| **å®‰å…¨æ€§ (Security)** | é›¶è³‡æ–™æ´©éœ² | æ»²é€æ¸¬è©¦ã€æ—¥èªŒç¨½æ ¸ | P0 | vs æ˜“ç”¨æ€§ (å…¼é¡§ä¾¿åˆ©èˆ‡å®‰å…¨) |
| **å¯ç¶­è­·æ€§ (Maintainability)** | æ–°åŠŸèƒ½äº¤ä»˜ < 2é€± | Lead Time | P1 | vs æ€§èƒ½ (æ¡ç”¨ Clean Arch) |
| **æ“´å±•æ€§ (Scalability)** | æ”¯æ´ 500 CCU | è² è¼‰æ¸¬è©¦ (Locust) | P1 | vs è¤‡é›œåº¦ (MVP å¾Œå†å¼•å…¥ K8s) |

**é—œéµæ¬Šè¡¡æ±ºç­–**:
- **æ€§èƒ½ vs å¯ç¶­è­·æ€§**: é¸æ“‡ Clean Architecture + å¾®æœå‹™ï¼ŒçŠ§ç‰²å°‘é‡åˆå§‹é–‹ç™¼é€Ÿåº¦èˆ‡æ€§èƒ½ï¼Œæ›å–é•·æœŸå¯ç¶­è­·æ€§èˆ‡åœ˜éšŠä¸¦è¡Œé–‹ç™¼èƒ½åŠ›ã€‚
- **ä¸€è‡´æ€§ vs å¯ç”¨æ€§**: æ ¸å¿ƒäº¤æ˜“ï¼ˆå¦‚å•å·æäº¤ï¼‰æ¡å¼·ä¸€è‡´æ€§ï¼Œéæ ¸å¿ƒè³‡æ–™ï¼ˆå¦‚äº‹ä»¶æ—¥èªŒï¼‰æ¡æœ€çµ‚ä¸€è‡´æ€§ã€‚
- **æˆæœ¬ vs å¯ç”¨æ€§**: MVP éšæ®µéƒ¨ç½²æ–¼ Zeaburï¼Œæ¥å—éƒ¨åˆ†å…ƒä»¶å–®é»æ•…éšœé¢¨éšª (å¦‚ RabbitMQ)ï¼Œä¸Šç·šå¾Œå†é·ç§»è‡³é«˜å¯ç”¨çš„ K8s å¢é›†ã€‚


### 1.4 æ¶æ§‹æ¨¡å¼é¸æ“‡ (Architecture Pattern Selection)

#### 1.4.1 é¸å®šæ¨¡å¼: Modular Monolith + Event-Driven Architecture

**æ ¸å¿ƒæ±ºç­–**: MVP éšæ®µæ¡ç”¨ **Modular Monolith (æ¨¡çµ„åŒ–å–®é«”)** æ¶æ§‹ï¼Œä¸¦å¼•å…¥ **äº‹ä»¶é©…å‹• (Event-Driven)** é€šä¿¡æ©Ÿåˆ¶å¯¦ç¾æ¨¡çµ„é–“è§£è€¦ã€‚

#### 1.4.2 é¸æ“‡ç†ç”± (Rationale)

| è€ƒé‡ç¶­åº¦ | Modular Monolith | å¾®æœå‹™æ¶æ§‹ | æ±ºç­– |
|---------|------------------|-----------|------|
| **é–‹ç™¼è¤‡é›œåº¦** | ä½ï¼ˆå–®ä¸€ä»£ç¢¼åº«ï¼Œçµ±ä¸€éƒ¨ç½²ï¼‰ | é«˜ï¼ˆå¤šæœå‹™å”èª¿ï¼Œåˆ†æ•£å¼é™¤éŒ¯å›°é›£ï¼‰ | âœ… Modular Monolith |
| **åœ˜éšŠè¦æ¨¡** | 3-5 äººå°åœ˜éšŠï¼Œé©åˆå–®é«” | éœ€å¤šå€‹ç¨ç«‹åœ˜éšŠ | âœ… Modular Monolith |
| **éƒ¨ç½²è¤‡é›œåº¦** | ç°¡å–®ï¼ˆå–®ä¸€å®¹å™¨ï¼‰ | è¤‡é›œï¼ˆéœ€ K8s ç­‰ç·¨æ’å·¥å…·ï¼‰ | âœ… Modular Monolith |
| **æ€§èƒ½** | å„ªç§€ï¼ˆæœ¬åœ°å‡½æ•¸èª¿ç”¨ï¼‰ | éœ€ç¶²çµ¡é–‹éŠ· | âœ… Modular Monolith |
| **å¯ç¶­è­·æ€§** | éœ€åš´æ ¼æ¨¡çµ„é‚Šç•Œ | å¤©ç„¶éš”é›¢ | âš–ï¸ é€šé Clean Arch ä¿è­‰ |
| **æ“´å±•æ€§** | æ•´é«”æ“´å±•ï¼Œè³‡æºåˆ©ç”¨ç‡è¼ƒä½ | æœå‹™ç´šæ“´å±• | âš ï¸ MVP å¯æ¥å— |

#### 1.4.3 ç‚ºä½•å¼•å…¥äº‹ä»¶é©…å‹•ï¼Ÿ

é›–ç„¶æ¡ç”¨å–®é«”æ¶æ§‹ï¼Œä½†ä»å¼•å…¥äº‹ä»¶é©…å‹•æ©Ÿåˆ¶çš„åŸå› ï¼š

1. **æ¨¡çµ„è§£è€¦**: é¿å…æ¨¡çµ„é–“ç›´æ¥ä¾è³´ï¼Œé™ä½è€¦åˆåº¦
   ```python
   # âŒ ä¸å¥½çš„è¨­è¨ˆï¼ˆç›´æ¥ä¾è³´ï¼‰
   from risk_module import RiskService
   risk_service.calculate_risk(patient_id)  # daily_log ç›´æ¥ä¾è³´ risk

   # âœ… å¥½çš„è¨­è¨ˆï¼ˆäº‹ä»¶é©…å‹•ï¼‰
   event_bus.publish(DailyLogSubmitted(patient_id, data))  # ç™¼å¸ƒäº‹ä»¶ï¼Œç„¡éœ€çŸ¥é“èª°æ¶ˆè²»
   ```

2. **æœªä¾†å¯æ‹†åˆ†**: ä¿ç•™æœªä¾†æ‹†åˆ†ç‚ºå¾®æœå‹™çš„å¯èƒ½æ€§
   - äº‹ä»¶é©…å‹•çš„æ¨¡çµ„é‚Šç•Œæ¸…æ™°ï¼Œæ‹†åˆ†æ™‚åªéœ€å°‡ Event Bus å¾ in-memory æ”¹ç‚º RabbitMQ
   - ç„¡éœ€å¤§è¦æ¨¡é‡æ§‹æ¥­å‹™é‚è¼¯

3. **ç•°æ­¥è™•ç†**: éé—œéµè·¯å¾‘çš„ä»»å‹™ï¼ˆå¦‚ AI åˆ†æã€é€šçŸ¥ï¼‰å¯ç•°æ­¥åŸ·è¡Œï¼Œæå‡éŸ¿æ‡‰é€Ÿåº¦

4. **å¯å¯©è¨ˆæ€§**: Event Store è¨˜éŒ„æ‰€æœ‰é ˜åŸŸäº‹ä»¶ï¼Œä¾¿æ–¼è¿½è¹¤èˆ‡å¯©è¨ˆ

#### 1.4.4 æ¼”é€²è·¯ç·š (Evolution Path)

```mermaid
graph LR
    A[V2.0 MVP<br/>Modular Monolith<br/>+ In-Memory Event Bus]
    B[V2.5 æ“´å±•æœŸ<br/>Modular Monolith<br/>+ RabbitMQ]
    C[V3.0 æˆç†ŸæœŸ<br/>Selective Microservices<br/>+ Message Queue]

    A -->|æµé‡å¢é•·<br/>äº‹ä»¶å¯é æ€§éœ€æ±‚| B
    B -->|æ˜ç¢ºæœå‹™é‚Šç•Œ<br/>åœ˜éšŠæ“´å¼µ| C

    style A fill:#90EE90
    style B fill:#FFD700
    style C fill:#87CEEB
```

**æ¼”é€²è§¸ç™¼æ¢ä»¶**:
- **V2.0 â†’ V2.5**: ç•¶å–®æ©Ÿç„¡æ³•æ”¯æ’æµé‡ï¼Œæˆ–éœ€ä¿è­‰äº‹ä»¶ä¸ä¸Ÿå¤±æ™‚
- **V2.5 â†’ V3.0**: ç•¶åœ˜éšŠæ“´å¼µè‡³ 10+ äººï¼Œæˆ–æŸæ¨¡çµ„éœ€è¦ç¨ç«‹æ“´å±•æ™‚

#### 1.4.5 ç›¸é—œ ADR

è©³ç´°æ±ºç­–éç¨‹åƒè¦‹ï¼š
- [Modular Monolith è¨­è¨ˆ (è©³è¦‹ Section 4.1)](#41-modular-monolith-æ¨¡çµ„é‚Šç•ŒåŠƒåˆ†)
- [ADR-005: ä½¿ç”¨ RabbitMQ ä½œç‚ºæ¶ˆæ¯ä¸­é–“ä»¶](./adr/ADR-005-rabbitmq-for-message-queue.md)

---

---

## 2. C4 æ¨¡å‹ - å¤šå±¤æ¬¡è¦–åœ–

### 2.1 Level 1: ç³»çµ±ä¸Šä¸‹æ–‡åœ– (System Context)

```mermaid
C4Context
    title RespiraAlly ç³»çµ±ä¸Šä¸‹æ–‡åœ–

    Person(patient, "ç—…æ‚£", "COPD æ‚£è€…ï¼Œé€é LINE äº’å‹•")
    Person(therapist, "æ²»ç™‚å¸«", "å‘¼å¸æ²»ç™‚å¸«ï¼Œä½¿ç”¨ Web ç®¡ç†")
    
    System_Boundary(respira, "RespiraAlly ç³»çµ±") {
        System(line, "LINE Bot/LIFF", "æ‚£è€…äº’å‹•å…¥å£")
        System(dashboard, "Web Dashboard", "é†«è­·ç®¡ç†å¾Œè‡º")
        System(api, "æ ¸å¿ƒæœå‹™ API", "FastAPI, è™•ç†æ¥­å‹™é‚è¼¯")
        System(ai, "AI Worker", "èªéŸ³/RAG è™•ç†")
    }
    
    System_Ext(line_platform, "LINE Platform", "æä¾›è¨Šæ¯ã€ç™»å…¥ã€LIFF æœå‹™")
    System_Ext(llm_provider, "LLM Provider", "æä¾›å¤§å‹èªè¨€æ¨¡å‹æ¨ç†èƒ½åŠ›")
    
    Rel(patient, line, "ä½¿ç”¨", "HTTPS")
    Rel(therapist, dashboard, "ç®¡ç†", "HTTPS")
    Rel(line, api, "ç™¼é€è«‹æ±‚")
    Rel(dashboard, api, "ç™¼é€è«‹æ±‚")
    Rel(api, ai, "åˆ†æ´¾ä»»å‹™")
    
    Rel_Back(line, line_platform, "æ¥æ”¶ Webhook")
    Rel(ai, llm_provider, "èª¿ç”¨ API")
```
**å¤–éƒ¨ç³»çµ±ä¾è³´åˆ†æ**:
- **LINE Platform**: é«˜ä¾è³´ï¼Œæ˜¯ç—…æ‚£å”¯ä¸€å…¥å£ã€‚éœ€è¨­è¨ˆé™ç´šè¨Šæ¯èˆ‡ç›£æ§å…¶æœå‹™ç‹€æ…‹ã€‚
- **LLM Provider**: ä¸­ä¾è³´ï¼ŒAI äº’å‹•æ ¸å¿ƒã€‚å¯é™ç´šç‚ºç½é ­å›è¦†æˆ–æç¤ºæœå‹™ä¸å¯ç”¨ï¼Œä¸¦è¨­è¨ˆå¯æŠ½æ›ä¸åŒ LLM Provider çš„é©é…å±¤ã€‚

### 2.2 Level 2: å®¹å™¨åœ– (Container Diagram)

**ğŸ¯ MVP ç­–ç•¥è®Šæ›´èªªæ˜**: åŸºæ–¼ [æ¶æ§‹å¯©è¦–å ±å‘Š](./05_architecture_and_design.md) çš„å»ºè­°ï¼Œ**MVP éšæ®µæ¡ç”¨ Modular Monolith** è€Œéå¾®æœå‹™æ¶æ§‹ï¼Œä»¥é™ä½è¤‡é›œåº¦ã€åŠ é€Ÿäº¤ä»˜ä¸¦ä¾¿æ–¼é™¤éŒ¯ã€‚æœªä¾†å¯æ ¹æ“šå¯¦éš›æ¥­å‹™éœ€æ±‚é€æ­¥æ‹†åˆ†ç‚ºå¾®æœå‹™ã€‚

```mermaid
C4Container
    title RespiraAlly å®¹å™¨åœ– (Modular Monolith - MVP)

    Person(patient, "ç—…æ‚£", "COPD æ‚£è€…")
    Person(therapist, "æ²»ç™‚å¸«", "å‘¼å¸æ²»ç™‚å¸«")

    System_Boundary(line_liff, "LINE Client") {
        Container(line_app, "LINE App", "iOS/Android App")
    }

    System_Boundary(browser, "Browser") {
        Container(dashboard_spa, "Dashboard SPA", "React, Next.js", "æ²»ç™‚å¸«ç®¡ç†ä»‹é¢")
    }

    System_Boundary(respira_backend, "RespiraAlly Backend (on Zeabur)") {
        Container(main_app, "ä¸»æ‡‰ç”¨æœå‹™", "FastAPI (Modular Monolith)", "åŒ…å«æ‰€æœ‰æ¥­å‹™æ¨¡çµ„:<br/>- auth (èªè­‰æˆæ¬Š)<br/>- patients (å€‹æ¡ˆç®¡ç†)<br/>- daily_logs (æ—¥èªŒæœå‹™)<br/>- risk_engine (é¢¨éšªå¼•æ“)<br/>- rag (çŸ¥è­˜æª¢ç´¢)<br/>- notifications (é€šçŸ¥æ’ç¨‹)")

        Container(ai_worker, "AI Worker", "Python (å¯é¸)", "STT, LLM, TTS ä»»å‹™è™•ç†<br/>(Phase 2 å¼•å…¥)")

        ContainerDb(postgres_db, "PostgreSQL 15+", "å« pgvector æ“´å±•", "- çµæ§‹åŒ–è³‡æ–™<br/>- å‘é‡è³‡æ–™<br/>- äº‹ä»¶æ—¥èªŒ (JSONB)")
        ContainerDb(redis, "Redis 7+", "Cache & Session", "- æœƒè©±å­˜å„²<br/>- å¿«å–å±¤<br/>- åˆ†æ•£å¼é–")
        ContainerDb(minio, "MinIO", "Object Storage", "éŸ³æª”å­˜å„²<br/>(Phase 2 å¼•å…¥)")
        Container(rabbitmq, "RabbitMQ", "Message Queue (å¯é¸)", "AI ç•°æ­¥ä»»å‹™<br/>(Phase 2 å¼•å…¥)")
    }

    System_Ext(line_platform, "LINE Platform", "OAuth, Messaging API")
    System_Ext(openai_api, "OpenAI API", "GPT-4, Whisper, TTS")

    Rel(patient, line_app, "ä½¿ç”¨")
    Rel(therapist, dashboard_spa, "ä½¿ç”¨")

    Rel(line_app, main_app, "API å‘¼å«", "HTTPS/REST")
    Rel(dashboard_spa, main_app, "API å‘¼å«", "HTTPS/REST")

    Rel(main_app, postgres_db, "è®€å¯«", "SQLAlchemy ORM")
    Rel(main_app, redis, "è®€å¯«", "Redis Client")

    Rel(main_app, rabbitmq, "ç™¼å¸ƒä»»å‹™", "Pika")
    Rel(rabbitmq, ai_worker, "æ¶ˆè²»ä»»å‹™")
    Rel(ai_worker, postgres_db, "è®€å¯«")
    Rel(ai_worker, minio, "è®€å¯«éŸ³æª”")
    Rel(ai_worker, openai_api, "èª¿ç”¨ API")

    Rel(main_app, line_platform, "OAuth & Push", "HTTPS")
    Rel(main_app, openai_api, "Embedding API", "HTTPS")
```

**å®¹å™¨è·è²¬èˆ‡æŠ€è¡“é¸å‹ç†ç”±**:

| å®¹å™¨ | æŠ€è¡“é¸å‹ | æ ¸å¿ƒè·è²¬ | é¸å‹ç†ç”± |
|------|----------|----------|----------|
| **ä¸»æ‡‰ç”¨æœå‹™ (Modular Monolith)** | FastAPI | - çµ±ä¸€ API å…¥å£<br/>- èªè­‰æˆæ¬Š (JWT, LINE OAuth)<br/>- æ‰€æœ‰æ¥­å‹™é‚è¼¯ (æ‚£è€…ã€æ—¥èªŒã€é¢¨éšªã€RAGã€é€šçŸ¥) | - **ç°¡åŒ–æ¶æ§‹**: å–®ä¸€ Processï¼Œé¿å…åˆ†æ•£å¼äº‹å‹™<br/>- **åŠ é€Ÿé–‹ç™¼**: ç›´æ¥å‡½æ•¸èª¿ç”¨ï¼Œç„¡éœ€ RPC<br/>- **æ˜“æ–¼é™¤éŒ¯**: çµ±ä¸€æ—¥èªŒã€å–®ä¸€éƒ¨ç½²å–®å…ƒ<br/>- **ä¿ç•™æ¼”é€²æ€§**: æ¨¡çµ„é‚Šç•Œæ¸…æ™°ï¼Œæœªä¾†å¯æ‹†åˆ† |
| **AI Worker** | Python | - èªéŸ³è½‰æ–‡å­— (STT)<br/>- LLM æ¨ç†<br/>- æ–‡å­—è½‰èªéŸ³ (TTS) | - **Phase 2 å¼•å…¥**: Phase 0/1 æš«ä¸å¯¦ä½œ<br/>- **ç•°æ­¥è™•ç†**: é¿å…é˜»å¡ä¸»æœå‹™<br/>- **å¯é¸ RabbitMQ**: åˆæœŸå¯ç”¨ Celery + Redis æ›¿ä»£ |
| **PostgreSQL** | PostgreSQL 15 + pgvector | - æ‰€æœ‰çµæ§‹åŒ–è³‡æ–™<br/>- å‘é‡è³‡æ–™ (è¡›æ•™çŸ¥è­˜åº«)<br/>- äº‹ä»¶æ—¥èªŒ (JSONB æ¬„ä½) | - **å–®ä¸€æ•¸æ“šæº**: ç§»é™¤ MongoDBï¼Œç°¡åŒ–æŠ€è¡“æ£§<br/>- **JSONB å¼·å¤§**: æ”¯æ´éˆæ´» Schemaï¼Œå¯æ›¿ä»£ MongoDB<br/>- **pgvector è¶³å¤ **: MVP éšæ®µå‘é‡é‡ < 10è¬ï¼Œæ€§èƒ½è¶³å¤  |
| **Redis** | Redis 7 | - æœƒè©±å­˜å„² (JWT Refresh Token)<br/>- ç†±é»æ•¸æ“šå¿«å–<br/>- åˆ†æ•£å¼é– (ç™»å…¥å¤±æ•—è¨ˆæ•¸) | - **é«˜æ€§èƒ½**: æ¯«ç§’ç´šè®€å¯«<br/>- **è±å¯Œæ•¸æ“šçµæ§‹**: String, Hash, Set, ZSet<br/>- **æŒä¹…åŒ–æ”¯æ´**: AOF + RDB |
| **RabbitMQ** | RabbitMQ 3 | - AI èªéŸ³ä»»å‹™ä½‡åˆ— | - **å¯é¸å…ƒä»¶**: Phase 0/1 ä¸å¼•å…¥<br/>- **å‚™é¸æ–¹æ¡ˆ**: Celery + Redis æˆ–åŒæ­¥ API |

**ğŸ”„ æ¼”é€²è·¯å¾‘**:
```
Phase 0/1 (Week 1-8):
  â””â”€â”€ Modular Monolith (FastAPI) + PostgreSQL + Redis

Phase 2 (Week 9-12):
  â””â”€â”€ æ–°å¢ AI Worker + (å¯é¸) RabbitMQ

Phase 3+ (æœªä¾†):
  â””â”€â”€ æ ¹æ“šç“¶é ¸é€æ­¥æ‹†åˆ†å¾®æœå‹™
      â”œâ”€â”€ å€™é¸ 1: AI Worker â†’ ç¨ç«‹å¾®æœå‹™
      â”œâ”€â”€ å€™é¸ 2: RAG Service â†’ ç¨ç«‹å¾®æœå‹™ (è‹¥æŸ¥è©¢é‡ > 1000 QPS)
      â””â”€â”€ å€™é¸ 3: Notification Service â†’ ç¨ç«‹å¾®æœå‹™ (è‹¥æ¨æ’­é‡éå¤§)
```

### 2.3 Level 3: çµ„ä»¶åœ– (Component Diagram) - ä»¥æ—¥èªŒæœå‹™ç‚ºä¾‹

```mermaid
C4Component
    title æ—¥èªŒæœå‹™ (Log Service) - çµ„ä»¶åœ–

    Container_Boundary(log_svc, "æ—¥èªŒæœå‹™") {
        Component(api, "API å±¤", "FastAPI Routers", "æ¥æ”¶æ—¥èªŒ/å•å· HTTP è«‹æ±‚")
        Component(app, "æ‡‰ç”¨å±¤", "Use Cases", "ç·¨æ’æ—¥èªŒæäº¤ã€æŸ¥è©¢ç”¨ä¾‹")
        Component(domain, "é ˜åŸŸå±¤", "Entities, Aggregates", "æ—¥èªŒã€ä¾å¾ç‡ç­‰æ¥­å‹™é‚è¼¯")
        Component(infra, "åŸºç¤è¨­æ–½å±¤", "Repositories, Adapters", "æ•¸æ“šæŒä¹…åŒ–, äº‹ä»¶ç™¼å¸ƒ")
    }

    ContainerDb(db, "PostgreSQL", "æ—¥èªŒã€å•å·è³‡æ–™")
    Container(mq, "RabbitMQ", "è¨Šæ¯ä½‡åˆ—")
    System_Ext(risk_engine, "é¢¨éšªå¼•æ“")

    Rel(api, app, "èª¿ç”¨", "æ–¹æ³•èª¿ç”¨")
    Rel(app, domain, "ä½¿ç”¨", "æ–¹æ³•èª¿ç”¨")
    Rel(domain, infra, "ä¾è³´åè½‰", "æ¥å£")
    Rel(infra, db, "è®€å¯«", "SQLAlchemy")
    Rel(app, mq, "ç™¼å¸ƒ `daily_log.submitted` äº‹ä»¶", "AMQP")
    Rel(mq, risk_engine, "è¨‚é–±äº‹ä»¶")
```

---

## 3. DDD æˆ°ç•¥è¨­è¨ˆ (Strategic Design)

æœ¬ç« ç¯€åŸºæ–¼ Domain-Driven Design (DDD) æˆ°ç•¥è¨­è¨ˆåŸå‰‡ï¼Œå®šç¾© RespiraAlly V2.0 çš„é ˜åŸŸé‚Šç•Œã€çµ±ä¸€èªè¨€èˆ‡èšåˆæ¨¡å‹ï¼Œç¢ºä¿æ¥­å‹™é‚è¼¯èˆ‡æŠ€è¡“å¯¦ç¾çš„é«˜å…§èšã€ä½è€¦åˆã€‚

---

### 3.1 ç•Œé™ä¸Šä¸‹æ–‡æ˜ å°„ (Bounded Context Mapping)

ç•Œé™ä¸Šä¸‹æ–‡ (Bounded Context) æ˜¯ DDD ä¸­å®šç¾©é ˜åŸŸé‚Šç•Œçš„æ ¸å¿ƒæ¦‚å¿µã€‚æ¯å€‹ä¸Šä¸‹æ–‡å…§ç¶­è­·è‡ªå·±çš„æ¨¡å‹èˆ‡è¡“èªï¼Œä¸Šä¸‹æ–‡é–“é€éæ˜ç¢ºçš„é—œä¿‚é€²è¡Œå”ä½œã€‚

#### 3.1.1 ä¸Šä¸‹æ–‡å…¨æ™¯åœ– (Context Map)

```mermaid
graph TD
  subgraph "æ ¸å¿ƒåŸŸ (Core Domain)"
    LogContext[æ—¥èªŒä¸Šä¸‹æ–‡<br/>Daily Log Context<br/>ğŸ“Œ æ ¸å¿ƒæ¥­å‹™]
    RiskContext[é¢¨éšªä¸Šä¸‹æ–‡<br/>Risk Context<br/>ğŸ“Œ æ ¸å¿ƒæ¥­å‹™]
  end

  subgraph "æ”¯æ’å­åŸŸ (Supporting Subdomain)"
    PatientContext[å€‹æ¡ˆä¸Šä¸‹æ–‡<br/>Patient Context<br/>ğŸ”§ æ”¯æ’åŠŸèƒ½]
    SurveyContext[å•å·ä¸Šä¸‹æ–‡<br/>Survey Context<br/>ğŸ”§ æ”¯æ’åŠŸèƒ½]
    RagContext[è¡›æ•™ä¸Šä¸‹æ–‡<br/>RAG Context<br/>ğŸ”§ æ”¯æ’åŠŸèƒ½]
  end

  subgraph "é€šç”¨å­åŸŸ (Generic Subdomain)"
    AuthContext[èªè­‰ä¸Šä¸‹æ–‡<br/>Auth Context<br/>âš™ï¸ é€šç”¨åŠŸèƒ½]
    NotificationContext[é€šçŸ¥ä¸Šä¸‹æ–‡<br/>Notification Context<br/>âš™ï¸ é€šç”¨åŠŸèƒ½]
  end

  %% æ ¸å¿ƒåŸŸé–“é—œä¿‚
  RiskContext -->|Customer-Supplier<br/>ä¾è³´æ—¥èªŒæ•¸æ“š| LogContext
  RiskContext -->|Customer-Supplier<br/>ä¾è³´å€‹æ¡ˆæª”æ¡ˆ| PatientContext

  %% æ”¯æ’å­åŸŸé—œä¿‚
  LogContext -->|Customer-Supplier<br/>é©—è­‰æ‚£è€…å­˜åœ¨| PatientContext
  SurveyContext -->|Customer-Supplier<br/>é©—è­‰æ‚£è€…å­˜åœ¨| PatientContext

  %% æ ¸å¿ƒåŸŸèˆ‡æ”¯æ’å­åŸŸé—œä¿‚
  RiskContext -->|Partner<br/>å…±åŒè¨ˆç®—é¢¨éšª| SurveyContext

  %% èˆ‡é€šç”¨å­åŸŸé—œä¿‚
  LogContext -->|Published Language<br/>ç™¼å¸ƒ LogSubmitted äº‹ä»¶| NotificationContext
  RiskContext -->|Published Language<br/>ç™¼å¸ƒ AlertTriggered äº‹ä»¶| NotificationContext
  RagContext -->|Open Host Service<br/>æä¾›çŸ¥è­˜æª¢ç´¢ API| NotificationContext

  %% èªè­‰ä¸Šä¸‹æ–‡èˆ‡æ‰€æœ‰ä¸Šä¸‹æ–‡çš„é—œä¿‚
  AuthContext -.->|ACL<br/>æä¾›èº«ä»½é©—è­‰| LogContext
  AuthContext -.->|ACL<br/>æä¾›èº«ä»½é©—è­‰| PatientContext
  AuthContext -.->|ACL<br/>æä¾›èº«ä»½é©—è­‰| SurveyContext
  AuthContext -.->|ACL<br/>æä¾›èº«ä»½é©—è­‰| RiskContext

  style LogContext fill:#ff9999,stroke:#cc0000,stroke-width:3px
  style RiskContext fill:#ff9999,stroke:#cc0000,stroke-width:3px
  style PatientContext fill:#99ccff,stroke:#0066cc,stroke-width:2px
  style SurveyContext fill:#99ccff,stroke:#0066cc,stroke-width:2px
  style RagContext fill:#99ccff,stroke:#0066cc,stroke-width:2px
  style AuthContext fill:#99ff99,stroke:#009900,stroke-width:2px
  style NotificationContext fill:#99ff99,stroke:#009900,stroke-width:2px
```

#### 3.1.2 ä¸Šä¸‹æ–‡è©³ç´°å®šç¾©

##### ğŸ”´ æ ¸å¿ƒåŸŸ (Core Domain) - ç«¶çˆ­å„ªå‹¢æ‰€åœ¨

**1. æ—¥èªŒä¸Šä¸‹æ–‡ (Daily Log Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç®¡ç†æ‚£è€…æ¯æ—¥å¥åº·è¨˜éŒ„ï¼Œè¨ˆç®—å¥åº·è¡Œç‚ºä¾å¾ç‡ |
| **æ ¸å¿ƒå¯¦é«”** | DailyLog (èšåˆæ ¹), MedicationRecord, WaterIntake, SymptomRecord |
| **é—œéµæ¥­å‹™è¦å‰‡** | - æ¯ä½æ‚£è€…æ¯æ—¥åƒ…ä¸€ç­†è¨˜éŒ„<br/>- ä¾å¾ç‡ = (7æ—¥å…§ç”¨è—¥å¤©æ•¸ / 7) Ã— 100%<br/>- æäº¤å¾Œè§¸ç™¼é¢¨éšªé‡æ–°è¨ˆç®— |
| **å°å¤– API** | - `POST /daily-logs` - æäº¤æ—¥èªŒ<br/>- `GET /daily-logs/{patientId}` - æŸ¥è©¢æ­·å²<br/>- `GET /daily-logs/{patientId}/trends` - ç²å–è¶¨å‹¢åœ–æ•¸æ“š |
| **ç™¼å¸ƒäº‹ä»¶** | - `DailyLogSubmitted` - æ—¥èªŒæäº¤æˆåŠŸ<br/>- `DailyLogUpdated` - æ—¥èªŒæ›´æ–° |
| **è¨‚é–±äº‹ä»¶** | ç„¡ (ä½œç‚ºæ•¸æ“šæºé ­) |
| **ä¾è³´ä¸Šä¸‹æ–‡** | Patient Context (é©—è­‰ patient_id å­˜åœ¨) |

**2. é¢¨éšªä¸Šä¸‹æ–‡ (Risk Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | è©•ä¼°æ‚£è€…å¥åº·é¢¨éšªï¼Œè§¸ç™¼ç•°å¸¸é è­¦ï¼Œç®¡ç†é è­¦ç”Ÿå‘½é€±æœŸ |
| **æ ¸å¿ƒå¯¦é«”** | RiskScore (èšåˆæ ¹), Alert (èšåˆæ ¹), RiskEngine (é ˜åŸŸæœå‹™) |
| **é—œéµæ¥­å‹™è¦å‰‡** | - é¢¨éšªåˆ†æ•¸è¨ˆç®—å…¬å¼: `Score = f(ä¾å¾ç‡, CATåˆ†æ•¸, ç—‡ç‹€é »ç‡, å¹´é½¡, å¸è¸å²)`<br/>- é¢¨éšªç­‰ç´š: LOW (0-40), MEDIUM (41-70), HIGH (71-100)<br/>- Alert è§¸ç™¼æ¢ä»¶: é¢¨éšªç­‰ç´š >= MEDIUM ä¸”è¼ƒä¸Šæ¬¡æå‡ |
| **å°å¤– API** | - `POST /risk-scores/calculate/{patientId}` - è¨ˆç®—é¢¨éšª<br/>- `GET /alerts?therapistId=xxx&status=OPEN` - æŸ¥è©¢é è­¦åˆ—è¡¨<br/>- `PATCH /alerts/{alertId}/acknowledge` - ç¢ºèªé è­¦ |
| **ç™¼å¸ƒäº‹ä»¶** | - `RiskScoreCalculated` - é¢¨éšªè©•åˆ†å®Œæˆ<br/>- `AlertTriggered` - è§¸ç™¼æ–°é è­¦<br/>- `AlertResolved` - é è­¦è§£æ±º |
| **è¨‚é–±äº‹ä»¶** | - `DailyLogSubmitted` (ä¾†è‡ª Log Context)<br/>- `SurveyCompleted` (ä¾†è‡ª Survey Context) |
| **ä¾è³´ä¸Šä¸‹æ–‡** | - Daily Log Context (è®€å–è¿‘æœŸæ—¥èªŒ)<br/>- Patient Context (è®€å–æ‚£è€…æª”æ¡ˆ)<br/>- Survey Context (è®€å–æœ€æ–°å•å·åˆ†æ•¸) |

##### ğŸ”µ æ”¯æ’å­åŸŸ (Supporting Subdomain) - æ”¯æ’æ ¸å¿ƒæ¥­å‹™

**3. å€‹æ¡ˆä¸Šä¸‹æ–‡ (Patient Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç®¡ç†æ‚£è€…æª”æ¡ˆã€æ²»ç™‚å¸«åˆ†é…ã€å€‹æ¡ˆåŸºæœ¬è³‡æ–™ CRUD |
| **æ ¸å¿ƒå¯¦é«”** | Patient (èšåˆæ ¹), PatientProfile, TherapistAssignment |
| **é—œéµæ¥­å‹™è¦å‰‡** | - æ‚£è€…å¿…é ˆåˆ†é…çµ¦ä¸€ä½æ²»ç™‚å¸«<br/>- BMI è‡ªå‹•è¨ˆç®—: `weight_kg / (height_cm / 100)^2`<br/>- å¹´é½¡é™åˆ¶: 18-120 æ­² |
| **å°å¤– API** | - `POST /patients` - æ–°å¢æ‚£è€…<br/>- `GET /patients/{id}` - æŸ¥è©¢æ‚£è€…æª”æ¡ˆ<br/>- `PATCH /patients/{id}/assign-therapist` - åˆ†é…æ²»ç™‚å¸« |
| **ç™¼å¸ƒäº‹ä»¶** | - `PatientRegistered` - æ‚£è€…è¨»å†ŠæˆåŠŸ<br/>- `PatientProfileUpdated` - æª”æ¡ˆæ›´æ–°<br/>- `TherapistAssigned` - æ²»ç™‚å¸«åˆ†é… |
| **è¨‚é–±äº‹ä»¶** | - `UserCreated` (ä¾†è‡ª Auth Context) |
| **ä¾è³´ä¸Šä¸‹æ–‡** | Auth Context (é©—è­‰ user_id èˆ‡ LINE User ID ç¶å®š) |

**4. å•å·ä¸Šä¸‹æ–‡ (Survey Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç®¡ç† CAT/mMRC å•å·ã€è¨ˆç®—è©•åˆ†ã€è¿½è¹¤ç—…æƒ…åš´é‡åº¦ |
| **æ ¸å¿ƒå¯¦é«”** | SurveyResponse (èšåˆæ ¹), CATScorer, mMRCScorer (é ˜åŸŸæœå‹™) |
| **é—œéµæ¥­å‹™è¦å‰‡** | - **CAT è©•åˆ†**: 0-40 åˆ†ï¼Œ<10=è¼•å¾®, 10-20=ä¸­åº¦, 21-30=åš´é‡, >30=æ¥µåš´é‡<br/>- **mMRC è©•åˆ†**: 0-4 åˆ†ï¼Œè¡¨ç¤ºå‘¼å¸å›°é›£ç¨‹åº¦<br/>- å•å·æäº¤å¾Œè§¸ç™¼é¢¨éšªé‡æ–°è¨ˆç®— |
| **å°å¤– API** | - `POST /surveys/{type}` - æäº¤å•å· (type: CAT/mMRC)<br/>- `GET /surveys/{patientId}/history` - æŸ¥è©¢æ­·å²å•å·<br/>- `GET /surveys/{patientId}/latest` - ç²å–æœ€æ–°åˆ†æ•¸ |
| **ç™¼å¸ƒäº‹ä»¶** | - `SurveyCompleted` - å•å·å®Œæˆ<br/>- `SeverityLevelChanged` - åš´é‡åº¦è®ŠåŒ– |
| **è¨‚é–±äº‹ä»¶** | ç„¡ |
| **ä¾è³´ä¸Šä¸‹æ–‡** | Patient Context (é©—è­‰ patient_id å­˜åœ¨) |

**5. è¡›æ•™ä¸Šä¸‹æ–‡ (RAG Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç®¡ç†è¡›æ•™çŸ¥è­˜åº«ã€å‘é‡æª¢ç´¢ã€AI èªéŸ³å•ç­” (STT â†’ RAG â†’ LLM â†’ TTS) |
| **æ ¸å¿ƒå¯¦é«”** | EducationalDocument (èšåˆæ ¹), DocumentChunk, EmbeddingService (é ˜åŸŸæœå‹™) |
| **é—œéµæ¥­å‹™è¦å‰‡** | - æ–‡ä»¶å¿…é ˆåˆ†å¡Š (æ¯å¡Š â‰¤ 500 å­—)<br/>- å‘é‡ç›¸ä¼¼åº¦æª¢ç´¢ Top-K=5<br/>- AI å›è¦†å¿…é ˆå¼•ç”¨ä¾†æº (Citation) |
| **å°å¤– API** | - `POST /rag/query` - æ–‡å­—å•ç­”<br/>- `POST /rag/voice-query` - èªéŸ³å•ç­” (ç•°æ­¥)<br/>- `GET /rag/documents` - æŸ¥è©¢çŸ¥è­˜åº« |
| **ç™¼å¸ƒäº‹ä»¶** | - `VoiceQueryReceived` - æ”¶åˆ°èªéŸ³æŸ¥è©¢<br/>- `VoiceResponseGenerated` - èªéŸ³å›è¦†ç”Ÿæˆå®Œæˆ |
| **è¨‚é–±äº‹ä»¶** | ç„¡ |
| **ä¾è³´ä¸Šä¸‹æ–‡** | ç„¡ (ç¨ç«‹ä¸Šä¸‹æ–‡) |

##### ğŸŸ¢ é€šç”¨å­åŸŸ (Generic Subdomain) - å¯ç”¨ç¾æˆæ–¹æ¡ˆ

**6. èªè­‰ä¸Šä¸‹æ–‡ (Auth Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç”¨æˆ¶èªè­‰ã€æˆæ¬Šã€æœƒè©±ç®¡ç†ã€ç™»å…¥é–å®šç­–ç•¥ |
| **æ ¸å¿ƒå¯¦é«”** | User (èšåˆæ ¹), Session, AccessToken (JWT), RefreshToken |
| **é—œéµæ¥­å‹™è¦å‰‡** | - **æ‚£è€…**: LINE OAuth ç™»å…¥ï¼Œç„¡å¯†ç¢¼<br/>- **æ²»ç™‚å¸«**: å¸³å¯†ç™»å…¥ï¼Œç™»å…¥å¤±æ•— 3 æ¬¡é–å®š 15 åˆ†é˜<br/>- JWT æœ‰æ•ˆæœŸ: Access Token 1 å°æ™‚, Refresh Token 7 å¤© |
| **å°å¤– API** | - `POST /auth/line/callback` - LINE ç™»å…¥å›èª¿<br/>- `POST /auth/therapist/login` - æ²»ç™‚å¸«ç™»å…¥<br/>- `POST /auth/refresh` - åˆ·æ–° Token |
| **ç™¼å¸ƒäº‹ä»¶** | - `UserCreated` - æ–°ç”¨æˆ¶è¨»å†Š<br/>- `UserLoggedIn` - ç™»å…¥æˆåŠŸ<br/>- `AccountLocked` - å¸³è™Ÿé–å®š |
| **è¨‚é–±äº‹ä»¶** | ç„¡ |
| **ä¾è³´ä¸Šä¸‹æ–‡** | ç„¡ (åŸºç¤æœå‹™) |

**7. é€šçŸ¥ä¸Šä¸‹æ–‡ (Notification Context)**

| å±¬æ€§ | å…§å®¹ |
|------|------|
| **è·è²¬** | ç®¡ç†é€šçŸ¥æ’ç¨‹ã€ç™¼é€ LINE è¨Šæ¯/Emailã€è¿½è¹¤ç™¼é€ç‹€æ…‹ |
| **æ ¸å¿ƒå¯¦é«”** | Notification (èšåˆæ ¹), NotificationSchedule, DeliveryStatus |
| **é—œéµæ¥­å‹™è¦å‰‡** | - æ™ºæ…§æé†’æ™‚æ®µ: 12:00, 17:00, 20:00<br/>- é€šçŸ¥å¤±æ•—é‡è©¦ 3 æ¬¡ (æŒ‡æ•¸é€€é¿)<br/>- LINE è¨Šæ¯æ“¬äººåŒ–å£å» (å­«å¥³èªæ°£) |
| **å°å¤– API** | - `POST /notifications/send` - ç«‹å³ç™¼é€<br/>- `POST /notifications/schedule` - æ’ç¨‹ç™¼é€<br/>- `GET /notifications/history/{userId}` - æŸ¥è©¢æ­·å² |
| **ç™¼å¸ƒäº‹ä»¶** | - `NotificationSent` - é€šçŸ¥ç™¼é€æˆåŠŸ<br/>- `NotificationFailed` - ç™¼é€å¤±æ•— |
| **è¨‚é–±äº‹ä»¶** | - `DailyLogSubmitted` (è§¸ç™¼é¼“å‹µè¨Šæ¯)<br/>- `AlertTriggered` (é€šçŸ¥æ²»ç™‚å¸«)<br/>- `SurveyCompleted` (è§¸ç™¼æ„Ÿè¬è¨Šæ¯) |
| **ä¾è³´ä¸Šä¸‹æ–‡** | RAG Context (æŸ¥è©¢è¡›æ•™å…§å®¹ç”¨æ–¼æ¨æ’­) |

---

#### 3.1.3 ä¸Šä¸‹æ–‡é–“é—œä¿‚èªªæ˜

**é—œä¿‚é¡å‹å®šç¾©**:

1. **Customer-Supplier (å®¢æˆ¶-ä¾›æ‡‰å•†)**:
   - **å®šç¾©**: ä¸‹æ¸¸ä¸Šä¸‹æ–‡ (Customer) ä¾è³´ä¸Šæ¸¸ä¸Šä¸‹æ–‡ (Supplier) æä¾›çš„æ•¸æ“šæˆ–æœå‹™
   - **ç¯„ä¾‹**: é¢¨éšªä¸Šä¸‹æ–‡ â†’ æ—¥èªŒä¸Šä¸‹æ–‡ (é¢¨éšªè¨ˆç®—éœ€è¦æ—¥èªŒæ•¸æ“š)
   - **å¯¦ä½œ**: é€é REST API æˆ–å…±äº«æ•¸æ“šåº«è¦–åœ–

2. **Open Host Service (é–‹æ”¾ä¸»æ©Ÿæœå‹™)**:
   - **å®šç¾©**: ä¸Šä¸‹æ–‡æä¾›å…¬é–‹çš„ã€æ–‡æª”å®Œå–„çš„ API ä¾›å…¶ä»–ä¸Šä¸‹æ–‡èª¿ç”¨
   - **ç¯„ä¾‹**: è¡›æ•™ä¸Šä¸‹æ–‡æä¾›çŸ¥è­˜æª¢ç´¢ API
   - **å¯¦ä½œ**: RESTful API + OpenAPI è¦ç¯„

3. **Published Language (ç™¼å¸ƒèªè¨€)**:
   - **å®šç¾©**: ä¸Šä¸‹æ–‡é€éé ˜åŸŸäº‹ä»¶é€²è¡Œç•°æ­¥é€šä¿¡ï¼Œä½¿ç”¨çµ±ä¸€çš„äº‹ä»¶ Schema
   - **ç¯„ä¾‹**: æ—¥èªŒä¸Šä¸‹æ–‡ç™¼å¸ƒ `DailyLogSubmitted` äº‹ä»¶
   - **å¯¦ä½œ**: RabbitMQ + äº‹ä»¶ç‰ˆæœ¬åŒ–

4. **Anti-Corruption Layer (é˜²è…å±¤)**:
   - **å®šç¾©**: ä¿è­·ä¸Šä¸‹æ–‡ä¸å—å¤–éƒ¨ç³»çµ±è®ŠåŒ–å½±éŸ¿çš„é©é…å±¤
   - **ç¯„ä¾‹**: èªè­‰ä¸Šä¸‹æ–‡ (ACL) éš”é›¢ LINE Platform è®ŠåŒ–
   - **å¯¦ä½œ**: Adapter Pattern

5. **Partner (åˆä½œå¤¥ä¼´)**:
   - **å®šç¾©**: å…©å€‹ä¸Šä¸‹æ–‡ç·Šå¯†å”ä½œï¼Œå…±åŒå¯¦ç¾æ¥­å‹™ç›®æ¨™
   - **ç¯„ä¾‹**: é¢¨éšªä¸Šä¸‹æ–‡ â†” å•å·ä¸Šä¸‹æ–‡ (å…±åŒè¨ˆç®—é¢¨éšª)
   - **å¯¦ä½œ**: åŒæ­¥ API èª¿ç”¨ + å…±äº«äº‹ä»¶

**é—œéµé—œä¿‚çŸ©é™£**:

| ä¸‹æ¸¸ä¸Šä¸‹æ–‡ (Customer) | ä¸Šæ¸¸ä¸Šä¸‹æ–‡ (Supplier) | é—œä¿‚é¡å‹ | å”ä½œæ–¹å¼ |
|----------------------|---------------------|----------|----------|
| é¢¨éšªä¸Šä¸‹æ–‡ | æ—¥èªŒä¸Šä¸‹æ–‡ | Customer-Supplier | REST API (è®€å–è¿‘ 30 æ—¥æ—¥èªŒ) |
| é¢¨éšªä¸Šä¸‹æ–‡ | å€‹æ¡ˆä¸Šä¸‹æ–‡ | Customer-Supplier | REST API (è®€å–æ‚£è€…æª”æ¡ˆ) |
| é¢¨éšªä¸Šä¸‹æ–‡ | å•å·ä¸Šä¸‹æ–‡ | Partner | REST API + Event (`SurveyCompleted`) |
| æ—¥èªŒä¸Šä¸‹æ–‡ | å€‹æ¡ˆä¸Šä¸‹æ–‡ | Customer-Supplier | Database FK (é©—è­‰ patient_id) |
| å•å·ä¸Šä¸‹æ–‡ | å€‹æ¡ˆä¸Šä¸‹æ–‡ | Customer-Supplier | Database FK (é©—è­‰ patient_id) |
| é€šçŸ¥ä¸Šä¸‹æ–‡ | è¡›æ•™ä¸Šä¸‹æ–‡ | Open Host Service | REST API (æŸ¥è©¢è¡›æ•™å…§å®¹) |
| é€šçŸ¥ä¸Šä¸‹æ–‡ | æ—¥èªŒä¸Šä¸‹æ–‡ | Published Language | Event (`DailyLogSubmitted`) |
| é€šçŸ¥ä¸Šä¸‹æ–‡ | é¢¨éšªä¸Šä¸‹æ–‡ | Published Language | Event (`AlertTriggered`) |
| æ‰€æœ‰ä¸Šä¸‹æ–‡ | èªè­‰ä¸Šä¸‹æ–‡ | ACL | JWT Middleware (èº«ä»½é©—è­‰) |

---

### 3.2 çµ±ä¸€èªè¨€ (Ubiquitous Language)

çµ±ä¸€èªè¨€ (Ubiquitous Language) æ˜¯ DDD çš„æ ¸å¿ƒå¯¦è¸ï¼Œç¢ºä¿é–‹ç™¼åœ˜éšŠã€é ˜åŸŸå°ˆå®¶ã€ç”¢å“ç¶“ç†ä½¿ç”¨ç›¸åŒçš„è¡“èªæè¿°æ¥­å‹™æ¦‚å¿µï¼Œé¿å…æ­§ç¾©èˆ‡èª¤è§£ã€‚

#### 3.2.1 æ ¸å¿ƒè¡“èªè¡¨

ä»¥ä¸‹è¡“èªæŒ‰ç…§æ‰€å±¬ä¸Šä¸‹æ–‡åˆ†é¡ï¼Œä¸¦æä¾›ä¸­è‹±å°ç…§ã€ç²¾ç¢ºå®šç¾©èˆ‡åä¾‹ã€‚

##### ğŸ”´ èªè­‰ä¸Šä¸‹æ–‡ (Auth Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| ç”¨æˆ¶ | User | ç³»çµ±ä¸­çš„ä½¿ç”¨è€…å¯¦é«”ï¼ŒåŒ…å«ç—…æ‚£ (Patient) èˆ‡æ²»ç™‚å¸« (Therapist) | â‰  ç—…æ‚£ (Patient æ˜¯ User çš„å­é¡å‹) | Auth Context |
| è§’è‰² | Role | ç”¨æˆ¶çš„èº«ä»½é¡å‹ï¼Œæšèˆ‰å€¼: PATIENT æˆ– THERAPIST | â‰  æ¬Šé™ (Role æ±ºå®šæ¬Šé™ï¼Œä½†ä¸ç­‰æ–¼æ¬Šé™æœ¬èº«) | Auth Context |
| è¨ªå•ä»¤ç‰Œ | Access Token | çŸ­æœŸ JWTï¼Œæœ‰æ•ˆæœŸ 1 å°æ™‚ï¼Œç”¨æ–¼ API é‘‘æ¬Š | â‰  Refresh Token (å¾Œè€…ç”¨æ–¼åˆ·æ–°å‰è€…) | Auth Context |
| åˆ·æ–°ä»¤ç‰Œ | Refresh Token | é•·æœŸ JWTï¼Œæœ‰æ•ˆæœŸ 7 å¤©ï¼Œç”¨æ–¼ç²å–æ–°çš„ Access Token | å­˜å„²åœ¨ Redisï¼Œå–®æ¬¡ä½¿ç”¨å¾Œå¤±æ•ˆ (Rotation) | Auth Context |
| å¸³è™Ÿé–å®š | Account Lockout | æ²»ç™‚å¸«ç™»å…¥å¤±æ•— 3 æ¬¡å¾Œé–å®š 15 åˆ†é˜çš„å®‰å…¨æ©Ÿåˆ¶ | åƒ…é©ç”¨æ–¼æ²»ç™‚å¸«ï¼Œæ‚£è€…ç„¡å¯†ç¢¼ç™»å…¥æ•…ä¸é©ç”¨ | Auth Context |
| LINE ç”¨æˆ¶ ID | LINE User ID | LINE Platform æä¾›çš„å”¯ä¸€ç”¨æˆ¶è­˜åˆ¥ç¢¼ï¼Œæ ¼å¼ `U{32 ä½åå…­é€²ä½}` | â‰  ç³»çµ±å…§éƒ¨ user_id (UUID) | Auth Context |

##### ğŸ”´ å€‹æ¡ˆä¸Šä¸‹æ–‡ (Patient Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| ç—…æ‚£ | Patient | COPD æ‚£è€…ï¼Œé€é LINE ä½¿ç”¨ç³»çµ±çš„ä½¿ç”¨è€… | â‰  æ²»ç™‚å¸« (Therapist) | Patient Context |
| æ²»ç™‚å¸« | Therapist | å‘¼å¸æ²»ç™‚å¸«ï¼Œé€é Web Dashboard ç®¡ç†ç—…æ‚£çš„ä½¿ç”¨è€… | â‰  é†«ç”Ÿ (æœ¬ç³»çµ±åƒ…æ”¯æ´æ²»ç™‚å¸«è§’è‰²) | Patient Context |
| ç—…æ‚£æª”æ¡ˆ | Patient Profile | ç—…æ‚£çš„è©³ç´°è³‡æ–™ï¼ŒåŒ…å«å§“åã€ç”Ÿæ—¥ã€èº«é«˜é«”é‡ã€ç—…æ­·è™Ÿã€å¸è¸å²ç­‰ | â‰  User (User åƒ…åŒ…å«èªè­‰è³‡è¨Š) | Patient Context |
| ç—…æ­·è™Ÿ | Medical Record Number | é†«é™¢æä¾›çš„ç—…æ‚£å”¯ä¸€è­˜åˆ¥ç¢¼ï¼Œç”¨æ–¼è·¨ç³»çµ±å°æ¥ | é¸å¡«æ¬„ä½ï¼Œæœªä¾†å¯ç”¨æ–¼ FHIR/HL7 æ•´åˆ | Patient Context |
| BMI | Body Mass Index | èº«é«”è³ªé‡æŒ‡æ•¸ï¼Œè¨ˆç®—å…¬å¼: `weight_kg / (height_cm / 100)^2` | è‡ªå‹•è¨ˆç®—æ¬„ä½ï¼Œä¸å¯ç›´æ¥ä¿®æ”¹ | Patient Context |
| å¸è¸å² | Smoking History | ç—…æ‚£çš„å¸è¸ç‹€æ…‹ (å¾æœª/æ›¾ç¶“/ç›®å‰) èˆ‡å¸è¸å¹´æ•¸ | COPD é—œéµé¢¨éšªå› ç´ ï¼Œå¿…å¡« | Patient Context |
| æ²»ç™‚å¸«åˆ†é… | Therapist Assignment | å°‡ç—…æ‚£æŒ‡æ´¾çµ¦ç‰¹å®šæ²»ç™‚å¸«çš„å‹•ä½œï¼Œä¸€å°å¤šé—œä¿‚ | ä¸€ä½æ²»ç™‚å¸«å¯ç®¡ç†å¤šä½ç—…æ‚£ï¼Œä½†ç—…æ‚£åƒ…æœ‰ä¸€ä½è² è²¬æ²»ç™‚å¸« | Patient Context |

##### ğŸ”´ æ—¥èªŒä¸Šä¸‹æ–‡ (Daily Log Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| å¥åº·æ—¥èªŒ | Daily Log | ç—…æ‚£æ¯æ—¥æäº¤çš„å¥åº·è¡Œç‚ºè¨˜éŒ„ï¼ŒåŒ…å«ç”¨è—¥ã€é£²æ°´ã€æ­¥æ•¸ã€ç—‡ç‹€ã€å¿ƒæƒ… | â‰  å•å· (Survey) - å¾Œè€…æ˜¯å®šæœŸè©•ä¼°ï¼Œå‰è€…æ˜¯æ¯æ—¥è¨˜éŒ„ | Daily Log Context |
| ç”¨è—¥è¨˜éŒ„ | Medication Record | ç—…æ‚£ç•¶æ—¥æ˜¯å¦æœè—¥çš„å¸ƒæ—å€¼è¨˜éŒ„ | åƒ…è¨˜éŒ„æ˜¯/å¦ï¼Œä¸è¨˜éŒ„è—¥ç‰©ç¨®é¡ (è—¥ç‰©æ¸…å–®åœ¨ PatientProfile.medical_history ä¸­) | Daily Log Context |
| é£²æ°´é‡ | Water Intake | ç—…æ‚£ç•¶æ—¥é£²æ°´é‡ï¼Œå–®ä½æ¯«å‡ (ml)ï¼Œç¯„åœ 0-10000 | ç•°å¸¸å€¼ (å¦‚ > 5000ml) æœƒè§¸ç™¼è³‡æ–™é©—è­‰è­¦å‘Š | Daily Log Context |
| æ­¥æ•¸ | Steps Count | ç—…æ‚£ç•¶æ—¥æ­¥è¡Œæ­¥æ•¸ï¼Œç¯„åœ 0-100000 | é¸å¡«æ¬„ä½ï¼Œæœªä¾†å¯æ•´åˆç©¿æˆ´è£ç½® | Daily Log Context |
| ç—‡ç‹€ | Symptoms | ç—…æ‚£è‡ªè¿°çš„ç•¶æ—¥ç—‡ç‹€ï¼Œè‡ªç”±æ–‡å­—æ¬„ä½ | æœªä¾†å¯ç”¨ NLP åˆ†æç—‡ç‹€é—œéµè© (å’³å—½ã€å–˜ã€ç—°) | Daily Log Context |
| å¿ƒæƒ… | Mood | ç—…æ‚£ç•¶æ—¥æƒ…ç·’ç‹€æ…‹ï¼Œæšèˆ‰å€¼: GOOD (å¥½), NEUTRAL (æ™®é€š), BAD (ä¸å¥½) | ç”¨æ–¼è¿½è¹¤å¿ƒç†å¥åº·ï¼Œèˆ‡ç—‡ç‹€åš´é‡åº¦ç›¸é—œè¯ | Daily Log Context |
| ä¾å¾ç‡ | Adherence Rate | ç—…æ‚£éµå¾ªé†«å›‘çš„æ¯”ä¾‹ï¼Œå…¬å¼: `(N æ—¥å…§ç”¨è—¥å¤©æ•¸ / N) Ã— 100%` | ç³»çµ±æ”¯æ´ 7 æ—¥ / 30 æ—¥å…©ç¨®çµ±è¨ˆçª—å£ | Daily Log Context |
| æ‰“å¡å¤©æ•¸ | Streak Days | ç—…æ‚£é€£çºŒæäº¤æ—¥èªŒçš„å¤©æ•¸ï¼Œç”¨æ–¼éŠæˆ²åŒ–æ¿€å‹µ | æ–·ä¸€å¤©æ­¸é›¶ï¼Œç•¶å‰é€£çºŒ / æ­·å²æœ€é•·å…©ç¨®çµ±è¨ˆ | Daily Log Context |

##### ğŸ”´ å•å·ä¸Šä¸‹æ–‡ (Survey Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| CAT å•å· | COPD Assessment Test | COPD è©•ä¼°æ¸¬é©—ï¼Œ8 é¡Œé‡è¡¨ï¼Œè©•ä¼° COPD å°ç”Ÿæ´»å“è³ªçš„å½±éŸ¿ï¼Œåˆ†æ•¸ 0-40 | â‰  mMRC (å¾Œè€…åƒ…è©•ä¼°å‘¼å¸å›°é›£) | Survey Context |
| mMRC å•å· | modified Medical Research Council | ä¿®æ­£ç‰ˆè‹±åœ‹é†«å­¸ç ”ç©¶å§”å“¡æœƒå‘¼å¸å›°é›£é‡è¡¨ï¼Œå–®é¡Œé‡è¡¨ï¼Œåˆ†æ•¸ 0-4 | â‰  CAT (å¾Œè€…æ˜¯å¤šç¶­åº¦è©•ä¼°) | Survey Context |
| å•å·å›è¦† | Survey Response | ç—…æ‚£å®Œæˆå•å·å¾Œçš„ç­”æ¡ˆè¨˜éŒ„ï¼ŒåŒ…å«åŸå§‹ç­”æ¡ˆ (JSONB) èˆ‡è¨ˆç®—åˆ†æ•¸ | æäº¤å¾Œä¸å¯ä¿®æ”¹ï¼Œåƒ…èƒ½æ–°å¢æ–°ä¸€ç­†å›è¦† | Survey Context |
| åš´é‡åº¦ | Severity Level | æ ¹æ“š CAT åˆ†æ•¸è¨ˆç®—çš„ COPD åš´é‡ç¨‹åº¦ï¼Œæšèˆ‰å€¼: MILD, MODERATE, SEVERE, VERY_SEVERE | CAT < 10=è¼•å¾®, 10-20=ä¸­åº¦, 21-30=åš´é‡, >30=æ¥µåš´é‡ | Survey Context |
| è©•åˆ†å™¨ | Scorer | é ˜åŸŸæœå‹™ï¼Œè² è²¬è¨ˆç®—å•å·ç¸½åˆ†èˆ‡åš´é‡åº¦åˆ†ç´š | ä¸åŒå•å·é¡å‹æœ‰ä¸åŒçš„ Scorer å¯¦ä½œ (Strategy Pattern) | Survey Context |

##### ğŸ”´ é¢¨éšªä¸Šä¸‹æ–‡ (Risk Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| é¢¨éšªåˆ†æ•¸ | Risk Score | åŸºæ–¼å¤šå› å­è¨ˆç®—çš„ç—…æ‚£å¥åº·é¢¨éšªé‡åŒ–æŒ‡æ¨™ï¼Œç¯„åœ 0-100 | åˆ†æ•¸è¶Šé«˜é¢¨éšªè¶Šå¤§ | Risk Context |
| é¢¨éšªç­‰ç´š | Risk Level | æ ¹æ“šé¢¨éšªåˆ†æ•¸åˆ†ç´šçš„æšèˆ‰å€¼: LOW (0-40), MEDIUM (41-70), HIGH (71-100) | â‰  åš´é‡åº¦ (Severity) - å¾Œè€…ä¾†è‡ª CAT å•å·ï¼Œå‰è€…æ˜¯ç¶œåˆè©•ä¼° | Risk Context |
| é¢¨éšªå¼•æ“ | Risk Engine | é ˜åŸŸæœå‹™ï¼Œè² è²¬è¨ˆç®—é¢¨éšªåˆ†æ•¸çš„æ ¸å¿ƒé‚è¼¯ | å…¬å¼: `Score = f(ä¾å¾ç‡, CATåˆ†æ•¸, ç—‡ç‹€é »ç‡, å¹´é½¡, å¸è¸å²)` | Risk Context |
| è²¢ç»å› å­ | Contributing Factors | çµ„æˆé¢¨éšªåˆ†æ•¸çš„å„å€‹å­å› ç´ åŠå…¶æ¬Šé‡ï¼Œä»¥ JSONB å„²å­˜ | ç¯„ä¾‹: `{adherence: 0.3, cat_score: 0.25, symptoms: 0.2, age: 0.15, smoking: 0.1}` | Risk Context |
| é è­¦ | Alert | ç•¶åµæ¸¬åˆ°ç•°å¸¸æ¨¡å¼æ™‚ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„é€šçŸ¥ï¼Œéœ€æ²»ç™‚å¸«ç¢ºèªèˆ‡è™•ç† | â‰  é€šçŸ¥ (Notification) - é è­¦éœ€è¦äººå·¥è™•ç†ï¼Œé€šçŸ¥åƒ…ç‚ºè³‡è¨Šæ¨æ’­ | Risk Context |
| é è­¦é¡å‹ | Alert Type | é è­¦çš„è§¸ç™¼åŸå› ï¼Œæšèˆ‰å€¼: MISSED_MEDICATION, NO_LOG, SYMPTOM_SPIKE, RISK_ELEVATED | ä¸åŒé¡å‹æœ‰ä¸åŒçš„è™•ç†å„ªå…ˆç´š | Risk Context |
| é è­¦ç‹€æ…‹ | Alert Status | é è­¦çš„è™•ç†ç‹€æ…‹ï¼Œæšèˆ‰å€¼: OPEN (æœªè™•ç†), ACKNOWLEDGED (å·²ç¢ºèª), RESOLVED (å·²è§£æ±º) | ç‹€æ…‹è½‰æ›å–®å‘: OPEN â†’ ACKNOWLEDGED â†’ RESOLVED | Risk Context |

##### ğŸ”µ è¡›æ•™ä¸Šä¸‹æ–‡ (RAG Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| è¡›æ•™æ–‡ä»¶ | Educational Document | æä¾›çµ¦ç—…æ‚£çš„è¡›æ•™çŸ¥è­˜æ–‡ç« ï¼Œé¡åˆ¥åŒ…å«ç”¨è—¥ã€é‹å‹•ã€é£²é£Ÿã€å‘¼å¸è¨“ç·´ç­‰ | â‰  ç³»çµ±æ–‡æª” (Documentation) | RAG Context |
| çŸ¥è­˜å€å¡Š | Chunk | å¾è¡›æ•™æ–‡ä»¶ä¸­æ‹†åˆ†å‡ºç”¨æ–¼å‘é‡æª¢ç´¢çš„æœ€å°å–®ä½ï¼Œæ¯å¡Š â‰¤ 500 å­— | æ‹†åˆ†ç­–ç•¥: æŒ‰æ®µè½ + æ»‘å‹•çª—å£ (Sliding Window) | RAG Context |
| å‘é‡åµŒå…¥ | Embedding | çŸ¥è­˜å€å¡Šè½‰æ›ç‚ºé«˜ç¶­å‘é‡çš„è¡¨ç¤ºï¼Œä½¿ç”¨ OpenAI text-embedding-3-small (ç¶­åº¦ 1536) | â‰  Tokenization (å¾Œè€…æ˜¯æ–‡æœ¬è½‰æ•¸å­—ï¼Œå‰è€…æ˜¯èªç¾©å‘é‡åŒ–) | RAG Context |
| èªç¾©æª¢ç´¢ | Semantic Retrieval | æ ¹æ“šæŸ¥è©¢æ–‡æœ¬çš„èªç¾© (è€Œéé—œéµè©) æ‰¾åˆ°æœ€ç›¸é—œçš„çŸ¥è­˜å€å¡Š | ä½¿ç”¨é¤˜å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity) æ’åº | RAG Context |
| RAG | Retrieval-Augmented Generation | æª¢ç´¢å¢å¼·ç”Ÿæˆï¼Œå…ˆæª¢ç´¢ç›¸é—œçŸ¥è­˜ï¼Œå†ç”¨ LLM ç”Ÿæˆå›ç­”çš„æŠ€è¡“ | æµç¨‹: Query â†’ Embedding â†’ Retrieval (Top-K) â†’ LLM Prompt â†’ Response | RAG Context |
| å¼•ç”¨ä¾†æº | Citation | AI å›è¦†ä¸­æ¨™è¨»çš„åƒè€ƒè³‡æ–™ä¾†æºï¼ŒåŒ…å«æ–‡ä»¶æ¨™é¡Œèˆ‡é€£çµ | é€æ˜åŒ– AI æ¨ç†éç¨‹ï¼Œæå‡ä½¿ç”¨è€…ä¿¡ä»»æ„Ÿ | RAG Context |
| STT | Speech-To-Text | èªéŸ³è½‰æ–‡å­—æœå‹™ï¼Œä½¿ç”¨ OpenAI Whisper API | æ”¯æ´å°èª/åœ‹èªæ··åˆè¾¨è­˜ (ç¹é«”ä¸­æ–‡) | RAG Context |
| TTS | Text-To-Speech | æ–‡å­—è½‰èªéŸ³æœå‹™ï¼Œä½¿ç”¨ OpenAI TTS API | ä½¿ç”¨æ“¬äººåŒ–è²éŸ³ (å­«å¥³èªæ°£) | RAG Context |

##### ğŸŸ¢ é€šçŸ¥ä¸Šä¸‹æ–‡ (Notification Context)

| è¡“èª | è‹±æ–‡ | å®šç¾© | åä¾‹ / æ³¨æ„äº‹é … | æ‰€å±¬ä¸Šä¸‹æ–‡ |
|------|------|------|-----------------|-----------|
| é€šçŸ¥ | Notification | ç³»çµ±ç™¼é€çµ¦ä½¿ç”¨è€…çš„è¨Šæ¯ï¼ŒåŒ…å«æé†’ã€é è­¦ã€é€±å ±ç­‰ | â‰  é è­¦ (Alert) - é è­¦éœ€æ²»ç™‚å¸«è™•ç†ï¼Œé€šçŸ¥åƒ…ç‚ºè³‡è¨Šæ¨æ’­ | Notification Context |
| æ™ºæ…§æé†’ | Smart Reminder | æ ¹æ“šç—…æ‚£è¡Œç‚ºæ¨¡å¼è‡ªå‹•æ’ç¨‹çš„æé†’é€šçŸ¥ï¼Œä¸‰æ™‚æ®µ: 12:00, 17:00, 20:00 | æœªå¡«æ—¥èªŒæ™‚è§¸ç™¼ï¼Œé€£çºŒå¡«å¯« 3 å¤©å¾Œè‡ªå‹•æ¸›å°‘é »ç‡ | Notification Context |
| æ¨æ’­ç®¡é“ | Channel | é€šçŸ¥ç™¼é€çš„ç®¡é“ï¼Œæšèˆ‰å€¼: LINE, EMAIL | MVP éšæ®µåƒ…æ”¯æ´ LINEï¼ŒPhase 2 åŠ å…¥ Email | Notification Context |
| ç™¼é€ç‹€æ…‹ | Delivery Status | é€šçŸ¥çš„ç™¼é€ç‹€æ…‹ï¼Œæšèˆ‰å€¼: PENDING (å¾…ç™¼é€), SENT (å·²ç™¼é€), FAILED (å¤±æ•—) | å¤±æ•—å¾Œè‡ªå‹•é‡è©¦ 3 æ¬¡ (æŒ‡æ•¸é€€é¿) | Notification Context |
| è¨Šæ¯æ¨¡æ¿ | Message Template | é å…ˆå®šç¾©çš„é€šçŸ¥æ–‡æ¡ˆæ ¼å¼ï¼Œæ”¯æ´è®Šæ•¸æ›¿æ› | ç¯„ä¾‹: `{patient_name} æ‚¨å¥½ï¼Œä»Šæ—¥é‚„æ²’è¨˜éŒ„å¥åº·æ—¥èªŒå–”ï¼` | Notification Context |
| æ“¬äººåŒ–å£å» | Humanized Tone | é€šçŸ¥æ–‡æ¡ˆä½¿ç”¨å­«å¥³å°é•·è¼©çš„æº«é¦¨èªæ°£ï¼Œæå‡è¦ªå’ŒåŠ› | åƒè€ƒ ADR-007: æ“¬äººåŒ–è¨Šæ¯ç­–ç•¥ | Notification Context |

---

#### 3.2.2 è¡“èªä½¿ç”¨è¦ç¯„

**é–‹ç™¼åœ˜éšŠè¦ç¯„**:
1. **ä»£ç¢¼å‘½å**: é¡åˆ¥ã€è®Šæ•¸ã€å‡½æ•¸å‘½åå¿…é ˆä½¿ç”¨çµ±ä¸€èªè¨€çš„è‹±æ–‡è¡“èª (å¦‚ `DailyLog`, `adherence_rate`)
2. **æ–‡æª”æ’°å¯«**: æŠ€è¡“æ–‡æª”èˆ‡ PRD å¿…é ˆä½¿ç”¨çµ±ä¸€èªè¨€çš„ä¸­æ–‡è¡“èªï¼Œä¸¦åœ¨é¦–æ¬¡å‡ºç¾æ™‚é™„è¨»è‹±æ–‡
3. **æºé€šæœƒè­°**: éœ€æ±‚è¨è«–èˆ‡æŠ€è¡“è©•å¯©æœƒè­°ä¸­ï¼Œåœ˜éšŠæˆå“¡å¿…é ˆä½¿ç”¨çµ±ä¸€èªè¨€è¡“èªï¼Œé¿å…è‡ªå‰µè©å½™
4. **è¡“èªæ›´æ–°**: ç•¶ç™¼ç¾æ¥­å‹™æ¦‚å¿µè®ŠåŒ–æ™‚ï¼Œå¿…é ˆæ›´æ–°æœ¬è©å½™è¡¨ï¼Œä¸¦é€šçŸ¥å…¨é«”åœ˜éšŠ

**å¸¸è¦‹éŒ¯èª¤èˆ‡ç³¾æ­£**:

| âŒ éŒ¯èª¤è¡“èª | âœ… æ­£ç¢ºè¡“èª | ç³¾æ­£ç†ç”± |
|------------|------------|----------|
| "æ—¥è¨˜" | "å¥åº·æ—¥èªŒ (Daily Log)" | "æ—¥è¨˜" éæ–¼å£èªåŒ–ï¼Œä¸ç²¾ç¢º |
| "å•é¡Œ" | "ç—‡ç‹€ (Symptoms)" æˆ– "é è­¦ (Alert)" | éœ€å€åˆ†æ‚£è€…è‡ªè¿°ç—‡ç‹€ vs ç³»çµ±é è­¦ |
| "é€šçŸ¥" èˆ‡ "é è­¦" æ··ç”¨ | æ˜ç¢ºå€åˆ†: "é€šçŸ¥ (Notification)" vs "é è­¦ (Alert)" | é è­¦éœ€æ²»ç™‚å¸«è™•ç†ï¼Œé€šçŸ¥åƒ…ç‚ºè³‡è¨Š |
| "ç”¨æˆ¶" èˆ‡ "ç—…æ‚£" æ··ç”¨ | æ˜ç¢ºå€åˆ†: "ç”¨æˆ¶ (User)" åŒ…å«ç—…æ‚£èˆ‡æ²»ç™‚å¸« | ç—…æ‚£æ˜¯ç”¨æˆ¶çš„å­é¡å‹ |
| "ç™»å…¥å¤±æ•—æ¬¡æ•¸" | "å¸³è™Ÿé–å®š (Account Lockout)" | æ‡‰ä½¿ç”¨æ¥­å‹™è¡“èªè€ŒéæŠ€è¡“å¯¦ä½œç´°ç¯€ |

---

### 3.3 èšåˆè¨­è¨ˆ (Aggregate Design)

èšåˆ (Aggregate) æ˜¯ DDD æˆ°è¡“è¨­è¨ˆçš„æ ¸å¿ƒæ¨¡å¼ï¼Œç”¨æ–¼ç¶­è­·æ¥­å‹™ä¸è®Šé‡ (Invariants) èˆ‡å®šç¾©äº‹å‹™é‚Šç•Œã€‚æ¯å€‹èšåˆæœ‰ä¸”åƒ…æœ‰ä¸€å€‹èšåˆæ ¹ (Aggregate Root)ï¼Œä½œç‚ºå°å¤–è¨ªå•çš„å”¯ä¸€å…¥å£ã€‚

#### 3.3.1 èšåˆè¨­è¨ˆåŸå‰‡

éµå¾ªä»¥ä¸‹ DDD èšåˆè¨­è¨ˆåŸå‰‡:

1. **å°èšåˆå„ªå…ˆ** - èšåˆè¶Šå°è¶Šå¥½ï¼Œåƒ…åŒ…å«å¿…é ˆä¿æŒå¼·ä¸€è‡´æ€§çš„å¯¦é«”
2. **ä¸è®Šé‡ä¿è­·** - èšåˆæ ¹è² è²¬ç¶­è­·èšåˆå…§æ‰€æœ‰æ¥­å‹™è¦å‰‡
3. **äº‹å‹™é‚Šç•Œ** - æ¯æ¬¡äº‹å‹™åƒ…ä¿®æ”¹ä¸€å€‹èšåˆå¯¦ä¾‹
4. **é€šé ID å¼•ç”¨** - èšåˆé–“é€šé ID é—œè¯ï¼Œè€Œéç›´æ¥æŒæœ‰å°è±¡å¼•ç”¨
5. **æœ€çµ‚ä¸€è‡´æ€§** - è·¨èšåˆçš„æ¥­å‹™è¦å‰‡é€éé ˜åŸŸäº‹ä»¶å¯¦ç¾æœ€çµ‚ä¸€è‡´æ€§

#### 3.3.2 èšåˆç›®éŒ„

RespiraAlly V2.0 ç³»çµ±åŒ…å«ä»¥ä¸‹ 7 å€‹æ ¸å¿ƒèšåˆ:

| èšåˆæ ¹ | æ‰€å±¬ä¸Šä¸‹æ–‡ | æ ¸å¿ƒè·è²¬ | ä¸è®Šé‡ (Invariants) |
|--------|-----------|----------|---------------------|
| **Patient** | Patient Context | ç®¡ç†æ‚£è€…æª”æ¡ˆã€æ²»ç™‚å¸«åˆ†é… | - å¹´é½¡ >= 18 æ­²<br/>- BMI ç”±èº«é«˜é«”é‡è¨ˆç®—<br/>- å¿…é ˆåˆ†é…çµ¦ä¸€ä½æ²»ç™‚å¸« |
| **DailyLog** | Daily Log Context | è¨˜éŒ„æ¯æ—¥å¥åº·è¡Œç‚º | - æ¯ä½æ‚£è€…æ¯å¤©åƒ…ä¸€ç­†è¨˜éŒ„<br/>- ç”¨è—¥ç‹€æ…‹å¿…é ˆæ˜ç¢º (true/false)<br/>- é£²æ°´é‡ 0-10000ml |
| **SurveyResponse** | Survey Context | è¨˜éŒ„å•å·ç­”æ¡ˆèˆ‡è©•åˆ† | - CAT åˆ†æ•¸ 0-40<br/>- mMRC åˆ†æ•¸ 0-4<br/>- æäº¤å¾Œä¸å¯ä¿®æ”¹ |
| **RiskScore** | Risk Context | è¨ˆç®—ä¸¦å„²å­˜é¢¨éšªè©•åˆ† | - åˆ†æ•¸ 0-100<br/>- é¢¨éšªç­‰ç´šç”±åˆ†æ•¸è¨ˆç®—<br/>- æ¯å¤©åƒ…ä¸€å€‹åˆ†æ•¸ |
| **Alert** | Risk Context | ç®¡ç†é è­¦ç”Ÿå‘½é€±æœŸ | - ç‹€æ…‹è½‰æ›å–®å‘: OPEN â†’ ACKNOWLEDGED â†’ RESOLVED<br/>- åƒ…èƒ½ç”±è² è²¬æ²»ç™‚å¸«è™•ç† |
| **EducationalDocument** | RAG Context | ç®¡ç†è¡›æ•™æ–‡ä»¶èˆ‡å€å¡Š | - æ–‡ä»¶å¿…é ˆæœ‰è‡³å°‘ä¸€å€‹å€å¡Š<br/>- å€å¡Š index å¿…é ˆé€£çºŒ<br/>- Embedding ç¶­åº¦ä¸€è‡´ |
| **User** | Auth Context | ç®¡ç†èªè­‰èˆ‡æˆæ¬Š | - LINE User ID æˆ– Email è‡³å°‘ä¸€å€‹<br/>- Role èˆ‡ç™»å…¥æ–¹å¼ä¸€è‡´<br/>- æ²»ç™‚å¸«ç™»å…¥å¤±æ•—é–å®šé‚è¼¯ |

---

#### 3.3.3 é—œéµèšåˆè¨­è¨ˆç¯„ä¾‹

##### Patient Aggregate (å€‹æ¡ˆèšåˆ)

**èšåˆé‚Šç•Œ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Patient Aggregate                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  Patient    â”‚ (Aggregate Root)   â”‚
â”‚  â”‚  - user_id  â”‚                    â”‚
â”‚  â”‚  - therapist_id â”€â”€> (Reference)  â”‚
â”‚  â”‚  - profile  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä¸è®Šé‡**:
1. Patient å¹´é½¡å¿…é ˆ >= 18 æ­²
2. BMI = weight_kg / (height_cm / 100)Â² (è‡ªå‹•è¨ˆç®—)
3. å¿…é ˆåˆ†é…çµ¦ä¸€ä½æ²»ç™‚å¸« (therapist_id NOT NULL)

**é ˜åŸŸäº‹ä»¶**:
- `PatientRegistered` - æ‚£è€…è¨»å†Šå®Œæˆ
- `TherapistAssigned` - æ²»ç™‚å¸«åˆ†é…è®Šæ›´
- `PatientProfileUpdated` - æª”æ¡ˆæ›´æ–°

##### DailyLog Aggregate (æ—¥èªŒèšåˆ)

**èšåˆé‚Šç•Œ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DailyLog Aggregate                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  DailyLog   â”‚ (Aggregate Root)   â”‚
â”‚  â”‚  - log_id   â”‚                    â”‚
â”‚  â”‚  - patient_id â”€â”€> (Reference)    â”‚
â”‚  â”‚  - log_date â”‚                    â”‚
â”‚  â”‚  - medication_taken â”‚            â”‚
â”‚  â”‚  - water_intake_ml â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä¸è®Šé‡**:
1. æ¯ä½æ‚£è€…æ¯å¤©åƒ…ä¸€ç­†è¨˜éŒ„ (UNIQUE INDEX on patient_id, log_date)
2. ä¸å¯æäº¤æœªä¾†æ—¥æœŸçš„æ—¥èªŒ
3. é£²æ°´é‡å¿…é ˆåœ¨ 0-10000ml ç¯„åœå…§

**é ˜åŸŸäº‹ä»¶**:
- `DailyLogSubmitted` - è§¸ç™¼é¢¨éšªé‡æ–°è¨ˆç®—
- `AdherenceRateChanged` - ä¾å¾ç‡è®ŠåŒ– (å¯é¸)

##### RiskScore Aggregate (é¢¨éšªè©•åˆ†èšåˆ)

**æ ¸å¿ƒä¸è®Šé‡**:
1. é¢¨éšªåˆ†æ•¸å¿…é ˆåœ¨ 0-100 ä¹‹é–“
2. é¢¨éšªç­‰ç´š (LOW/MEDIUM/HIGH) ç”±åˆ†æ•¸è‡ªå‹•è¨ˆç®—
3. æ¯ä½æ‚£è€…æ¯å¤©åƒ…ä¸€å€‹é¢¨éšªåˆ†æ•¸

**é ˜åŸŸæœå‹™**:
- `RiskEngine.calculate()` - è¨ˆç®—é¢¨éšªåˆ†æ•¸çš„é ˜åŸŸæœå‹™
- å…¬å¼: `Score = f(adherence_rate Ã— 0.3, cat_score Ã— 0.25, symptom_frequency Ã— 0.2, age Ã— 0.15, smoking_years Ã— 0.1)`

**é ˜åŸŸäº‹ä»¶**:
- `RiskScoreCalculated` - é¢¨éšªè©•åˆ†å®Œæˆ
- `AlertTriggered` - é¢¨éšªç­‰ç´šæå‡è§¸ç™¼é è­¦

---

#### 3.3.4 èšåˆè¨­è¨ˆæª¢æ ¸æ¸…å–®

- [x] **æ¯å€‹èšåˆæœ‰æ˜ç¢ºçš„èšåˆæ ¹** - æ‰€æœ‰ 7 å€‹èšåˆéƒ½æœ‰å”¯ä¸€çš„ Aggregate Root
- [x] **èšåˆé‚Šç•Œæ¸…æ™°** - èšåˆå…§å¯¦é«”ç·Šå¯†ç›¸é—œ,èšåˆé–“é€šé ID å¼•ç”¨
- [x] **ä¸è®Šé‡æ˜ç¢º** - æ¯å€‹èšåˆéƒ½æœ‰æ˜ç¢ºçš„æ¥­å‹™è¦å‰‡èˆ‡é©—è­‰é‚è¼¯
- [x] **äº‹å‹™é‚Šç•Œ** - æ¯æ¬¡äº‹å‹™åƒ…ä¿®æ”¹ä¸€å€‹èšåˆå¯¦ä¾‹
- [x] **é ˜åŸŸäº‹ä»¶** - è·¨èšåˆæ“ä½œé€šéé ˜åŸŸäº‹ä»¶å¯¦ç¾æœ€çµ‚ä¸€è‡´æ€§
- [x] **å°èšåˆå„ªå…ˆ** - èšåˆåƒ…åŒ…å«å¿…é ˆå¼·ä¸€è‡´æ€§çš„å¯¦é«”
- [x] **é€šé ID å¼•ç”¨** - Patient èšåˆå¼•ç”¨ Therapist ä½¿ç”¨ `therapist_id` è€Œéå°è±¡å¼•ç”¨

---

## 4. æ¶æ§‹è¨­è¨ˆ (Architecture Design)

æœ¬ç« ç¯€å®šç¾© RespiraAlly V2.0 çš„æ•´é«”æ¶æ§‹è¨­è¨ˆï¼ŒåŒ…å«æ°´å¹³çš„æ¨¡çµ„é‚Šç•ŒåŠƒåˆ†ï¼ˆModular Monolithï¼‰èˆ‡å‚ç›´çš„åˆ†å±¤è¨­è¨ˆï¼ˆClean Architectureï¼‰ï¼Œç¢ºä¿ç³»çµ±çš„é«˜å…§èšã€ä½è€¦åˆã€å¯æ¸¬è©¦èˆ‡å¯æ¼”é€²ã€‚

---

### 4.1 Modular Monolith æ¨¡çµ„é‚Šç•ŒåŠƒåˆ†

#### 4.1.1 è¨­è¨ˆåŸå‰‡èˆ‡æ±ºç­–ä¾æ“š

**ä»€éº¼æ˜¯ Modular Monolithï¼Ÿ**

Modular Monolithï¼ˆæ¨¡çµ„åŒ–å–®é«”ï¼‰æ˜¯ä¸€ç¨®æ¶æ§‹æ¨¡å¼ï¼Œåœ¨å–®ä¸€éƒ¨ç½²å–®å…ƒï¼ˆMonolithï¼‰å…§éƒ¨é€šéæ˜ç¢ºçš„æ¨¡çµ„é‚Šç•Œï¼ˆModulesï¼‰å¯¦ç¾é‚è¼¯éš”é›¢ã€‚æ¯å€‹æ¨¡çµ„ï¼š
- æ“æœ‰ç¨ç«‹çš„æ¥­å‹™è·è²¬èˆ‡æ•¸æ“šæ‰€æœ‰æ¬Š
- å°å¤–æš´éœ²æ˜ç¢ºçš„ API æ¥å£ï¼ˆPublic Interfaceï¼‰
- å…§éƒ¨å¯¦ç¾ç´°ç¯€å®Œå…¨å°è£ï¼ˆPrivate Implementationï¼‰
- é€éäº‹ä»¶æˆ–æ¥å£èˆ‡å…¶ä»–æ¨¡çµ„é€šä¿¡

**ç‚ºä»€éº¼é¸æ“‡ Modular Monolithï¼Ÿ**

åŸºæ–¼ Linus-style äº”å±¤åˆ†æï¼š

| åˆ†æå±¤ | è©•ä¼° |
|--------|------|
| **æ•¸æ“šçµæ§‹åˆ†æ** | 7 å€‹ç•Œé™ä¸Šä¸‹æ–‡è‡ªç„¶æ˜ å°„ç‚º 7 å€‹æ¨¡çµ„ï¼Œæ•¸æ“šæ‰€æœ‰æ¬Šæ¸…æ™° |
| **ç‰¹æ®Šæƒ…æ³è­˜åˆ¥** | é€šç”¨å­åŸŸï¼ˆAuth, Notificationï¼‰è¢«å¤šå€‹æ¨¡çµ„ä¾è³´ï¼Œéœ€é€šéä¾è³´æ³¨å…¥é¿å…å¾ªç’°ä¾è³´ |
| **è¤‡é›œåº¦å¯©æŸ¥** | Modular Monolith æ¯”å¾®æœå‹™ç°¡å–®ï¼ˆç„¡åˆ†å¸ƒå¼è¤‡é›œæ€§ï¼‰ï¼Œæ¯”å‚³çµ±å–®é«”æ¸…æ™°ï¼ˆæœ‰æ˜ç¢ºé‚Šç•Œï¼‰ |
| **ç ´å£æ€§åˆ†æ** | é›¶ç ´å£ï¼šæ–°å°ˆæ¡ˆå¾é›¶é–‹å§‹ï¼Œæœªä¾†å¯æ¼”é€²ç‚ºå¾®æœå‹™ï¼ˆæ¨¡çµ„é‚Šç•Œå·²æ¸…æ™°ï¼‰ |
| **å¯¦ç”¨æ€§é©—è­‰** | âœ… MVP éšæ®µ DAU < 100ï¼ŒModular Monolith è¶³å¤ ï¼›æœªä¾†å¯æŒ‰æ¨¡çµ„æ‹†åˆ†ç‚ºå¾®æœå‹™ |

**ADR æ±ºç­–**: è©³è¦‹ `docs/04_architecture_decision_record/ADR-003_modular_monolith_vs_microservices.md`

---

#### 4.1.2 æ¨¡çµ„æ˜ å°„è¡¨ (Module Mapping)

åŸºæ–¼ DDD æˆ°ç•¥è¨­è¨ˆçš„ 7 å€‹ç•Œé™ä¸Šä¸‹æ–‡ï¼ˆÂ§3.1ï¼‰ï¼Œå®šç¾© 7 å€‹ Modular Monolith æ¨¡çµ„ï¼š

| æ¨¡çµ„åç¨± | å°æ‡‰ç•Œé™ä¸Šä¸‹æ–‡ | å­åŸŸé¡å‹ | æ ¸å¿ƒè·è²¬ | æ•¸æ“šæ‰€æœ‰æ¬Š |
|----------|----------------|----------|----------|------------|
| **auth** | Auth Context | é€šç”¨å­åŸŸ | ç”¨æˆ¶èªè­‰ã€æˆæ¬Šã€æœƒè©±ç®¡ç† | `users`, `sessions`, `refresh_tokens` |
| **patient** | Patient Context | æ”¯æ’å­åŸŸ | å€‹æ¡ˆæª”æ¡ˆç®¡ç†ã€æ²»ç™‚å¸«åˆ†é… | `patient_profiles`, `therapist_profiles` |
| **daily_log** | Daily Log Context | **æ ¸å¿ƒåŸŸ** | æ¯æ—¥å¥åº·æ—¥èªŒã€ä¾å¾ç‡è¨ˆç®— | `daily_logs`, `patient_kpi_cache` |
| **survey** | Survey Context | æ”¯æ’å­åŸŸ | CAT/mMRC å•å·ã€è©•åˆ†è¨ˆç®— | `survey_responses` |
| **risk** | Risk Context | **æ ¸å¿ƒåŸŸ** | é¢¨éšªè©•åˆ†ã€ç•°å¸¸é è­¦ | `risk_scores`, `alerts` |
| **rag** | RAG Context | æ”¯æ’å­åŸŸ | è¡›æ•™çŸ¥è­˜åº«ã€AI èªéŸ³å•ç­” | `educational_documents`, `document_chunks`, `chat_sessions`, `ai_processing_logs` |
| **notification** | Notification Context | é€šç”¨å­åŸŸ | LINE/Email é€šçŸ¥ã€æ’ç¨‹ç™¼é€ | `notification_history` |

**æ¨¡çµ„æ‰€æœ‰æ¬ŠåŸå‰‡**:
- âœ… æ¯å¼µè³‡æ–™è¡¨åƒ…å±¬æ–¼ä¸€å€‹æ¨¡çµ„
- âœ… æ¨¡çµ„é–“ä¸å¯ç›´æ¥ JOIN æŸ¥è©¢ï¼ˆå¿…é ˆé€šéæ¥å£æˆ–äº‹ä»¶ç²å–æ•¸æ“šï¼‰
- âœ… å…±äº«æ•¸æ“šé€šé Read Modelï¼ˆå¦‚ KPI Cacheï¼‰æˆ–äº‹ä»¶åŒæ­¥

---

#### 4.1.3 æ¨¡çµ„ä¾è³´èˆ‡é€šä¿¡åœ– (Module Dependency & Communication)

```mermaid
graph TB
    subgraph "é€šç”¨å­åŸŸ (Generic Subdomain)"
        Auth[auth<br/>èªè­‰æ¨¡çµ„]
        Notification[notification<br/>é€šçŸ¥æ¨¡çµ„]
    end

    subgraph "æ ¸å¿ƒåŸŸ (Core Domain)"
        DailyLog[daily_log<br/>æ—¥èªŒæ¨¡çµ„]
        Risk[risk<br/>é¢¨éšªæ¨¡çµ„]
    end

    subgraph "æ”¯æ’å­åŸŸ (Supporting Subdomain)"
        Patient[patient<br/>å€‹æ¡ˆæ¨¡çµ„]
        Survey[survey<br/>å•å·æ¨¡çµ„]
        RAG[rag<br/>è¡›æ•™æ¨¡çµ„]
    end

    %% åŒæ­¥ä¾è³´ (Synchronous API Calls)
    DailyLog -->|é©—è­‰æ‚£è€…å­˜åœ¨| Patient
    Survey -->|é©—è­‰æ‚£è€…å­˜åœ¨| Patient
    Risk -->|è®€å–æ—¥èªŒæ•¸æ“š| DailyLog
    Risk -->|è®€å–å•å·åˆ†æ•¸| Survey
    Risk -->|è®€å–æ‚£è€…æª”æ¡ˆ| Patient

    %% ç•°æ­¥ä¾è³´ (Asynchronous Events)
    DailyLog -.->|äº‹ä»¶: LogSubmitted| Risk
    Survey -.->|äº‹ä»¶: SurveyCompleted| Risk
    Risk -.->|äº‹ä»¶: AlertTriggered| Notification

    %% èªè­‰ä¾è³´ (æ‰€æœ‰æ¨¡çµ„ä¾è³´ Auth)
    Auth -.->|æä¾› JWT é©—è­‰| DailyLog
    Auth -.->|æä¾› JWT é©—è­‰| Patient
    Auth -.->|æä¾› JWT é©—è­‰| Survey
    Auth -.->|æä¾› JWT é©—è­‰| Risk
    Auth -.->|æä¾› JWT é©—è­‰| RAG

    style Auth fill:#99ff99,stroke:#009900,stroke-width:2px
    style Notification fill:#99ff99,stroke:#009900,stroke-width:2px
    style DailyLog fill:#ff9999,stroke:#cc0000,stroke-width:3px
    style Risk fill:#ff9999,stroke:#cc0000,stroke-width:3px
    style Patient fill:#99ccff,stroke:#0066cc,stroke-width:2px
    style Survey fill:#99ccff,stroke:#0066cc,stroke-width:2px
    style RAG fill:#99ccff,stroke:#0066cc,stroke-width:2px
```

**åœ–ä¾‹èªªæ˜**:
- **å¯¦ç·šç®­é ­ (â†’)**: åŒæ­¥ API èª¿ç”¨ï¼ˆé€šéæ¥å£ï¼‰
- **è™›ç·šç®­é ­ (-.->)**: ç•°æ­¥äº‹ä»¶é€šä¿¡ï¼ˆé€šéäº‹ä»¶ç¸½ç·šï¼‰
- **ç´…è‰²é‚Šæ¡†**: æ ¸å¿ƒåŸŸæ¨¡çµ„ï¼ˆç«¶çˆ­å„ªå‹¢æ‰€åœ¨ï¼‰
- **è—è‰²é‚Šæ¡†**: æ”¯æ’å­åŸŸæ¨¡çµ„ï¼ˆæ”¯æ’æ ¸å¿ƒæ¥­å‹™ï¼‰
- **ç¶ è‰²é‚Šæ¡†**: é€šç”¨å­åŸŸæ¨¡çµ„ï¼ˆå¯ç”¨ç¾æˆæ–¹æ¡ˆï¼‰

---

#### 4.1.4 æ¨¡çµ„é–“é€šä¿¡æ©Ÿåˆ¶ (Inter-Module Communication)

**é€šä¿¡æ–¹å¼é¸æ“‡çŸ©é™£**:

| å ´æ™¯ | é€šä¿¡æ–¹å¼ | ç¯„ä¾‹ | ç†ç”± |
|------|----------|------|------|
| **æŸ¥è©¢æ•¸æ“š** | åŒæ­¥ API èª¿ç”¨ | Risk æ¨¡çµ„æŸ¥è©¢ DailyLog çš„è¿‘æœŸæ—¥èªŒ | éœ€è¦å³æ™‚æ•¸æ“šï¼Œç°¡å–®ç›´æ¥ |
| **è§¸ç™¼å‰¯ä½œç”¨** | ç•°æ­¥äº‹ä»¶ | DailyLog æäº¤å¾Œè§¸ç™¼ Risk é‡ç®— | è§£è€¦ï¼Œé¿å…ç´šè¯å¤±æ•— |
| **é€šçŸ¥å¤–éƒ¨** | ç•°æ­¥äº‹ä»¶ | Risk è§¸ç™¼ Alert å¾Œé€šçŸ¥ Notification | è§£è€¦ï¼Œæ”¯æŒå¤šè¨‚é–±è€… |
| **èº«ä»½é©—è­‰** | ä¸­é–“ä»¶æ³¨å…¥ | Auth æ¨¡çµ„æä¾› JWT é©—è­‰ä¸­é–“ä»¶ | æ©«åˆ‡é—œæ³¨é»ï¼ˆCross-Cutting Concernï¼‰ |

**1. åŒæ­¥ API èª¿ç”¨ (Synchronous Calls)**

é€éå®šç¾© **Port Interface** å¯¦ç¾ä¾è³´åè½‰ï¼š

```python
# daily_log/domain/ports/patient_port.py (å®šç¾©æ¥å£)
from abc import ABC, abstractmethod
from uuid import UUID

class IPatientPort(ABC):
    @abstractmethod
    async def verify_patient_exists(self, patient_id: UUID) -> bool:
        """é©—è­‰æ‚£è€…æ˜¯å¦å­˜åœ¨"""
        pass

# patient/application/adapters/patient_adapter.py (å¯¦ç¾æ¥å£)
from daily_log.domain.ports import IPatientPort

class PatientAdapter(IPatientPort):
    async def verify_patient_exists(self, patient_id: UUID) -> bool:
        # å¯¦ä½œé‚è¼¯
        return await db.fetchval("SELECT EXISTS(SELECT 1 FROM patient_profiles WHERE patient_id = $1)", patient_id)

# main.py (ä¾è³´æ³¨å…¥)
from daily_log.application.use_cases import SubmitDailyLogUseCase
from patient.application.adapters import PatientAdapter

patient_port = PatientAdapter()
submit_log_use_case = SubmitDailyLogUseCase(patient_port=patient_port)
```

**2. ç•°æ­¥äº‹ä»¶é€šä¿¡ (Asynchronous Events)**

é€é **Event Bus** å¯¦ç¾ç™¼å¸ƒ-è¨‚é–±æ¨¡å¼ï¼š

```python
# daily_log/domain/events.py (å®šç¾©äº‹ä»¶)
from dataclasses import dataclass
from datetime import datetime
from uuid import UUID

@dataclass
class DailyLogSubmittedEvent:
    patient_id: UUID
    log_date: datetime
    medication_taken: bool
    occurred_at: datetime

# daily_log/application/use_cases/submit_daily_log.py (ç™¼å¸ƒäº‹ä»¶)
class SubmitDailyLogUseCase:
    async def execute(self, command: SubmitDailyLogCommand):
        # ä¿å­˜æ—¥èªŒ
        log = await self.repo.save(daily_log)

        # ç™¼å¸ƒäº‹ä»¶
        event = DailyLogSubmittedEvent(
            patient_id=log.patient_id,
            log_date=log.log_date,
            medication_taken=log.medication_taken,
            occurred_at=datetime.utcnow()
        )
        await self.event_bus.publish(event)

# risk/application/event_handlers.py (è¨‚é–±äº‹ä»¶)
class RiskCalculationEventHandler:
    async def handle_daily_log_submitted(self, event: DailyLogSubmittedEvent):
        await self.calculate_risk_use_case.execute(patient_id=event.patient_id)
```

---

#### 4.1.5 æ¨¡çµ„ç›®éŒ„çµæ§‹ (Module Directory Structure)

```
backend/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ auth/                    # èªè­‰æ¨¡çµ„
â”‚   â”‚   â”œâ”€â”€ domain/              # é ˜åŸŸå±¤ (ç´”æ¥­å‹™é‚è¼¯)
â”‚   â”‚   â”‚   â”œâ”€â”€ entities/        # å¯¦é«” (User, Session)
â”‚   â”‚   â”‚   â”œâ”€â”€ value_objects/   # å€¼å°è±¡ (Email, HashedPassword)
â”‚   â”‚   â”‚   â”œâ”€â”€ services/        # é ˜åŸŸæœå‹™ (PasswordHasher)
â”‚   â”‚   â”‚   â”œâ”€â”€ events/          # é ˜åŸŸäº‹ä»¶ (UserCreated)
â”‚   â”‚   â”‚   â””â”€â”€ ports/           # æ¥å£å®šç¾© (IUserRepository)
â”‚   â”‚   â”œâ”€â”€ application/         # æ‡‰ç”¨å±¤ (ç”¨ä¾‹ç·¨æ’)
â”‚   â”‚   â”‚   â”œâ”€â”€ use_cases/       # ç”¨ä¾‹ (LoginUseCase, RefreshTokenUseCase)
â”‚   â”‚   â”‚   â”œâ”€â”€ dtos/            # æ•¸æ“šå‚³è¼¸å°è±¡ (LoginRequest, TokenResponse)
â”‚   â”‚   â”‚   â””â”€â”€ event_handlers/  # äº‹ä»¶è™•ç†å™¨
â”‚   â”‚   â”œâ”€â”€ infrastructure/      # åŸºç¤è¨­æ–½å±¤ (å¯¦ä½œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/    # å€‰å„²å¯¦ç¾ (SQLAlchemyUserRepository)
â”‚   â”‚   â”‚   â”œâ”€â”€ adapters/        # å¤–éƒ¨æœå‹™é©é…å™¨ (LINEOAuthAdapter)
â”‚   â”‚   â”‚   â””â”€â”€ persistence/     # æ•¸æ“šæ¨¡å‹ (SQLAlchemy Models)
â”‚   â”‚   â””â”€â”€ presentation/        # è¡¨ç¾å±¤ (API)
â”‚   â”‚       â”œâ”€â”€ routers/         # FastAPI è·¯ç”± (auth_router.py)
â”‚   â”‚       â”œâ”€â”€ schemas/         # Pydantic æ¨¡å‹ (LoginRequestSchema)
â”‚   â”‚       â””â”€â”€ middleware/      # ä¸­é–“ä»¶ (JWTAuthMiddleware)
â”‚   â”‚
â”‚   â”œâ”€â”€ patient/                 # å€‹æ¡ˆæ¨¡çµ„ (çµæ§‹åŒ auth)
â”‚   â”œâ”€â”€ daily_log/               # æ—¥èªŒæ¨¡çµ„
â”‚   â”œâ”€â”€ survey/                  # å•å·æ¨¡çµ„
â”‚   â”œâ”€â”€ risk/                    # é¢¨éšªæ¨¡çµ„
â”‚   â”œâ”€â”€ rag/                     # è¡›æ•™æ¨¡çµ„
â”‚   â””â”€â”€ notification/            # é€šçŸ¥æ¨¡çµ„
â”‚
â”œâ”€â”€ shared/                      # å…±äº«åŸºç¤è¨­æ–½ (éæ¥­å‹™é‚è¼¯)
â”‚   â”œâ”€â”€ event_bus/               # äº‹ä»¶ç¸½ç·šå¯¦ç¾ (RabbitMQ å°è£)
â”‚   â”œâ”€â”€ database/                # æ•¸æ“šåº«é€£æ¥æ± 
â”‚   â”œâ”€â”€ cache/                   # Redis å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ logger/                  # æ—¥èªŒå·¥å…·
â”‚   â””â”€â”€ config/                  # é…ç½®ç®¡ç†
â”‚
â””â”€â”€ main.py                      # æ‡‰ç”¨å…¥å£ (ä¾è³´æ³¨å…¥å®¹å™¨)
```

**ç›®éŒ„çµæ§‹åŸå‰‡**:
1. âœ… æ¯å€‹æ¨¡çµ„å…§éƒ¨éµå¾ª **Clean Architecture å››å±¤åˆ†å±¤**ï¼ˆÂ§4.2ï¼‰
2. âœ… `domain/` å±¤å®Œå…¨ç¨ç«‹ï¼Œä¸ä¾è³´ä»»ä½•å¤–éƒ¨æ¡†æ¶
3. âœ… `infrastructure/` å±¤å¯¦ç¾ `domain/ports/` å®šç¾©çš„æ¥å£
4. âœ… `shared/` åƒ…åŒ…å«æŠ€è¡“æ€§åŸºç¤è¨­æ–½ï¼ˆéæ¥­å‹™é‚è¼¯ï¼‰

---

#### 4.1.6 æ¨¡çµ„ä¾è³´è¦å‰‡ (Module Dependency Rules)

**éµå¾‹ (Iron Rules)**:

| è¦å‰‡ | èªªæ˜ | ç¯„ä¾‹ |
|------|------|------|
| **No Direct Database Access** | æ¨¡çµ„ä¸å¯ç›´æ¥æŸ¥è©¢å…¶ä»–æ¨¡çµ„çš„è³‡æ–™è¡¨ | âŒ `SELECT * FROM patient_profiles WHERE ...` (åœ¨ daily_log æ¨¡çµ„ä¸­)<br/>âœ… `await patient_port.get_patient(patient_id)` |
| **No Circular Dependencies** | æ¨¡çµ„é–“ä¸å¯å¾ªç’°ä¾è³´ | âŒ `daily_log â†’ risk â†’ daily_log`<br/>âœ… `daily_log â†’ risk` (å–®å‘ä¾è³´) |
| **Event-Driven for Side Effects** | å‰¯ä½œç”¨è§¸ç™¼å¿…é ˆä½¿ç”¨äº‹ä»¶ | âŒ `await risk_service.calculate()` (åœ¨ daily_log ä¸­)<br/>âœ… `await event_bus.publish(DailyLogSubmittedEvent)` |
| **Core Domain Independence** | æ ¸å¿ƒåŸŸæ¨¡çµ„ä¸ä¾è³´æ”¯æ’å­åŸŸ | âŒ `daily_log â†’ survey`<br/>âœ… `risk â†’ daily_log, survey` |

**ä¾è³´æ–¹å‘æª¢æŸ¥**:

```python
# âœ… å…è¨±çš„ä¾è³´
daily_log â†’ patient  # æ”¯æ’å­åŸŸä¾è³´æ”¯æ’å­åŸŸ
risk â†’ daily_log     # æ ¸å¿ƒåŸŸä¾è³´æ ¸å¿ƒåŸŸ
risk â†’ patient       # æ ¸å¿ƒåŸŸä¾è³´æ”¯æ’å­åŸŸ
* â†’ auth             # æ‰€æœ‰æ¨¡çµ„ä¾è³´é€šç”¨å­åŸŸ

# âŒ ç¦æ­¢çš„ä¾è³´
patient â†’ risk       # æ”¯æ’å­åŸŸä¸å¯ä¾è³´æ ¸å¿ƒåŸŸ
daily_log â†’ risk     # é¿å…æ ¸å¿ƒåŸŸé–“é›™å‘ä¾è³´ï¼ˆä½¿ç”¨äº‹ä»¶ï¼‰
notification â†’ risk  # é€šç”¨å­åŸŸä¸å¯ä¾è³´æ ¸å¿ƒåŸŸï¼ˆä½¿ç”¨äº‹ä»¶ï¼‰
```

---

#### 4.1.7 æ¼”é€²ç­–ç•¥ (Evolution Strategy)

**å¾ Modular Monolith åˆ° Microservices çš„é·ç§»è·¯å¾‘**:

```mermaid
graph LR
    A[Phase 1<br/>Modular Monolith<br/>å–®ä¸€éƒ¨ç½²å–®å…ƒ] --> B[Phase 2<br/>Hybrid<br/>æ ¸å¿ƒåŸŸæ‹†åˆ†ç‚ºæœå‹™]
    B --> C[Phase 3<br/>Microservices<br/>å…¨é¢å¾®æœå‹™åŒ–]

    style A fill:#99ff99
    style B fill:#ffff99
    style C fill:#ff9999
```

| éšæ®µ | è§¸ç™¼æ¢ä»¶ | æ‹†åˆ†å„ªå…ˆç´š | ç†ç”± |
|------|----------|-----------|------|
| **Phase 1** (ç•¶å‰) | DAU < 100 | ä¿æŒ Monolith | ç°¡åŒ–é‹ç¶­ã€å¿«é€Ÿè¿­ä»£ |
| **Phase 2** | DAU > 500 æˆ–æ ¸å¿ƒåŸŸéœ€ç¨ç«‹æ“´å±• | å„ªå…ˆæ‹†åˆ† `risk` æ¨¡çµ„ | è¨ˆç®—å¯†é›†ï¼Œéœ€ç¨ç«‹æ“´å±• |
| **Phase 3** | DAU > 5000 æˆ–åœ˜éšŠ > 20 äºº | æ‹†åˆ†æ‰€æœ‰æ¨¡çµ„ | æ”¯æŒå¤§è¦æ¨¡å”ä½œ |

**æ‹†åˆ†æº–å‚™æ¸…å–®** (æ¯å€‹æ¨¡çµ„å·²å…·å‚™):
- âœ… æ¸…æ™°çš„ API æ¥å£å®šç¾© (`domain/ports/`)
- âœ… ç¨ç«‹çš„æ•¸æ“šæ‰€æœ‰æ¬Šï¼ˆç„¡è·¨æ¨¡çµ„ JOINï¼‰
- âœ… äº‹ä»¶é©…å‹•é€šä¿¡ï¼ˆä½è€¦åˆï¼‰
- âœ… å®Œæ•´çš„æ¸¬è©¦è¦†è“‹ï¼ˆä¿è­‰æ‹†åˆ†å¾ŒåŠŸèƒ½ä¸€è‡´ï¼‰

---

### 4.2 Clean Architecture å‚ç›´åˆ†å±¤è¨­è¨ˆ

æ¯å€‹ Modular Monolith æ¨¡çµ„å…§éƒ¨éµå¾ª **Clean Architecture** å››å±¤åˆ†å±¤ï¼Œç¢ºä¿æ¥­å‹™é‚è¼¯èˆ‡æŠ€è¡“å¯¦ç¾çš„å®Œå…¨éš”é›¢ã€‚

#### 4.2.1 åˆ†å±¤æ¦‚è¦½åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¡¨ç¾å±¤ (Presentation Layer)                    â”‚
â”‚  - FastAPI Routers                              â”‚
â”‚  - WebSocket Endpoints                          â”‚
â”‚  - Pydantic Request/Response Schemas            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (èª¿ç”¨ç”¨ä¾‹)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‡‰ç”¨å±¤ (Application Layer)                     â”‚
â”‚  - Use Cases / Application Services             â”‚
â”‚  - DTOs (Data Transfer Objects)                 â”‚
â”‚  - Orchestration & Transaction Control          â”‚
â”‚  - Event Handlers                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (ç·¨æ’é ˜åŸŸå°è±¡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é ˜åŸŸå±¤ (Domain Layer) - æ ¸å¿ƒæ¥­å‹™é‚è¼¯           â”‚
â”‚  - Entities, Value Objects                      â”‚
â”‚  - Aggregates, Domain Services                  â”‚
â”‚  - Domain Events                                â”‚
â”‚  - Business Rules & Invariants                  â”‚
â”‚  - Ports (æ¥å£å®šç¾©)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (ä¾è³´åè½‰)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºç¤è¨­æ–½å±¤ (Infrastructure Layer)              â”‚
â”‚  - Repositories (SQLAlchemy å¯¦ç¾)               â”‚
â”‚  - External Adapters (LINE, OpenAI, RabbitMQ)   â”‚
â”‚  - Persistence Models (ORM)                     â”‚
â”‚  - Event Bus Implementation                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.2 åˆ†å±¤è·è²¬è©³è§£

##### **ç¬¬ 1 å±¤ï¼šè¡¨ç¾å±¤ (Presentation Layer)**

**è·è²¬**:
- è™•ç† HTTP/WebSocket è«‹æ±‚èˆ‡éŸ¿æ‡‰
- é©—è­‰è¼¸å…¥æ ¼å¼ï¼ˆPydantic Schemaï¼‰
- èª¿ç”¨æ‡‰ç”¨å±¤ç”¨ä¾‹
- è™•ç†ç•°å¸¸ä¸¦è¿”å›é©ç•¶çš„ HTTP ç‹€æ…‹ç¢¼

**æŠ€è¡“æ£§**: FastAPI, Pydantic, WebSocket

**ç¯„ä¾‹** (daily_log æ¨¡çµ„):

```python
# modules/daily_log/presentation/routers/daily_log_router.py
from fastapi import APIRouter, Depends, HTTPException, status
from uuid import UUID
from modules.daily_log.presentation.schemas import SubmitDailyLogRequest, DailyLogResponse
from modules.daily_log.application.use_cases import SubmitDailyLogUseCase
from shared.auth import get_current_user

router = APIRouter(prefix="/daily-logs", tags=["Daily Logs"])

@router.post("/", response_model=DailyLogResponse, status_code=status.HTTP_201_CREATED)
async def submit_daily_log(
    request: SubmitDailyLogRequest,
    current_user: dict = Depends(get_current_user),
    use_case: SubmitDailyLogUseCase = Depends()
):
    """æäº¤æ¯æ—¥å¥åº·æ—¥èªŒ"""
    try:
        result = await use_case.execute(
            patient_id=current_user["user_id"],
            log_date=request.log_date,
            medication_taken=request.medication_taken,
            water_intake_ml=request.water_intake_ml,
            symptoms=request.symptoms
        )
        return DailyLogResponse.from_domain(result)
    except ValueError as e:
        raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, detail=str(e))
    except Exception as e:
        raise HTTPException(status_code=status.HTTP_500_INTERNAL_SERVER_ERROR, detail="Internal error")
```

```python
# modules/daily_log/presentation/schemas.py
from pydantic import BaseModel, Field
from datetime import date
from typing import Optional

class SubmitDailyLogRequest(BaseModel):
    log_date: date = Field(..., description="æ—¥èªŒæ—¥æœŸ (YYYY-MM-DD)")
    medication_taken: bool = Field(..., description="æ˜¯å¦å·²æœè—¥")
    water_intake_ml: int = Field(..., ge=0, le=5000, description="å–æ°´é‡ (ml)")
    symptoms: Optional[str] = Field(None, max_length=500, description="ç—‡ç‹€æè¿°")

    class Config:
        json_schema_extra = {
            "example": {
                "log_date": "2025-10-18",
                "medication_taken": True,
                "water_intake_ml": 2000,
                "symptoms": "ä»Šå¤©å’³å—½è¼ƒå°‘"
            }
        }
```

---

##### **ç¬¬ 2 å±¤ï¼šæ‡‰ç”¨å±¤ (Application Layer)**

**è·è²¬**:
- ç·¨æ’ç”¨ä¾‹æµç¨‹ï¼ˆUse Case Orchestrationï¼‰
- å”èª¿å¤šå€‹é ˜åŸŸå°è±¡å®Œæˆæ¥­å‹™æ“ä½œ
- ç®¡ç†äº‹å‹™é‚Šç•Œï¼ˆTransaction Boundaryï¼‰
- ç™¼å¸ƒé ˜åŸŸäº‹ä»¶åˆ°äº‹ä»¶ç¸½ç·š
- ä¸åŒ…å«æ¥­å‹™è¦å‰‡ï¼ˆæ¥­å‹™è¦å‰‡å±¬æ–¼é ˜åŸŸå±¤ï¼‰

**æŠ€è¡“æ£§**: ç´” Python é¡åˆ¥ï¼Œä¾è³´æ³¨å…¥

**ç¯„ä¾‹** (daily_log æ¨¡çµ„):

```python
# modules/daily_log/application/use_cases/submit_daily_log.py
from dataclasses import dataclass
from datetime import date
from uuid import UUID
from typing import Optional

from modules.daily_log.domain.entities import DailyLog
from modules.daily_log.domain.ports import IDailyLogRepository, IPatientPort
from modules.daily_log.domain.events import DailyLogSubmittedEvent
from shared.event_bus import IEventBus

@dataclass
class SubmitDailyLogCommand:
    patient_id: UUID
    log_date: date
    medication_taken: bool
    water_intake_ml: int
    symptoms: Optional[str]

class SubmitDailyLogUseCase:
    def __init__(
        self,
        daily_log_repo: IDailyLogRepository,
        patient_port: IPatientPort,
        event_bus: IEventBus
    ):
        self.daily_log_repo = daily_log_repo
        self.patient_port = patient_port
        self.event_bus = event_bus

    async def execute(self, command: SubmitDailyLogCommand) -> DailyLog:
        # Step 1: é©—è­‰æ‚£è€…å­˜åœ¨ï¼ˆè·¨æ¨¡çµ„èª¿ç”¨ï¼‰
        if not await self.patient_port.verify_patient_exists(command.patient_id):
            raise ValueError(f"Patient {command.patient_id} not found")

        # Step 2: æª¢æŸ¥ç•¶æ—¥æ˜¯å¦å·²æäº¤
        existing_log = await self.daily_log_repo.find_by_patient_and_date(
            command.patient_id, command.log_date
        )
        if existing_log:
            raise ValueError(f"Log for {command.log_date} already exists")

        # Step 3: å‰µå»ºé ˜åŸŸå°è±¡ï¼ˆæ¥­å‹™è¦å‰‡åœ¨é ˜åŸŸå±¤åŸ·è¡Œï¼‰
        daily_log = DailyLog.create(
            patient_id=command.patient_id,
            log_date=command.log_date,
            medication_taken=command.medication_taken,
            water_intake_ml=command.water_intake_ml,
            symptoms=command.symptoms
        )

        # Step 4: æŒä¹…åŒ–ï¼ˆé€šéå€‰å„²æ¥å£ï¼‰
        saved_log = await self.daily_log_repo.save(daily_log)

        # Step 5: ç™¼å¸ƒé ˜åŸŸäº‹ä»¶ï¼ˆç•°æ­¥è§¸ç™¼é¢¨éšªè¨ˆç®—ï¼‰
        event = DailyLogSubmittedEvent(
            patient_id=saved_log.patient_id,
            log_date=saved_log.log_date,
            medication_taken=saved_log.medication_taken,
            occurred_at=datetime.utcnow()
        )
        await self.event_bus.publish(event)

        return saved_log
```

---

##### **ç¬¬ 3 å±¤ï¼šé ˜åŸŸå±¤ (Domain Layer) - æ ¸å¿ƒæ¥­å‹™é‚è¼¯**

**è·è²¬**:
- å¯¦ç¾æ¥­å‹™è¦å‰‡èˆ‡ä¸è®Šé‡ï¼ˆInvariantsï¼‰
- å®šç¾©å¯¦é«”ï¼ˆEntityï¼‰ã€å€¼å°è±¡ï¼ˆValue Objectï¼‰ã€èšåˆï¼ˆAggregateï¼‰
- å®šç¾©é ˜åŸŸæœå‹™ï¼ˆDomain Serviceï¼‰èˆ‡é ˜åŸŸäº‹ä»¶ï¼ˆDomain Eventï¼‰
- å®šç¾©æ¥å£ï¼ˆPortsï¼‰ï¼Œç”±åŸºç¤è¨­æ–½å±¤å¯¦ç¾
- **å®Œå…¨ç¨ç«‹**ï¼Œä¸ä¾è³´ä»»ä½•å¤–éƒ¨æ¡†æ¶

**æŠ€è¡“æ£§**: ç´” Python é¡åˆ¥ï¼Œç„¡å¤–éƒ¨ä¾è³´

**ç¯„ä¾‹** (daily_log æ¨¡çµ„):

```python
# modules/daily_log/domain/entities/daily_log.py
from dataclasses import dataclass, field
from datetime import date, datetime
from uuid import UUID, uuid4
from typing import Optional

@dataclass
class DailyLog:
    """æ¯æ—¥å¥åº·æ—¥èªŒèšåˆæ ¹"""
    log_id: UUID = field(default_factory=uuid4)
    patient_id: UUID = field()
    log_date: date = field()
    medication_taken: bool = field()
    water_intake_ml: int = field()
    symptoms: Optional[str] = field(default=None)
    created_at: datetime = field(default_factory=datetime.utcnow)

    @classmethod
    def create(
        cls,
        patient_id: UUID,
        log_date: date,
        medication_taken: bool,
        water_intake_ml: int,
        symptoms: Optional[str]
    ) -> "DailyLog":
        """å·¥å» æ–¹æ³•ï¼šå‰µå»ºæ—¥èªŒä¸¦é©—è­‰æ¥­å‹™è¦å‰‡"""
        # æ¥­å‹™è¦å‰‡ 1: å–æ°´é‡å¿…é ˆåœ¨åˆç†ç¯„åœ
        if not (0 <= water_intake_ml <= 5000):
            raise ValueError("Water intake must be between 0 and 5000 ml")

        # æ¥­å‹™è¦å‰‡ 2: ç—‡ç‹€æè¿°ä¸å¯éé•·
        if symptoms and len(symptoms) > 500:
            raise ValueError("Symptoms description must be <= 500 characters")

        # æ¥­å‹™è¦å‰‡ 3: æ—¥èªŒæ—¥æœŸä¸å¯ç‚ºæœªä¾†
        if log_date > date.today():
            raise ValueError("Cannot create log for future dates")

        return cls(
            patient_id=patient_id,
            log_date=log_date,
            medication_taken=medication_taken,
            water_intake_ml=water_intake_ml,
            symptoms=symptoms
        )

    def update_medication_status(self, taken: bool) -> None:
        """æ›´æ–°ç”¨è—¥ç‹€æ…‹ï¼ˆé ˜åŸŸè¡Œç‚ºï¼‰"""
        self.medication_taken = taken
```

```python
# modules/daily_log/domain/ports/daily_log_repository.py
from abc import ABC, abstractmethod
from uuid import UUID
from datetime import date
from typing import Optional, List
from modules.daily_log.domain.entities import DailyLog

class IDailyLogRepository(ABC):
    """æ—¥èªŒå€‰å„²æ¥å£ï¼ˆPortï¼‰ï¼Œç”±åŸºç¤è¨­æ–½å±¤å¯¦ç¾"""

    @abstractmethod
    async def save(self, daily_log: DailyLog) -> DailyLog:
        """ä¿å­˜æ—¥èªŒ"""
        pass

    @abstractmethod
    async def find_by_id(self, log_id: UUID) -> Optional[DailyLog]:
        """æ ¹æ“š ID æŸ¥è©¢"""
        pass

    @abstractmethod
    async def find_by_patient_and_date(
        self, patient_id: UUID, log_date: date
    ) -> Optional[DailyLog]:
        """æŸ¥è©¢æ‚£è€…åœ¨ç‰¹å®šæ—¥æœŸçš„æ—¥èªŒ"""
        pass

    @abstractmethod
    async def find_recent_logs(
        self, patient_id: UUID, days: int = 7
    ) -> List[DailyLog]:
        """æŸ¥è©¢è¿‘æœŸæ—¥èªŒ"""
        pass
```

```python
# modules/daily_log/domain/events.py
from dataclasses import dataclass
from datetime import datetime, date
from uuid import UUID

@dataclass
class DailyLogSubmittedEvent:
    """é ˜åŸŸäº‹ä»¶ï¼šæ—¥èªŒå·²æäº¤"""
    patient_id: UUID
    log_date: date
    medication_taken: bool
    occurred_at: datetime
```

---

##### **ç¬¬ 4 å±¤ï¼šåŸºç¤è¨­æ–½å±¤ (Infrastructure Layer)**

**è·è²¬**:
- å¯¦ç¾é ˜åŸŸå±¤å®šç¾©çš„æ¥å£ï¼ˆPortsï¼‰
- æä¾›æŠ€è¡“ç´°ç¯€å¯¦ç¾ï¼ˆæ•¸æ“šåº«ã€å¤–éƒ¨ APIã€æ¶ˆæ¯éšŠåˆ—ï¼‰
- ORM æ¨¡å‹ï¼ˆSQLAlchemy Modelsï¼‰èˆ‡é ˜åŸŸå¯¦é«”çš„è½‰æ›
- ä¾è³´å¤–éƒ¨æ¡†æ¶ï¼ˆFastAPI, SQLAlchemy, Pika, Redisï¼‰

**æŠ€è¡“æ£§**: SQLAlchemy, asyncpg, Pika, httpx, Redis

**ç¯„ä¾‹** (daily_log æ¨¡çµ„):

```python
# modules/daily_log/infrastructure/persistence/models.py
from sqlalchemy import Column, String, Date, Boolean, Integer, Text, TIMESTAMP
from sqlalchemy.dialects.postgresql import UUID
from shared.database import Base
import uuid

class DailyLogModel(Base):
    """SQLAlchemy ORM æ¨¡å‹ï¼ˆåŸºç¤è¨­æ–½å±¤ï¼‰"""
    __tablename__ = "daily_logs"

    log_id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    patient_id = Column(UUID(as_uuid=True), nullable=False, index=True)
    log_date = Column(Date, nullable=False)
    medication_taken = Column(Boolean, nullable=False)
    water_intake_ml = Column(Integer, nullable=False)
    symptoms = Column(Text, nullable=True)
    created_at = Column(TIMESTAMP(timezone=True), nullable=False)
```

```python
# modules/daily_log/infrastructure/repositories/daily_log_repository.py
from typing import Optional, List
from uuid import UUID
from datetime import date
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from modules.daily_log.domain.entities import DailyLog
from modules.daily_log.domain.ports import IDailyLogRepository
from modules.daily_log.infrastructure.persistence.models import DailyLogModel

class DailyLogRepository(IDailyLogRepository):
    """å€‰å„²å¯¦ç¾ï¼ˆåŸºç¤è¨­æ–½å±¤ï¼‰"""

    def __init__(self, session: AsyncSession):
        self.session = session

    async def save(self, daily_log: DailyLog) -> DailyLog:
        model = DailyLogModel(
            log_id=daily_log.log_id,
            patient_id=daily_log.patient_id,
            log_date=daily_log.log_date,
            medication_taken=daily_log.medication_taken,
            water_intake_ml=daily_log.water_intake_ml,
            symptoms=daily_log.symptoms,
            created_at=daily_log.created_at
        )
        self.session.add(model)
        await self.session.commit()
        await self.session.refresh(model)
        return self._to_domain(model)

    async def find_by_patient_and_date(
        self, patient_id: UUID, log_date: date
    ) -> Optional[DailyLog]:
        stmt = select(DailyLogModel).where(
            DailyLogModel.patient_id == patient_id,
            DailyLogModel.log_date == log_date
        )
        result = await self.session.execute(stmt)
        model = result.scalar_one_or_none()
        return self._to_domain(model) if model else None

    @staticmethod
    def _to_domain(model: DailyLogModel) -> DailyLog:
        """ORM æ¨¡å‹è½‰æ›ç‚ºé ˜åŸŸå¯¦é«”"""
        return DailyLog(
            log_id=model.log_id,
            patient_id=model.patient_id,
            log_date=model.log_date,
            medication_taken=model.medication_taken,
            water_intake_ml=model.water_intake_ml,
            symptoms=model.symptoms,
            created_at=model.created_at
        )
```

---

#### 4.2.3 ä¾è³´åè½‰å¯¦è¸ (Dependency Inversion Principle)

**æ ¸å¿ƒåŸå‰‡**: é«˜å±¤æ¨¡çµ„ï¼ˆé ˜åŸŸå±¤ã€æ‡‰ç”¨å±¤ï¼‰ä¸ä¾è³´ä½å±¤æ¨¡çµ„ï¼ˆåŸºç¤è¨­æ–½å±¤ï¼‰ï¼Œå…©è€…éƒ½ä¾è³´æŠ½è±¡ï¼ˆæ¥å£ï¼‰ã€‚

**ä¾è³´æµå‘åœ–**:

```mermaid
graph TB
    subgraph "é«˜å±¤æ¨¡çµ„ (High-Level)"
        Domain[é ˜åŸŸå±¤<br/>DailyLog Entity]
        Application[æ‡‰ç”¨å±¤<br/>SubmitDailyLogUseCase]
    end

    subgraph "æŠ½è±¡å±¤ (Abstraction)"
        Port[æ¥å£å®šç¾©<br/>IDailyLogRepository]
    end

    subgraph "ä½å±¤æ¨¡çµ„ (Low-Level)"
        Infra[åŸºç¤è¨­æ–½å±¤<br/>DailyLogRepository<br/>SQLAlchemy å¯¦ç¾]
    end

    Application -->|ä½¿ç”¨| Domain
    Application -->|ä¾è³´| Port
    Domain -->|å®šç¾©| Port
    Infra -->|å¯¦ç¾| Port

    style Domain fill:#ff9999
    style Application fill:#99ccff
    style Port fill:#ffff99
    style Infra fill:#99ff99
```

**ä¾è³´æ³¨å…¥å¯¦ä¾‹** (åœ¨ `main.py` ä¸­):

```python
# backend/main.py
from fastapi import FastAPI, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from modules.daily_log.application.use_cases import SubmitDailyLogUseCase
from modules.daily_log.infrastructure.repositories import DailyLogRepository
from modules.patient.infrastructure.adapters import PatientAdapter
from shared.database import get_db_session
from shared.event_bus import get_event_bus

app = FastAPI()

# ä¾è³´æ³¨å…¥å®¹å™¨
def get_submit_daily_log_use_case(
    db_session: AsyncSession = Depends(get_db_session)
) -> SubmitDailyLogUseCase:
    daily_log_repo = DailyLogRepository(db_session)
    patient_port = PatientAdapter(db_session)
    event_bus = get_event_bus()

    return SubmitDailyLogUseCase(
        daily_log_repo=daily_log_repo,
        patient_port=patient_port,
        event_bus=event_bus
    )

# è¨»å†Šè·¯ç”±
from modules.daily_log.presentation.routers import daily_log_router
app.include_router(daily_log_router)
```

---

#### 4.2.4 åˆ†å±¤è¦å‰‡æª¢æŸ¥æ¸…å–®

| è¦å‰‡ | æª¢æŸ¥é …ç›® | ç¯„ä¾‹ |
|------|----------|------|
| **é ˜åŸŸå±¤ç¨ç«‹æ€§** | é ˜åŸŸå±¤ä¸å¯ import ä»»ä½•å¤–éƒ¨æ¡†æ¶ | âŒ `from fastapi import Request`<br/>âœ… `from uuid import UUID` |
| **ä¾è³´æ–¹å‘æ­£ç¢º** | å¤–å±¤ä¾è³´å…§å±¤ï¼Œå…§å±¤ä¸ä¾è³´å¤–å±¤ | âœ… `Application â†’ Domain`<br/>âŒ `Domain â†’ Infrastructure` |
| **æ¥å£åœ¨é ˜åŸŸå±¤** | Repository/Service æ¥å£å®šç¾©åœ¨ `domain/ports/` | âœ… `domain/ports/daily_log_repository.py`<br/>âŒ `infrastructure/repositories/interface.py` |
| **æ¥­å‹™è¦å‰‡åœ¨é ˜åŸŸå±¤** | é©—è­‰é‚è¼¯åœ¨ Entity/Value Object ä¸­ | âœ… `DailyLog.create()` é©—è­‰å–æ°´é‡<br/>âŒ åœ¨ FastAPI Router ä¸­é©—è­‰ |
| **ç”¨ä¾‹ç·¨æ’åœ¨æ‡‰ç”¨å±¤** | å¤šå€‹é ˜åŸŸå°è±¡çš„å”èª¿åœ¨ Use Case ä¸­ | âœ… `SubmitDailyLogUseCase` å”èª¿ Repository + Event Bus<br/>âŒ åœ¨ Entity ä¸­èª¿ç”¨ Repository |

---

#### 4.2.5 æ¸¬è©¦ç­–ç•¥

åŸºæ–¼åˆ†å±¤æ¶æ§‹ï¼Œæ¯å±¤æœ‰ä¸åŒçš„æ¸¬è©¦ç­–ç•¥ï¼š

| å±¤ç´š | æ¸¬è©¦é¡å‹ | æ¸¬è©¦é‡é» | Mock å°è±¡ |
|------|----------|----------|-----------|
| **é ˜åŸŸå±¤** | å–®å…ƒæ¸¬è©¦ (Unit Test) | æ¥­å‹™è¦å‰‡ã€ä¸è®Šé‡é©—è­‰ | ç„¡éœ€ Mockï¼ˆç´”é‚è¼¯ï¼‰ |
| **æ‡‰ç”¨å±¤** | å–®å…ƒæ¸¬è©¦ + æ•´åˆæ¸¬è©¦ | ç”¨ä¾‹ç·¨æ’ã€äº‹å‹™æ§åˆ¶ | Mock Repository, Event Bus |
| **åŸºç¤è¨­æ–½å±¤** | æ•´åˆæ¸¬è©¦ (Integration Test) | æ•¸æ“šåº«æ“ä½œã€å¤–éƒ¨ API | ä½¿ç”¨æ¸¬è©¦æ•¸æ“šåº«/Mock Server |
| **è¡¨ç¾å±¤** | API æ¸¬è©¦ (E2E Test) | HTTP è«‹æ±‚/éŸ¿æ‡‰ã€éŒ¯èª¤è™•ç† | ä½¿ç”¨æ¸¬è©¦å®¢æˆ¶ç«¯ (TestClient) |

**ç¯„ä¾‹** (é ˜åŸŸå±¤å–®å…ƒæ¸¬è©¦):

```python
# tests/unit/domain/test_daily_log.py
import pytest
from datetime import date, timedelta
from modules.daily_log.domain.entities import DailyLog

def test_create_daily_log_with_valid_data():
    log = DailyLog.create(
        patient_id=uuid4(),
        log_date=date.today(),
        medication_taken=True,
        water_intake_ml=2000,
        symptoms="ä»Šå¤©å’³å—½è¼ƒå°‘"
    )
    assert log.medication_taken is True
    assert log.water_intake_ml == 2000

def test_create_daily_log_with_invalid_water_intake():
    with pytest.raises(ValueError, match="Water intake must be between 0 and 5000 ml"):
        DailyLog.create(
            patient_id=uuid4(),
            log_date=date.today(),
            medication_taken=True,
            water_intake_ml=10000,  # è¶…å‡ºç¯„åœ
            symptoms=None
        )

def test_cannot_create_future_log():
    with pytest.raises(ValueError, match="Cannot create log for future dates"):
        DailyLog.create(
            patient_id=uuid4(),
            log_date=date.today() + timedelta(days=1),  # æœªä¾†æ—¥æœŸ
            medication_taken=True,
            water_intake_ml=2000,
            symptoms=None
        )
```

---

### 4.3 æ¨¡çµ„é–“é€šä¿¡æ©Ÿåˆ¶ (Inter-Module Communication)

Modular Monolith æ¶æ§‹ä¸­ï¼Œæ¨¡çµ„é–“é€šä¿¡æ©Ÿåˆ¶çš„é¸æ“‡ç›´æ¥å½±éŸ¿ç³»çµ±çš„è€¦åˆåº¦èˆ‡å¯ç¶­è­·æ€§ã€‚æˆ‘å€‘æ¡ç”¨**æ··åˆç­–ç•¥**ï¼šåŒæ­¥èª¿ç”¨è™•ç†å³æ™‚æ€§éœ€æ±‚ï¼Œç•°æ­¥äº‹ä»¶è™•ç†è§£è€¦èˆ‡æ“´å±•éœ€æ±‚ã€‚

#### 4.3.1 åŒæ­¥é€šä¿¡ï¼ˆAdapter Patternï¼‰

**é©ç”¨å ´æ™¯**: éœ€è¦å³æ™‚éŸ¿æ‡‰çš„è·¨æ¨¡çµ„èª¿ç”¨ï¼ˆå¦‚é©—è­‰ã€æŸ¥è©¢ï¼‰ã€‚

**å¯¦ç¾æ–¹å¼**: é€šé Port-Adapter æ¨¡å¼å¯¦ç¾ä¾è³´åè½‰ã€‚

```python
# daily_log/domain/ports/patient_port.py (å®šç¾©æ¥å£)
class PatientPort(ABC):
    @abstractmethod
    def get_patient_info(self, patient_id: str) -> PatientInfo:
        pass

# patient/application/adapters/patient_adapter.py (å¯¦ç¾æ¥å£)
class PatientAdapter(PatientPort):
    def get_patient_info(self, patient_id: str) -> PatientInfo:
        # èª¿ç”¨ patient æ¨¡çµ„çš„æœå‹™
        return patient_service.get_by_id(patient_id)
```

#### 4.3.2 ç•°æ­¥é€šä¿¡ï¼ˆEvent-Driven Patternï¼‰

**é©ç”¨å ´æ™¯**: éå³æ™‚æ€§æ“ä½œã€éœ€è§£è€¦çš„è·¨æ¨¡çµ„å”ä½œï¼ˆå¦‚é¢¨éšªè¨ˆç®—ã€é€šçŸ¥ç™¼é€ï¼‰ã€‚

**æ ¸å¿ƒçµ„ä»¶**:
- **Event Bus**: äº‹ä»¶åˆ†ç™¼ä¸­å¿ƒï¼ˆMVP ä½¿ç”¨ in-memoryï¼Œæœªä¾†å¯å‡ç´šç‚º RabbitMQï¼‰
- **Domain Events**: é ˜åŸŸäº‹ä»¶ï¼ˆè¨˜éŒ„æ¥­å‹™é—œéµæ“ä½œï¼‰
- **Event Handlers**: äº‹ä»¶è™•ç†å™¨ï¼ˆè¨‚é–±ä¸¦è™•ç†äº‹ä»¶ï¼‰
- **Event Store**: äº‹ä»¶å­˜å„²ï¼ˆæŒä¹…åŒ–äº‹ä»¶ï¼Œæ”¯æŒå¯©è¨ˆèˆ‡é‡æ”¾ï¼‰

##### é ˜åŸŸäº‹ä»¶ç›®éŒ„ (Domain Events)

**äº‹ä»¶å‘½åè¦ç¯„**: `{æ¨¡çµ„å}{èšåˆå}{å‹•ä½œéå»å¼}` (ä¾‹: `DailyLogSubmitted`)

**æ ¸å¿ƒäº‹ä»¶æ¸…å–®**:

| æ¨¡çµ„ | äº‹ä»¶åç¨± | è§¸ç™¼æ™‚æ©Ÿ | è¨‚é–±è€… |
|------|----------|----------|--------|
| daily_log | `DailyLogSubmitted` | æ‚£è€…æäº¤æ—¥èªŒ | risk, notification |
| questionnaire | `QuestionnaireCompleted` | å•å·å®Œæˆ | risk, analytics |
| risk | `RiskScoreCalculated` | é¢¨éšªåˆ†æ•¸è¨ˆç®—å®Œæˆ | notification, analytics |
| risk | `RiskLevelElevated` | é¢¨éšªç­‰ç´šæå‡ | notification, therapist_dashboard |
| ai_chat | `ChatSessionCompleted` | AI å°è©±å®Œæˆ | analytics, risk |

**å®Œæ•´äº‹ä»¶ç›®éŒ„**: åƒè¦‹ [é™„éŒ„ C: äº‹ä»¶é©…å‹•å¯¦ä½œç¯„ä¾‹](#é™„éŒ„-c-äº‹ä»¶é©…å‹•å¯¦ä½œç¯„ä¾‹)

##### Event Bus æ¶æ§‹è¨­è¨ˆ

**MVP éšæ®µ**: ä½¿ç”¨ in-memory Event Busï¼ˆPython `asyncio.Queue`ï¼‰
**æœªä¾†æ¼”é€²**: å‡ç´šç‚º RabbitMQï¼ˆæ”¯æŒåˆ†æ•£å¼éƒ¨ç½²èˆ‡é«˜å¯ç”¨ï¼‰

```python
# shared/event_bus/interface.py
class EventBus(ABC):
    @abstractmethod
    async def publish(self, event: DomainEvent) -> None:
        """ç™¼å¸ƒäº‹ä»¶"""
        pass

    @abstractmethod
    async def subscribe(self, event_type: str, handler: Callable) -> None:
        """è¨‚é–±äº‹ä»¶"""
        pass
```

**RabbitMQ æ¶æ§‹** (æœªä¾†):
- Exchange é¡å‹: Topic Exchange
- Routing Key: `{module}.{aggregate}.{action}`
- DLQ: æ”¯æŒå¤±æ•—é‡è©¦èˆ‡æ­»ä¿¡éšŠåˆ—

è©³ç´°è¨­è¨ˆåƒè¦‹ [é™„éŒ„ C](#é™„éŒ„-c-äº‹ä»¶é©…å‹•å¯¦ä½œç¯„ä¾‹)ã€‚

##### Event Store è¨­è¨ˆ

**ç”¨é€”**: æŒä¹…åŒ–æ‰€æœ‰é ˜åŸŸäº‹ä»¶ï¼Œæ”¯æŒï¼š
- å¯©è¨ˆè¿½è¹¤ï¼ˆWho did What Whenï¼‰
- äº‹ä»¶é‡æ”¾ï¼ˆé‡å»ºèšåˆç‹€æ…‹ï¼‰
- æ•¸æ“šåŒæ­¥ï¼ˆè·¨æ¨¡çµ„æ•¸æ“šæœ€çµ‚ä¸€è‡´æ€§ï¼‰

**Outbox Pattern**: ç¢ºä¿äº‹ä»¶èˆ‡æ¥­å‹™æ“ä½œçš„äº‹å‹™æ€§
```sql
CREATE TABLE event_store (
    id UUID PRIMARY KEY,
    event_type VARCHAR(255) NOT NULL,
    aggregate_id VARCHAR(255) NOT NULL,
    payload JSONB NOT NULL,
    published BOOLEAN DEFAULT FALSE,  -- Outbox Pattern
    occurred_at TIMESTAMP DEFAULT NOW()
);
```

#### 4.3.3 é€šä¿¡æ©Ÿåˆ¶é¸æ“‡æŒ‡å—

| å ´æ™¯ | æ¨è–¦æ©Ÿåˆ¶ | ç†ç”± |
|------|----------|------|
| é©—è­‰æ‚£è€…æ˜¯å¦å­˜åœ¨ | åŒæ­¥èª¿ç”¨ (Adapter) | éœ€å³æ™‚å›æ‡‰ |
| æŸ¥è©¢æ‚£è€…åŸºæœ¬è³‡æ–™ | åŒæ­¥èª¿ç”¨ (Adapter) | è®€æ“ä½œï¼Œç„¡å‰¯ä½œç”¨ |
| æ—¥èªŒæäº¤è§¸ç™¼é¢¨éšªè¨ˆç®— | ç•°æ­¥äº‹ä»¶ | éé—œéµè·¯å¾‘ï¼Œå¯è§£è€¦ |
| é¢¨éšªæå‡é€šçŸ¥æ²»ç™‚å¸« | ç•°æ­¥äº‹ä»¶ | é€šçŸ¥å¯å®¹å¿å»¶é² |
| AI å°è©±å®Œæˆå¾Œæ›´æ–°è¨˜æ†¶ | ç•°æ­¥äº‹ä»¶ | é¿å…é˜»å¡å°è©±æµç¨‹ |

---

## 5. æ•¸æ“šæ¶æ§‹ (Data Architecture)

æœ¬ç« ç¯€è©³è¿° RespiraAlly V2.0 çš„æ•¸æ“šæ¶æ§‹ï¼ŒåŒ…å«æ ¸å¿ƒæ•¸æ“šæ¨¡å‹ã€é—œéµæ•¸æ“šæµã€ä¸€è‡´æ€§ç­–ç•¥ä»¥åŠæ•¸æ“šç”Ÿå‘½é€±æœŸç®¡ç†ï¼Œç¢ºä¿æ•¸æ“šçš„å®Œæ•´æ€§ã€å¯ç”¨æ€§èˆ‡åˆè¦æ€§ã€‚

**ğŸ“„ å®Œæ•´è³‡æ–™åº«è¨­è¨ˆæ–‡æª”**: è©³ç´°çš„è¡¨çµæ§‹ã€ç´¢å¼•ã€ç´„æŸã€è§¸ç™¼å™¨ã€å­˜å„²éç¨‹ã€è¦–åœ–è¨­è¨ˆè«‹åƒé–±:
- **[Database Schema Design v1.0](./database/schema_design_v1.0.md)** - å¯¦ä½œå±¤ç´šå®Œæ•´è¨­è¨ˆ

### 5.1 æ ¸å¿ƒå¯¦é«”é—œä¿‚åœ– (Core Entity-Relationship Diagram)

ä»¥ä¸‹ ER åœ–æä¾›ç³»çµ±æ ¸å¿ƒæ•¸æ“šæ¨¡å‹çš„æ¦‚è¦½ã€‚è©³ç´°çš„è¡¨å®šç¾©ã€æ¬„ä½ç´„æŸã€ç´¢å¼•ç­–ç•¥è«‹åƒé–±ä¸Šè¿°å®Œæ•´è¨­è¨ˆæ–‡æª”ã€‚

ä»¥ä¸‹ ER åœ–å±•ç¤ºäº†ç³»çµ±ä¸­æ ¸å¿ƒæ¥­å‹™å¯¦é«”åŠå…¶é—œä¿‚ï¼Œé€™äº›å¯¦é«”ä¸»è¦å„²å­˜åœ¨ PostgreSQL è³‡æ–™åº«ä¸­ã€‚

**ğŸ”„ é‡è¦è®Šæ›´** (åŸºæ–¼æ¶æ§‹å¯©è¦–å ±å‘Š):
- âœ… **å„ªåŒ– USERS è¡¨ç¹¼æ‰¿æ¨¡å¼** - `PATIENT_PROFILES` èˆ‡ `THERAPIST_PROFILES` ç›´æ¥ä½¿ç”¨ `user_id` ä½œç‚º PK
- âœ… **æ–°å¢ `EVENT_LOGS` è¡¨** - ä½¿ç”¨ PostgreSQL JSONB æ›¿ä»£ MongoDB
- âœ… **æ–°å¢ `PATIENT_KPI_CACHE` è¡¨** - åæ­£è¦åŒ–åŠ é€ŸæŸ¥è©¢
- âœ… **æ–°å¢ `NOTIFICATION_HISTORY` è¡¨** - è¿½è¹¤é€šçŸ¥ç‹€æ…‹

```mermaid
erDiagram
    USERS {
        uuid user_id PK
        string line_user_id UK "Nullable for PATIENT"
        string email UK "Nullable for THERAPIST"
        string hashed_password "Nullable for LINE OAuth"
        enum role "PATIENT or THERAPIST"
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at "Soft delete"
    }

    PATIENTS {
        string patient_id PK "FK to USERS.user_id"
        string therapist_id FK "Assigned Therapist"
        string name "Patient Name"
        date birth_date
        string hospital_medical_record_number "ç—…æ­·è™Ÿ"
        integer height_cm "èº«é«˜ cm"
        decimal weight_kg "é«”é‡ kg"
        enum smoking_status "NEVER, FORMER, CURRENT"
        integer smoking_years "å¸è¸å¹´æ•¸"
        jsonb medical_history "COPD stage, comorbidities"
        jsonb contact_info "Phone, address"
    }

    THERAPISTS {
        string therapist_id PK "FK to USERS.user_id"
        string name "Therapist Name"
        string institution "Hospital/Clinic"
    }

    DAILY_LOGS {
        uuid log_id PK
        string patient_id FK
        date log_date
        boolean medication_taken
        integer water_intake_ml
        string symptoms
        datetime created_at
    }

    SURVEY_RESPONSES {
        uuid response_id PK
        string survey_name "e.g., CAT, mMRC"
        string patient_id FK
        jsonb answers
        datetime submitted_at
    }

    RISK_SCORES {
        uuid score_id PK
        string patient_id FK
        integer score "0-100"
        string score_level "LOW, MEDIUM, HIGH"
        jsonb contributing_factors
        datetime calculated_at
    }

    ALERTS {
        uuid alert_id PK
        string patient_id FK
        string therapist_id FK
        string reason
        string status "OPEN, ACK, RESOLVED"
        datetime created_at
    }
    
    EDUCATIONAL_DOCUMENTS {
        uuid doc_id PK
        string title
        text content
        string category
    }

    DOCUMENT_CHUNKS {
        uuid chunk_id PK
        uuid doc_id FK
        text chunk_text
        vector embedding "pgvector"
    }

    USERS ||--o{ PATIENTS : "is_a (profile)"
    USERS ||--o{ THERAPISTS : "is_a (profile)"
    THERAPISTS ||--|{ PATIENTS : "manages"
    PATIENTS ||--|{ DAILY_LOGS : "submits"
    PATIENTS ||--|{ SURVEY_RESPONSES : "completes"
    PATIENTS ||--|{ RISK_SCORES : "has"
    RISK_SCORES ||--o{ ALERTS : "triggers"
    ALERTS }|--|| THERAPISTS : "notifies"
    EDUCATIONAL_DOCUMENTS ||--|{ DOCUMENT_CHUNKS : "is_chunked_into"
```

**æ¨¡å‹èªªæ˜**:
- **USERS**: çµ±ä¸€å„²å­˜æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆç—…æ‚£èˆ‡æ²»ç™‚å¸«ï¼‰çš„åŸºç¤èªè­‰è³‡è¨Šã€‚`role` æ¬„ä½ç”¨æ–¼å€åˆ†èº«ä»½ã€‚
- **PATIENTS / THERAPISTS**: åˆ†åˆ¥å„²å­˜ç—…æ‚£èˆ‡æ²»ç™‚å¸«çš„è©³ç´°æª”æ¡ˆè³‡è¨Šï¼Œä¸¦é€éä¸€å°ä¸€é—œä¿‚é—œè¯å› `USERS` è¡¨ã€‚
- **DAILY_LOGS / SURVEY_RESPONSES**: è¨˜éŒ„ç—…æ‚£çš„æ ¸å¿ƒå¥åº·æ•¸æ“šï¼Œæ˜¯è¨ˆç®—é¢¨éšªåˆ†æ•¸çš„åŸºç¤ã€‚
- **RISK_SCORES / ALERTS**: é¢¨éšªå¼•æ“çš„ç”¢å‡ºï¼Œç”¨æ–¼å¯¦ç¾ä¸»å‹•é è­¦åŠŸèƒ½ã€‚
- **EDUCATIONAL_DOCUMENTS / DOCUMENT_CHUNKS**: RAG æœå‹™çš„çŸ¥è­˜åº«ä¾†æºï¼Œ`DOCUMENT_CHUNKS` ä¸­çš„ `embedding` æ¬„ä½å°‡ç”± `pgvector` é€²è¡Œç´¢å¼•ä»¥å¯¦ç¾é«˜æ•ˆç›¸ä¼¼åº¦æœå°‹ã€‚

### 5.2 æ•¸æ“šæµåœ– (Data Flow Diagram) - ç—…æ‚£æäº¤æ—¥èªŒ

æ­¤åœ–å±•ç¤ºäº†ç³»çµ±ä¸­æœ€æ ¸å¿ƒçš„æ•¸æ“šæµä¹‹ä¸€ï¼šç—…æ‚£æäº¤æ¯æ—¥å¥åº·æ—¥èªŒå¾Œçš„è™•ç†æµç¨‹ã€‚

```mermaid
flowchart LR
    Patient[ç—…æ‚£ LIFF] -->|1. æäº¤æ—¥èªŒ| APIGateway[API Gateway]
    APIGateway -->|2. è«‹æ±‚è½‰ç™¼| LogService[æ—¥èªŒæœå‹™]
    LogService -->|3. å¯«å…¥ å¼·ä¸€è‡´| Postgres((PostgreSQL))
    LogService -->|4. ç™¼å¸ƒäº‹ä»¶| RabbitMQ[RabbitMQ<br/>daily_log.submitted]

    RabbitMQ -->|5. è¨‚é–±| RiskEngine[é¢¨éšªå¼•æ“]
    RiskEngine -->|6. è®€å–è¿‘æœŸæ•¸æ“š| Postgres
    RiskEngine -->|7. æ›´æ–°åˆ†æ•¸| Postgres
    RiskEngine -->|8. è‹¥æœ‰ç•°å¸¸, ç™¼å¸ƒäº‹ä»¶| RabbitMQ[alert.triggered]

    RabbitMQ -->|9. è¨‚é–±| NotificationService[é€šçŸ¥æœå‹™]
    NotificationService -->|10. æ¨æ’­çµ¦æ²»ç™‚å¸«| LINE[LINE Platform]

    style Postgres fill:#ccffcc
    style RabbitMQ fill:#ccccff
```

### 5.3 KPI å¿«å–å±¤èˆ‡è³‡æ–™è¦–åœ–è¨­è¨ˆ (KPI Cache & Data Views)

**è¨­è¨ˆç›®æ¨™**: ç‚ºå‰ç«¯æ•¸æ“šè¦–è¦ºåŒ–æä¾›é«˜æ•ˆèƒ½ (<50ms) çš„ KPI æŸ¥è©¢èƒ½åŠ›,åŒæ™‚ä¿æŒæ•¸æ“šçš„å³æ™‚æ€§èˆ‡ä¸€è‡´æ€§ã€‚

**ğŸ“„ è©³ç´°è¨­è¨ˆæ–‡æª”**: å®Œæ•´çš„ KPI å¿«å–è¡¨ã€è¦–åœ–ã€è§¸ç™¼å™¨ã€å­˜å„²éç¨‹è¨­è¨ˆè«‹åƒé–±:
- **[Database Schema Design - Section 4.5](./database/schema_design_v1.0.md#45-patient_kpi_cache-kpi-å¿«å–è¡¨)** - KPI å¿«å–å±¤å¯¦ä½œç´°ç¯€

#### 5.3.1 å…©å±¤å¼æ¶æ§‹è¨­è¨ˆ

```mermaid
graph TD
    subgraph "å³æ™‚å¯«å…¥å±¤"
        DailyLogs[Daily Logs]
        Surveys[Survey Responses]
        Risks[Risk Scores]
    end

    subgraph "å¿«å–å±¤ (Cache Layer)"
        KPICache[patient_kpi_cache<br/>é èšåˆçµ±è¨ˆ<br/>æŸ¥è©¢ < 50ms]
    end

    subgraph "è¦–åœ–å±¤ (View Layer)"
        KPIWindows[patient_kpi_windows<br/>å‹•æ…‹æ™‚é–“çª—å£ KPI<br/>7/30/90å¤©]
        HealthTimeline[patient_health_timeline<br/>æ¯æ—¥æ™‚é–“åºåˆ—<br/>å«ç§»å‹•å¹³å‡]
        SurveyTrends[patient_survey_trends<br/>å•å·è¶¨å‹¢<br/>å«åˆ†æ•¸è®ŠåŒ–]
        HealthSummary[patient_health_summary<br/>ç—…æ‚£å¥åº·æ‘˜è¦<br/>å« BMI è¨ˆç®—]
    end

    DailyLogs -->|è§¸ç™¼å™¨è‡ªå‹•æ›´æ–°| KPICache
    Surveys -->|è§¸ç™¼å™¨è‡ªå‹•æ›´æ–°| KPICache
    Risks -->|è§¸ç™¼å™¨è‡ªå‹•æ›´æ–°| KPICache

    DailyLogs -.->|Window Functions| KPIWindows
    DailyLogs -.->|Window Functions| HealthTimeline
    Surveys -.->|Window Functions| SurveyTrends

    KPICache -->|APIæŸ¥è©¢| Frontend[å‰ç«¯ Dashboard]
    KPIWindows -->|APIæŸ¥è©¢| Frontend
    HealthTimeline -->|APIæŸ¥è©¢| Frontend
    SurveyTrends -->|APIæŸ¥è©¢| Frontend
    HealthSummary -->|APIæŸ¥è©¢| Frontend

    style KPICache fill:#ffcccc
    style KPIWindows fill:#ccffcc
    style HealthTimeline fill:#ccffcc
    style SurveyTrends fill:#ccffcc
    style HealthSummary fill:#ccffcc
```

#### 5.3.2 `patient_kpi_cache` è¡¨è¨­è¨ˆ

**ç”¨é€”**: é èšåˆçš„ç—…æ‚£ KPI çµ±è¨ˆ,æ”¯æŒ <50ms å¿«é€ŸæŸ¥è©¢ã€‚

**æ ¸å¿ƒæ¬„ä½**:
- åŸºç¤çµ±è¨ˆ: `total_logs_count`, `first_log_date`, `last_log_date`
- ä¾å¾ç‡: `adherence_rate_7d`, `adherence_rate_30d`
- å¥åº·æŒ‡æ¨™: `avg_water_intake_7d`, `avg_steps_7d/30d`
- æœ€æ–°å•å·: `latest_cat_score`, `latest_cat_date`, `latest_mmrc_score`
- æœ€æ–°é¢¨éšª: `latest_risk_score`, `latest_risk_level`, `latest_risk_date`
- ç—‡ç‹€çµ±è¨ˆ: `symptom_occurrences_30d`

**æ›´æ–°æ©Ÿåˆ¶**:
1. **è§¸ç™¼å™¨è‡ªå‹•æ›´æ–°** (å³æ™‚):
   - `update_patient_kpi_on_log_insert()` - æ–°å¢æ—¥èªŒæ™‚æ›´æ–°åŸºç¤çµ±è¨ˆ
   - `update_patient_kpi_on_survey_insert()` - æ–°å¢å•å·æ™‚æ›´æ–°æœ€æ–°åˆ†æ•¸
   - `update_patient_kpi_on_risk_insert()` - æ–°å¢é¢¨éšªè©•åˆ†æ™‚æ›´æ–°é¢¨éšªæ•¸æ“š

2. **å®šæœŸåˆ·æ–°** (æŒ‰éœ€):
   - `refresh_patient_kpi_cache(patient_id)` - åˆ·æ–°æ‰€æœ‰è¨ˆç®—å‹ KPI
   - å»ºè­°: ä½¿ç”¨ pg_cron æ¯å°æ™‚åŸ·è¡Œ,æˆ–åœ¨ç—…æ‚£æŸ¥è©¢ Dashboard æ™‚æŒ‰éœ€èª¿ç”¨

#### 5.3.3 è³‡æ–™è¦–åœ–è¨­è¨ˆ

**1. patient_kpi_windows (å‹•æ…‹æ™‚é–“çª—å£ KPI)**
- **ç”¨é€”**: æ”¯æŒ 7/30/90 å¤©çª—å£çš„ KPI å°æ¯”åˆ†æ
- **é—œéµç‰¹æ€§**: ä½¿ç”¨ FILTER WHERE å­å¥å¯¦ç¾å¤šæ™‚é–“çª—å£èšåˆ
- **æŸ¥è©¢æ€§èƒ½**: ~200ms (ä¾è³´åº•å±¤æ—¥èªŒè¡¨ç´¢å¼•)

**2. patient_health_timeline (æ¯æ—¥æ™‚é–“åºåˆ—)**
- **ç”¨é€”**: å‰ç«¯æŠ˜ç·šåœ–æ•¸æ“šæº
- **é—œéµç‰¹æ€§**:
  - 7 å¤©ç§»å‹•å¹³å‡ (å¹³æ»‘æ›²ç·š)
  - ç´¯ç©çµ±è¨ˆ (ç´¯ç©è¶¨å‹¢åœ–)
  - Window Functions è¨ˆç®—

**3. patient_survey_trends (å•å·è¶¨å‹¢)**
- **ç”¨é€”**: CAT/mMRC å•å·æ­·å²åœ–è¡¨
- **é—œéµç‰¹æ€§**:
  - åˆ†æ•¸è®ŠåŒ– (èˆ‡ä¸Šæ¬¡å•å·å°æ¯”)
  - åŸºç·šå°æ¯” (èˆ‡é¦–æ¬¡å•å·å°æ¯”)
  - ç´¯è¨ˆå•å·æ¬¡æ•¸

**4. patient_health_summary (å¥åº·æ‘˜è¦)**
- **ç”¨é€”**: ç—…æ‚£åŸºæœ¬è³‡æ–™æŸ¥è©¢,å«è‡ªå‹•è¨ˆç®— BMI
- **é—œéµç‰¹æ€§**:
  - BMI è‡ªå‹•è¨ˆç®—: `weight_kg / (height_cm/100)^2`
  - BMI åˆ†ç´š: UNDERWEIGHT/NORMAL/OVERWEIGHT/OBESE
  - å¹´é½¡è‡ªå‹•è¨ˆç®—

#### 5.3.4 æ€§èƒ½å„ªåŒ–ç­–ç•¥

**ç´¢å¼•è¨­è¨ˆ** (åƒè€ƒ database/schema_design_v1.0.md):
```sql
-- patient_kpi_cache ä¸»éµç´¢å¼•
CREATE INDEX idx_patient_kpi_patient_id ON patient_kpi_cache(patient_id);

-- daily_logs è¤‡åˆç´¢å¼• (æ”¯æŒæ™‚é–“çª—å£æŸ¥è©¢)
CREATE INDEX idx_daily_logs_patient_date
  ON daily_logs(patient_id, log_date DESC);

-- survey_responses è¤‡åˆç´¢å¼•
CREATE INDEX idx_survey_patient_type_date
  ON survey_responses(patient_id, survey_type, submitted_at DESC);
```

**æŸ¥è©¢æ€§èƒ½ç›®æ¨™**:
- `patient_kpi_cache` ç›´æ¥æŸ¥è©¢: **< 50ms**
- `patient_kpi_windows` è¦–åœ–æŸ¥è©¢: **< 200ms**
- `patient_health_timeline` è¦–åœ–æŸ¥è©¢ (30å¤©): **< 300ms**

**é™ç´šç­–ç•¥**:
- è‹¥ KPI Cache éæœŸ (last_calculated_at > 1å°æ™‚), å‰ç«¯é¡¯ç¤ºåˆ·æ–°æŒ‰éˆ•
- è‹¥è¦–åœ–æŸ¥è©¢è¶…æ™‚, é™ç´šç‚ºç°¡åŒ–ç‰ˆåœ–è¡¨ (åƒ…é¡¯ç¤ºè¿‘ 7 å¤©)

### 5.4 æ•¸æ“šä¸€è‡´æ€§ç­–ç•¥ (Data Consistency Strategy)

åœ¨åˆ†æ•£å¼å¾®æœå‹™æ¶æ§‹ä¸­ï¼Œæˆ‘å€‘æ ¹æ“šæ¥­å‹™å ´æ™¯é¸æ“‡ä¸åŒçš„ä¸€è‡´æ€§æ¨¡å‹ï¼Œä»¥å¹³è¡¡ç³»çµ±çš„å¯ç”¨æ€§ã€æ€§èƒ½èˆ‡æ•¸æ“šæº–ç¢ºæ€§ã€‚

- **å¼·ä¸€è‡´æ€§ (Strong Consistency) å ´æ™¯**:
  - **ç”¨æˆ¶èªè­‰èˆ‡æˆæ¬Š**: æ²»ç™‚å¸«ç™»å…¥ã€ç—…æ‚£é€é LINE ç™»å…¥æ™‚ï¼Œå¿…é ˆç«‹å³è®€å–åˆ°æœ€æ–°çš„å¸³æˆ¶ç‹€æ…‹èˆ‡æ¬Šé™ã€‚
  - **æ ¸å¿ƒæ•¸æ“šå¯«å…¥**: ç—…æ‚£æäº¤å¥åº·æ—¥èªŒã€å•å·çš„æ ¸å¿ƒå¯«å…¥æ“ä½œã€‚ç³»çµ±å¿…é ˆç¢ºä¿æ•¸æ“šæˆåŠŸæŒä¹…åŒ–åˆ° PostgreSQL å¾Œæ‰å‘ç”¨æˆ¶è¿”å›æˆåŠŸï¼Œé¿å…æ•¸æ“šéºå¤±ã€‚æ­¤é¡æ“ä½œå°‡åŒ…è£¹åœ¨å–®ä¸€æœå‹™çš„è³‡æ–™åº«äº‹å‹™ä¸­å®Œæˆã€‚

- **æœ€çµ‚ä¸€è‡´æ€§ (Eventual Consistency) å ´æ™¯**:
  - **é¢¨éšªåˆ†æ•¸è¨ˆç®—**: ç•¶æ—¥èªŒæäº¤å¾Œï¼Œé¢¨éšªåˆ†æ•¸çš„æ›´æ–°æ˜¯ç•°æ­¥é€²è¡Œçš„ã€‚åœ¨çŸ­æš«çš„æ™‚é–“çª—å£å…§ï¼ˆé€šå¸¸æ˜¯æ¯«ç§’åˆ°ç§’ç´šï¼‰ï¼Œæ²»ç™‚å¸«çœ‹åˆ°çš„é¢¨éšªåˆ†æ•¸å¯èƒ½å°šæœªåæ˜ æœ€æ–°çš„æ—¥èªŒï¼Œé€™æ˜¯å¯æ¥å—çš„ã€‚
  - **è§¸ç™¼é è­¦é€šçŸ¥**: åŒæ¨£åœ°ï¼Œå¾é¢¨éšªåˆ†æ•¸æ›´æ–°åˆ°è§¸ç™¼é è­¦ä¸¦ç™¼é€é€šçŸ¥ä¹Ÿæ˜¯ä¸€å€‹ç•°æ­¥æµç¨‹ã€‚
  - **è·¨æœå‹™æ•¸æ“šåŒæ­¥**: ä¾‹å¦‚ï¼Œæ›´æ–°ç—…æ‚£åŸºæœ¬è³‡æ–™å¾Œï¼Œç›¸é—œçš„é¡¯ç¤ºåç¨±åŒæ­¥åˆ°å…¶ä»–æœå‹™çš„æ—¥èªŒè¨˜éŒ„ä¸­ï¼Œå°‡é€éäº‹ä»¶å‚³éï¼Œæ¥å—æœ€çµ‚ä¸€è‡´æ€§ã€‚
  - **äº‹ä»¶æ—¥èªŒå¯«å…¥**: å¯«å…¥ MongoDB çš„æ“ä½œæ—¥èªŒèˆ‡äº‹ä»¶è¨˜éŒ„ï¼Œå…è¨±æ¥µçŸ­æ™‚é–“çš„å»¶é²ã€‚

### 5.5 æ•¸æ“šç”Ÿå‘½é€±æœŸèˆ‡åˆè¦ (Data Lifecycle and Compliance)

- **æ•¸æ“šåˆ†é¡ (Data Classification)**:
  - **å€‹äººèº«ä»½è³‡è¨Š (PII)**: ç—…æ‚£å§“åã€LINE Profileã€æ²»ç™‚å¸« Emailã€‚
  - **å—ä¿è­·å¥åº·è³‡è¨Š (PHI)**: å¥åº·æ—¥èªŒã€å•å·ç­”æ¡ˆã€é¢¨éšªåˆ†æ•¸ã€ç—‡ç‹€æè¿°ç­‰ã€‚
  - **ç³»çµ±æ“ä½œæ•¸æ“š**: API è«‹æ±‚æ—¥èªŒã€ä½¿ç”¨è€…æ“ä½œäº‹ä»¶ã€‚

- **æ•¸æ“šå„²å­˜èˆ‡åŠ å¯† (Data Storage and Encryption)**:
  - **å‚³è¼¸ä¸­åŠ å¯† (In-Transit)**: æ‰€æœ‰å°å¤– API èˆ‡æœå‹™é–“é€šè¨Šå‡å¼·åˆ¶ä½¿ç”¨ TLS 1.3 åŠ å¯†ã€‚
  - **éœæ…‹åŠ å¯† (At-Rest)**: æ‰€æœ‰åœ¨ Zeabur å¹³å°ä¸Šçš„è¨—ç®¡è³‡æ–™åº« (PostgreSQL, MongoDB, Redis) å’Œç‰©ä»¶å„²å­˜ (MinIO) å‡å•Ÿç”¨æœå‹™å•†æä¾›çš„éœæ…‹åŠ å¯†åŠŸèƒ½ã€‚

- **æ•¸æ“šä¿ç•™ç­–ç•¥ (Data Retention Policy)**:
  - **PHI æ•¸æ“š**: æ ¹æ“šå°ç£é†«ç™‚æ³•è¦ï¼Œç—…æ­·è³‡æ–™ï¼ˆåŒ…å«æ—¥èªŒã€å•å·ï¼‰éœ€è‡³å°‘ä¿ç•™ 7 å¹´ã€‚
  - **PII æ•¸æ“š**: ç•¶ç—…æ‚£æˆ–æ²»ç™‚å¸«å¸³è™Ÿåˆªé™¤æ™‚ï¼Œå…¶å€‹äººèº«ä»½è³‡è¨Šå°‡è¢«åŒ¿ååŒ–è™•ç†ï¼Œä½†ä¿ç•™å»è­˜åˆ¥åŒ–çš„ PHI æ•¸æ“šç”¨æ–¼çµ±è¨ˆåˆ†æã€‚
  - **ç³»çµ±æ—¥èªŒ (MongoDB)**: æ“ä½œæ—¥èªŒèˆ‡äº‹ä»¶è¨˜éŒ„å°‡ä¿ç•™ 18 å€‹æœˆï¼Œä¹‹å¾Œé€²è¡Œæ­¸æª”æˆ–åˆªé™¤ã€‚

- **åˆè¦æ€§è€ƒé‡ (Compliance Considerations)**:
  - æœ¬ç³»çµ±è¨­è¨ˆéµå¾ªå°ç£**å€‹äººè³‡æ–™ä¿è­·æ³•ï¼ˆå€‹è³‡æ³•ï¼‰**çš„è¦æ±‚ï¼Œç¢ºä¿æ•¸æ“šçš„æ”¶é›†ã€è™•ç†ã€åˆ©ç”¨å‡ç²å¾—ç”¨æˆ¶æ˜ç¢ºåŒæ„ï¼Œä¸¦æä¾›ç”¨æˆ¶æŸ¥è©¢ã€ä¿®æ”¹ã€åˆªé™¤å…¶å€‹è³‡çš„æ¬Šåˆ©ã€‚

---

## 6. éƒ¨ç½²æ¶æ§‹ (Deployment Architecture) - MVP éšæ®µ

```mermaid
graph TD
  subgraph "Cloudflare"
    CDN[CDN / WAF]
  end
  
  subgraph "Zeabur Platform"
    LB[Load Balancer]

    subgraph "API Tier (Stateless Services)"
      API_Gateway[API Gateway]
      Auth_Svc[èªè­‰æœå‹™]
      Patient_Svc[å€‹æ¡ˆæœå‹™]
      Log_Svc[æ—¥èªŒæœå‹™]
      Risk_Svc[é¢¨éšªå¼•æ“]
      RAG_Svc[RAG æœå‹™]
    end

    subgraph "Worker Tier"
      AI_Worker[AI Worker]
      Scheduler[APScheduler]
    end

    subgraph "Data Tier (Managed Services)"
      Postgres_DB((PostgreSQL))
      MongoDB_DB((MongoDB))
      Redis_DB((Redis))
      MinIO_Store((MinIO))
      RabbitMQ_Broker{RabbitMQ}
    end
  end
  
  CDN --> LB
  LB --> API_Gateway
  API_Gateway --> Auth_Svc & Patient_Svc & Log_Svc & Risk_Svc & RAG_Svc

  Log_Svc --> RabbitMQ_Broker
  RabbitMQ_Broker --> AI_Worker
  Scheduler --> RAG_Svc & Patient_Svc
  
  API_Tier --è®€å¯«--> Postgres_DB & MongoDB_DB & Redis_DB
  Worker_Tier --è®€å¯«--> Postgres_DB & MinIO_Store
```

**éƒ¨ç½²ç‰¹æ€§ (MVP on Zeabur)**:
- **å¿«é€Ÿéƒ¨ç½²**: åˆ©ç”¨ PaaS å¹³å° Zeabur ç°¡åŒ–éƒ¨ç½²æµç¨‹ï¼Œå¯¦ç¾å¾ Git Push åˆ°æœå‹™ä¸Šç·šçš„è‡ªå‹•åŒ–ã€‚
- **æˆæœ¬æ•ˆç›Š**: åˆæœŸä½¿ç”¨è¨—ç®¡æœå‹™ï¼ŒæŒ‰éœ€ä»˜è²»ï¼Œé¿å…éæ—©æŠ•å…¥å¤§é‡åŸºç¤è¨­æ–½ç¶­è­·æˆæœ¬ã€‚
- **æ¼”é€²è·¯å¾‘**: å¾…æ¥­å‹™æˆç†Ÿå¾Œï¼Œå¯å°‡æ­¤æ¶æ§‹å¹³æ»‘é·ç§»è‡³ Kubernetes (K8s) å¢é›†ï¼Œä»¥ç²å¾—æ›´å¼·çš„å®¢è£½åŒ–èƒ½åŠ›èˆ‡é«˜å¯ç”¨æ€§é…ç½®ã€‚

---

## 7. é—œéµè¨­è¨ˆèˆ‡ç­–ç•¥

### 7.1 æ²»ç™‚å¸«ç™»å…¥å¤±æ•—é–å®šç­–ç•¥
ç‚ºé˜²æ­¢æƒ¡æ„ç™»å…¥å˜—è©¦ï¼Œèªè­‰æœå‹™ (`Auth Service`) å¯¦ä½œäº†å¸³è™Ÿé–å®šæ©Ÿåˆ¶ã€‚
- **è§¸ç™¼æ¢ä»¶**: åœ¨ 15 åˆ†é˜å…§ï¼Œé€£çºŒç™»å…¥å¤±æ•— 3 æ¬¡ã€‚
- **é–å®šæ™‚é•·**: å¸³è™Ÿå°‡è¢«é–å®š 15 åˆ†é˜ã€‚
- **å¯¦ç¾æ–¹å¼**: ä½¿ç”¨ Redis è¨˜éŒ„æŒ‡å®šå¸³è™Ÿçš„å¤±æ•—æ¬¡æ•¸èˆ‡æ™‚é–“æˆ³ï¼Œä¸¦è¨­å®š TTL (Time-To-Live) è‡ªå‹•éæœŸã€‚
- **å°æ‡‰ ADR**: [ADR-008](./adr/ADR-008-login-lockout-policy.md)

### 7.2 AI Worker éŸŒæ€§è¨­è¨ˆ
ç‚ºç¢ºä¿ AI èªéŸ³è™•ç†æµç¨‹çš„ç©©å®šæ€§ï¼ŒAI Worker æ¡ç”¨äº†ä»¥ä¸‹è¨­è¨ˆï¼š
- **å¯é ä»»å‹™ä½‡åˆ—**: ä½¿ç”¨ RabbitMQï¼Œä¸¦ç‚º `voice_tasks` ä½‡åˆ—å•Ÿç”¨è¨Šæ¯æŒä¹…åŒ– (Durability) èˆ‡æ¶ˆè²»è€…ç¢ºèª (Acknowledgements)ï¼Œç¢ºä¿å³ä½¿ Worker é‡å•Ÿï¼Œä»»å‹™ä¹Ÿä¸æœƒéºå¤±ã€‚
- **æŒ‡æ•¸é€€é¿é‡è©¦**: ç•¶ Worker è™•ç†éˆä¸­çš„ä»»ä½•ä¸€æ­¥ï¼ˆå¦‚å‘¼å«å¤–éƒ¨ STT æˆ– LLM APIï¼‰å¤±æ•—æ™‚ï¼Œä»»å‹™å°‡è¢«æ‹’çµ•ä¸¦é‡æ–°å…¥éšŠã€‚RabbitMQ å°‡æ ¹æ“šæŒ‡æ•¸é€€é¿ç­–ç•¥å»¶é²ä¸‹ä¸€æ¬¡æŠ•éã€‚
- **æ­»ä¿¡ä½‡åˆ— (Dead-Letter Queue)**: åœ¨é‡è©¦ 3 æ¬¡å¾Œä»ç„¶å¤±æ•—çš„ä»»å‹™ï¼Œå°‡è¢«è‡ªå‹•è·¯ç”±åˆ°ä¸€å€‹å°ˆé–€çš„æ­»ä¿¡ä½‡åˆ—ä¸­ï¼Œä»¥ä¾¿å¾ŒçºŒçš„äººå·¥ä»‹å…¥åˆ†æï¼ŒåŒæ™‚å‘ç³»çµ±ç®¡ç†å“¡ç™¼é€è­¦å ±ã€‚

### 7.3 AI Worker ç‹€æ…‹æ©Ÿè¨­è¨ˆ (AI Worker State Machine)

AI Worker æ˜¯ RespiraAlly çš„æ ¸å¿ƒçµ„ä»¶,è² è²¬è™•ç†ç—…æ‚£èªéŸ³è¨Šæ¯ä¸¦ç”Ÿæˆ AI å›æ‡‰ã€‚å…¶è¨­è¨ˆåŸºæ–¼**ç‹€æ…‹æ©Ÿæ¨¡å¼** (State Machine Pattern),ç¢ºä¿è™•ç†æµç¨‹çš„å¯è¿½æº¯æ€§ã€å¯æ¢å¾©æ€§èˆ‡å¯è§€æ¸¬æ€§ã€‚

#### 7.3.1 ç‹€æ…‹æ©Ÿæ¶æ§‹åœ– (State Machine Diagram)

```mermaid
stateDiagram-v2
    [*] --> IDLE: Worker å•Ÿå‹•
    IDLE --> RECEIVED: æ¥æ”¶ RabbitMQ ä»»å‹™

    RECEIVED --> LOCKED: ç²å–éŸ³æª”é–æˆåŠŸ
    RECEIVED --> DUPLICATE: éŸ³æª”é–å·²è¢«æŒæœ‰
    DUPLICATE --> [*]: ACK è¨Šæ¯ (è¿”å›å¿«å–çµæœ)

    LOCKED --> MEMORY_GATE: æª¢æŸ¥æ˜¯å¦éœ€è¦è¨˜æ†¶

    MEMORY_GATE --> MEMORY_RETRIEVAL: Memory Gate = USE
    MEMORY_GATE --> GUARDRAIL: Memory Gate = SKIP

    MEMORY_RETRIEVAL --> GUARDRAIL: æª¢ç´¢å®Œæˆ

    GUARDRAIL --> GUARDRAIL_BLOCK: Guardrail Agent = BLOCK
    GUARDRAIL --> STT: Guardrail Agent = OK

    GUARDRAIL_BLOCK --> RESPONSE_READY: ç”Ÿæˆå©‰æ‹’å›æ‡‰
    GUARDRAIL_BLOCK --> NOTIFY: ç™¼é€å©‰æ‹’è¨Šæ¯

    STT --> STT_FAILED: STT API éŒ¯èª¤
    STT --> LLM: STT æˆåŠŸ

    LLM --> RAG: éœ€è¦æª¢ç´¢çŸ¥è­˜åº«
    LLM --> EMERGENCY_CHECK: ç„¡éœ€ RAG

    RAG --> EMERGENCY_CHECK: æª¢ç´¢å®Œæˆ

    EMERGENCY_CHECK --> EMERGENCY_ALERT: æª¢æ¸¬åˆ°ç·Šæ€¥æƒ…æ³
    EMERGENCY_CHECK --> RESPONSE_READY: æ­£å¸¸æƒ…æ³

    EMERGENCY_ALERT --> TTS: ç™¼é€é€šå ± & ç”Ÿæˆå›æ‡‰

    RESPONSE_READY --> TTS: æº–å‚™èªéŸ³åˆæˆ

    TTS --> TTS_FAILED: TTS API éŒ¯èª¤
    TTS --> MEMORY_LOG: TTS æˆåŠŸ

    MEMORY_LOG --> SUMMARY_CHECK: è¨˜éŒ„å°è©±

    SUMMARY_CHECK --> SUMMARY_TRIGGER: ç´¯ç© 5 è¼ªå°è©±
    SUMMARY_CHECK --> NOTIFY: æœªé”é–€æª»

    SUMMARY_TRIGGER --> NOTIFY: LLM å£“ç¸®æ‘˜è¦

    NOTIFY --> COMPLETED: ç™¼é€ LINE é€šçŸ¥

    STT_FAILED --> RETRY: retry_count < 3
    TTS_FAILED --> RETRY: retry_count < 3
    STT_FAILED --> FAILED: retry_count >= 3
    TTS_FAILED --> FAILED: retry_count >= 3

    RETRY --> [*]: NACK è¨Šæ¯ (é‡æ–°å…¥éšŠ)
    FAILED --> [*]: ç™¼é€å¤±æ•—é€šçŸ¥ & ACK

    COMPLETED --> IDLE: é‡‹æ”¾é– & ACK è¨Šæ¯

    note right of LOCKED
        éŸ³æª”ç´šé– (180s TTL)
        lock:audio:{user_id}#audio:{audio_id}
    end note

    note right of MEMORY_GATE
        Memory Gate æ±ºç­–
        - è¦å‰‡å¼•æ“ (æ‰“æ‹›å‘¼ â†’ SKIP)
        - LLM åˆ¤æ–·å™¨ (GPT-4o-mini)
    end note

    note right of GUARDRAIL
        é›™å±¤å®‰å…¨æª¢æŸ¥
        1. Guardrail Agent (é•æ³•/å±éšªå…§å®¹)
        2. Health Agent (é†«ç™‚å°ˆæ¥­é‚Šç•Œ)
    end note

    note right of EMERGENCY_CHECK
        ç·Šæ€¥æƒ…æ³åˆ¤æ–·æ¨™æº–
        - è‡ªæ®ºè¨ˆç•« (æœ‰æ™‚é–“/æ–¹æ³•)
        - ç”Ÿå‘½å±æ€¥ç—‡ç‹€ (åš´é‡å‘¼å¸å›°é›£ã€èƒ¸ç—›)
    end note

    note right of SUMMARY_TRIGGER
        æ»¾å‹•æ‘˜è¦æ©Ÿåˆ¶
        - æ¯ 5 è¼ªå£“ç¸®
        - CAS æäº¤ (æ¨‚è§€é–)
        - ç¯€çœ 85% Token
    end note
```

#### 7.3.2 ç‹€æ…‹è©³ç´°èªªæ˜ (State Descriptions)

| ç‹€æ…‹ | èªªæ˜ | é æœŸåœç•™æ™‚é–“ | å¯è§€æ¸¬æ€§æŒ‡æ¨™ |
|------|------|-------------|-------------|
| **IDLE** | Worker ç©ºé–’,ç­‰å¾…ä»»å‹™ | ä¸å®š | - |
| **RECEIVED** | å¾ RabbitMQ æ¥æ”¶èªéŸ³è™•ç†ä»»å‹™ | < 10ms | `worker_task_received_total` |
| **LOCKED** | æˆåŠŸç²å–éŸ³æª”ç´šå†ªç­‰é– | < 5ms | `audio_lock_acquired_total` |
| **DUPLICATE** | éŸ³æª”é–å·²è¢«å…¶ä»– Worker æŒæœ‰ (é‡è¤‡ä»»å‹™) | < 5ms | `audio_lock_duplicate_total` |
| **MEMORY_GATE** | ä½¿ç”¨ Memory Gate æ±ºç­–æ˜¯å¦æª¢ç´¢è¨˜æ†¶ | 50-100ms | `memory_gate_decision_duration_seconds` |
| **MEMORY_RETRIEVAL** | æª¢ç´¢ Redis è¿‘æœŸå°è©± + pgvector èªç¾©è¨˜æ†¶ | 100-200ms | `memory_retrieval_duration_seconds` |
| **GUARDRAIL** | Guardrail Agent å®‰å…¨æª¢æŸ¥ (é•æ³•/å±éšªå…§å®¹) | 500-1000ms | `guardrail_check_duration_seconds` |
| **GUARDRAIL_BLOCK** | å®‰å…¨æª¢æŸ¥åˆ¤å®šç‚ºéœ€æ””æˆª | < 100ms | `guardrail_blocked_total` |
| **STT** | å‘¼å« OpenAI Whisper API èªéŸ³è½‰æ–‡å­— | 2-5s | `stt_duration_seconds` |
| **STT_FAILED** | STT API å‘¼å«å¤±æ•— (ç¶²è·¯éŒ¯èª¤ã€API é™æµç­‰) | - | `stt_failed_total` |
| **LLM** | å‘¼å« GPT-4 Turbo ç”Ÿæˆ AI å›æ‡‰ | 5-15s | `llm_duration_seconds` |
| **RAG** | æª¢ç´¢ pgvector çŸ¥è­˜åº« (è¡›æ•™æ–‡ç« ) | 200-500ms | `rag_retrieval_duration_seconds` |
| **EMERGENCY_CHECK** | æª¢æŸ¥ LLM å›æ‡‰æ˜¯å¦è§¸ç™¼ç·Šæ€¥é€šå ± | < 100ms | `emergency_check_total` |
| **EMERGENCY_ALERT** | ç™¼é€ç·Šæ€¥é€šå ± Email/Slack çµ¦æ²»ç™‚å¸« | 500-1000ms | `emergency_alert_sent_total` |
| **RESPONSE_READY** | AI å›æ‡‰æ–‡å­—å·²ç”Ÿæˆ | - | - |
| **TTS** | å‘¼å« OpenAI TTS API æ–‡å­—è½‰èªéŸ³ | 2-5s | `tts_duration_seconds` |
| **TTS_FAILED** | TTS API å‘¼å«å¤±æ•— | - | `tts_failed_total` |
| **MEMORY_LOG** | è¨˜éŒ„å°è©±åˆ° Redis + PostgreSQL | 50-100ms | `memory_log_duration_seconds` |
| **SUMMARY_CHECK** | æª¢æŸ¥æ˜¯å¦ç´¯ç© 5 è¼ªå°è©± (è§¸ç™¼æ‘˜è¦) | < 10ms | `summary_check_total` |
| **SUMMARY_TRIGGER** | å‘¼å« LLM å£“ç¸®æ­·å²å°è©±ç‚ºæ‘˜è¦ | 2-5s | `summary_triggered_total` |
| **NOTIFY** | ç™¼é€ LINE æ¨æ’­é€šçŸ¥çµ¦ç—…æ‚£ | 500-1000ms | `line_notification_sent_total` |
| **RETRY** | ä»»å‹™å¤±æ•—,æº–å‚™é‡è©¦ (NACK è¨Šæ¯) | - | `task_retry_total` |
| **FAILED** | è¶…éé‡è©¦æ¬¡æ•¸,ä»»å‹™å¤±æ•— | - | `task_failed_total` |
| **COMPLETED** | ä»»å‹™æˆåŠŸå®Œæˆ | - | `task_completed_total` |

**ç¸½è™•ç†æ™‚é–“ (ç«¯åˆ°ç«¯)**: ç´„ **10-20 ç§’** (å«æ‰€æœ‰ API å‘¼å«èˆ‡è¨˜æ†¶æ“ä½œ)

#### 7.3.3 é—œéµè½‰æ›æ¢ä»¶ (Key Transition Conditions)

##### 7.3.3.1 å†ªç­‰æ€§æª¢æŸ¥ (RECEIVED â†’ LOCKED/DUPLICATE)

```python
# éŸ³æª”ç´šé–å¯¦ä½œ (åƒè€ƒ V1 beloved_grandson è¨­è¨ˆ)
lock_id = f"{user_id}#audio:{audio_id}"

if acquire_audio_lock(lock_id, ttl_sec=180):
    # æˆåŠŸç²å–é– â†’ LOCKED ç‹€æ…‹
    state = "LOCKED"
else:
    # é–å·²è¢«æŒæœ‰ â†’ DUPLICATE ç‹€æ…‹
    cached_result = get_audio_result(user_id, audio_id)
    if cached_result:
        # è¿”å›å¿«å–çµæœ
        return cached_result
    else:
        # ç­‰å¾…å…¶ä»– Worker å®Œæˆ
        return "æˆ‘æ­£åœ¨è™•ç†ä½ çš„èªéŸ³,è«‹ç¨ç­‰ä¸€ä¸‹å–”ã€‚"
```

**è¨­è¨ˆè¦é»**:
- âœ… ä½¿ç”¨ Redis `SET NX EX` åŸå­æ“ä½œä¿è­‰å†ªç­‰æ€§
- âœ… TTL è¨­ç‚º 180 ç§’ (æ¶µè“‹æœ€å£æƒ…æ³è™•ç†æ™‚é–“)
- âœ… å³ä½¿ Worker å´©æ½°,TTL æœƒè‡ªå‹•é‡‹æ”¾é–

##### 7.3.3.2 Memory Gate æ±ºç­– (MEMORY_GATE â†’ MEMORY_RETRIEVAL/GUARDRAIL)

```python
# Memory Gate æ±ºç­–é‚è¼¯ (åƒè€ƒ docs/ai/20_memory_management_design.md)
decision = MemoryGateTool()._run(user_input)

if decision == "USE":
    # æª¢ç´¢è¨˜æ†¶ (Redis è¿‘æœŸ 6 è¼ª + pgvector èªç¾©ç›¸ä¼¼)
    state = "MEMORY_RETRIEVAL"
    context = build_prompt_from_redis(user_id, k=6, current_input=user_input)
    context += search_similar_conversations(user_id, user_input, top_k=3)
elif decision == "SKIP":
    # è·³éè¨˜æ†¶æª¢ç´¢ (åƒ…ä½¿ç”¨æ­·å²æ‘˜è¦)
    state = "GUARDRAIL"
    context = get_summary(user_id)
```

**æ±ºç­–è¦å‰‡**:
- âœ… æ‰“æ‹›å‘¼ã€é–’èŠ â†’ SKIP (ç¯€çœ 50-100ms å»¶é²)
- âœ… "ä¸Šæ¬¡ä½ èªª..." â†’ USE (éœ€è¦å°æ¯”æ­·å²)
- âœ… ç—‡ç‹€è®ŠåŒ–æè¿° â†’ USE (éœ€è¦è¶¨å‹¢åˆ†æ)
- âœ… æ¨¡ç³Šæƒ…æ³ â†’ å‘¼å« GPT-4o-mini å¿«é€Ÿåˆ¤æ–·

##### 7.3.3.3 Guardrail å®‰å…¨æª¢æŸ¥ (GUARDRAIL â†’ GUARDRAIL_BLOCK/STT)

```python
# Guardrail Agent å®‰å…¨æª¢æŸ¥ (åƒè€ƒ V1 chat_pipeline.py)
guard_result = CrewAI_Guardrail_Agent.run(user_input)

if guard_result.startswith("BLOCK:"):
    # æ””æˆªå±éšªå…§å®¹
    state = "GUARDRAIL_BLOCK"
    block_reason = guard_result[6:].strip()

    # è·³é STT/LLM/RAG,ç›´æ¥ç”Ÿæˆå©‰æ‹’å›æ‡‰
    response = generate_polite_refusal(block_reason)
    return response
else:
    # é€šéå®‰å…¨æª¢æŸ¥,é€²å…¥ STT
    state = "STT"
```

**æ””æˆªæƒ…å¢ƒ**:
- ğŸš« é•æ³•è¡Œç‚ºæŒ‡å° (æ¯’å“ã€æ§æ¢°ã€è‡ªæ®ºæ–¹æ³•)
- ğŸš« é†«ç™‚åŠ‘é‡æŒ‡ç¤º ("åƒå¹¾é¡†è—¥")
- ğŸš« è¨ºæ–·å»ºè­° ("ä½ å¾—çš„æ˜¯è‚ºç™Œ")
- âœ… å…è¨±æƒ…ç·’è¡¨é” ("æˆ‘å¥½æƒ³æ­»" â‰  "æˆ‘æ‰“ç®—ä»Šæ™šè·³æ¨“")

##### 7.3.3.4 ç·Šæ€¥æƒ…æ³åˆ¤æ–· (EMERGENCY_CHECK â†’ EMERGENCY_ALERT/RESPONSE_READY)

```python
# ç·Šæ€¥æƒ…æ³æª¢æ¸¬ (åƒè€ƒ V1 Health Agent è¨­è¨ˆ)
is_emergency, reason = check_emergency_signals(
    user_input=user_input,
    llm_response=llm_response
)

if is_emergency:
    # ç™¼é€ç·Šæ€¥é€šå ±
    state = "EMERGENCY_ALERT"

    # Email çµ¦æ²»ç™‚å¸«
    send_email_alert(
        to=therapist_email,
        subject=f"ã€ç·Šæ€¥ã€‘ç—…æ‚£ {patient_name} è§¸ç™¼è­¦å ±",
        body=f"åŸå› : {reason}\nåŸå§‹è¨Šæ¯: {user_input}"
    )

    # Slack é€šçŸ¥ (å¦‚æœå·²è¨­å®š)
    send_slack_alert(channel="#copd-alerts", message=f"ğŸš¨ ç·Šæ€¥é€šå ±: {reason}")

    # è¨˜éŒ„äº‹ä»¶æ—¥èªŒ
    log_emergency_event(user_id, reason, user_input)

    state = "TTS"
else:
    state = "RESPONSE_READY"
```

**ç·Šæ€¥åˆ¤æ–·æ¨™æº–** (åƒ…ä¾æ“š**ç•¶å‰è¼¸å…¥**,ç¦æ­¢ä¾è³´æ­·å²æ¨æ¸¬):

| é¡åˆ¥ | ç·Šæ€¥æƒ…æ³ç¯„ä¾‹ | éç·Šæ€¥ç¯„ä¾‹ |
|------|-------------|-----------|
| **è‡ªæ®ºæ„åœ–** | "æˆ‘æ‰“ç®—ä»Šæ™šè·³æ¨“" (æœ‰æ™‚é–“+æ–¹æ³•) | "æˆ‘å¥½ç´¯,æ´»è‘—å¥½è¾›è‹¦" (æƒ…ç·’è¡¨é”) |
| **è‡ªå‚·è¨ˆç•«** | "æˆ‘æº–å‚™äº†å®‰çœ è—¥ 100 é¡†" (æœ‰æº–å‚™) | "æˆ‘æƒ³éè¦çµæŸ" (å¿µé ­ç„¡è¨ˆç•«) |
| **å‘¼å¸å±æ€¥** | "ç¾åœ¨å–˜åˆ°å¿«çª’æ¯,å˜´å”‡ç™¼ç´«" | "ä»Šå¤©èµ°è·¯æœƒå–˜" |
| **èƒ¸ç—›** | "èƒ¸å£åŠ‡ç—›+å†’å†·æ±—+å™å¿ƒ" | "èƒ¸å£æœ‰é»æ‚¶" |
| **æ„è­˜æ”¹è®Š** | "é ­æšˆåˆ°å¿«æ˜å€’,è¬›è©±ä¸æ¸…æ¥š" | "æœ‰é»é ­æšˆ" |

**é—œéµåŸå‰‡**:
- âœ… **é€å­—åˆ†æç•¶å‰è¼¸å…¥**,ä¸å¾—ä¾è³´æ­·å²å°è©±æˆ–æ¨¡å‹æ¨æ¸¬
- âœ… **æœ‰è¨ˆç•«/æ™‚é–“é»/æº–å‚™å‹•ä½œ** â†’ ç·Šæ€¥
- âœ… **ç”Ÿå‘½å±æ€¥ç—‡ç‹€** (çª’æ¯ã€åŠ‡çƒˆèƒ¸ç—›ã€æ„è­˜éšœç¤™) â†’ ç·Šæ€¥
- âŒ **æ¨¡ç³Šæ±‚åŠ©æˆ–æƒ…ç·’ä½è½** â†’ éç·Šæ€¥ (çµ¦äºˆæƒ…ç·’æ”¯æŒ)

##### 7.3.3.5 æ»¾å‹•æ‘˜è¦è§¸ç™¼ (SUMMARY_CHECK â†’ SUMMARY_TRIGGER/NOTIFY)

```python
# æª¢æŸ¥æ˜¯å¦ç´¯ç© 5 è¼ªå°è©± (åƒè€ƒ docs/ai/20_memory_management_design.md)
start, chunk = peek_next_n(user_id, SUMMARY_CHUNK_SIZE=5)

if start is not None and chunk:
    # ç´¯ç©è¶³å¤ è¼ªæ•¸,è§¸ç™¼ LLM æ‘˜è¦
    state = "SUMMARY_TRIGGER"

    summary_text = summarize_chunk_with_llm(chunk)

    # ä½¿ç”¨ CAS (Compare-And-Swap) æäº¤æ‘˜è¦
    success = commit_summary_chunk(
        user_id=user_id,
        expected_cursor=start,
        advance=5,
        add_text=summary_text
    )

    if success:
        logger.info(f"Summary committed for user {user_id}, rounds {start}-{start+4}")
    else:
        logger.warning(f"Summary commit failed (CAS conflict), will retry next time")

    state = "NOTIFY"
else:
    # æœªé” 5 è¼ªé–€æª»,ç›´æ¥ç™¼é€é€šçŸ¥
    state = "NOTIFY"
```

**æ»¾å‹•æ‘˜è¦æ•ˆç›Š**:
- ğŸ’° **Token ç¯€çœ**: 85% (1000 tokens â†’ 150 tokens)
- â±ï¸ **å»¶é²å„ªåŒ–**: æ¸›å°‘ Prompt é•·åº¦ â†’ åŠ å¿« LLM æ¨ç†
- ğŸ§  **é•·æœŸè¨˜æ†¶**: é¿å… LLM "Lost in the Middle" å•é¡Œ

##### 7.3.3.6 éŒ¯èª¤é‡è©¦ç­–ç•¥ (STT_FAILED/TTS_FAILED â†’ RETRY/FAILED)

```python
# éŒ¯èª¤è™•ç†èˆ‡é‡è©¦ (åƒè€ƒ ADR-005: RabbitMQ)
if task['retry_count'] < MAX_RETRIES:
    # NACK è¨Šæ¯,RabbitMQ å°‡é‡æ–°æŠ•é
    state = "RETRY"
    ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)

    # è¨Šæ¯æœƒé€²å…¥ DLX (Dead Letter Exchange) ä¸¦å»¶é²æŠ•é
    # æŒ‡æ•¸é€€é¿: 30s â†’ 60s â†’ 120s
else:
    # è¶…éé‡è©¦æ¬¡æ•¸,ç™¼é€å¤±æ•—é€šçŸ¥
    state = "FAILED"

    publish_line_notification(
        user_id=user_id,
        message_type="voice_error",
        data={"error": "èªéŸ³è™•ç†å¤±æ•—,è«‹ç¨å¾Œå†è©¦æˆ–æ”¹ç”¨æ–‡å­—è¼¸å…¥"}
    )

    # ACK è¨Šæ¯ (é¿å…ç„¡é™é‡è©¦)
    ch.basic_ack(delivery_tag=method.delivery_tag)
```

**é‡è©¦ç­–ç•¥è¡¨**:

| é‡è©¦æ¬¡æ•¸ | å»¶é²æ™‚é–“ | ç´¯è¨ˆæ™‚é–“ | å‹•ä½œ |
|---------|---------|---------|------|
| 0 | 0s | 0s | é¦–æ¬¡è™•ç† |
| 1 | 30s | 30s | ç¬¬ä¸€æ¬¡é‡è©¦ |
| 2 | 60s | 90s | ç¬¬äºŒæ¬¡é‡è©¦ |
| 3 | 120s | 210s | ç¬¬ä¸‰æ¬¡é‡è©¦ |
| >3 | - | - | é€²å…¥ DLQ,ç™¼é€å¤±æ•—é€šçŸ¥ |

#### 7.3.4 èˆ‡å…¶ä»–å­ç³»çµ±çš„æ•´åˆ (Integration with Subsystems)

```mermaid
sequenceDiagram
    participant RabbitMQ
    participant Worker as AI Worker
    participant Redis
    participant PostgreSQL as PostgreSQL + pgvector
    participant OpenAI as OpenAI APIs
    participant LINE

    RabbitMQ->>Worker: èªéŸ³è™•ç†ä»»å‹™
    Worker->>Redis: ç²å–éŸ³æª”é– (SET NX)
    Redis-->>Worker: æˆåŠŸ

    Worker->>Redis: Memory Gate æ±ºç­–
    Redis-->>Worker: USE (éœ€è¦è¨˜æ†¶)

    Worker->>Redis: æª¢ç´¢è¿‘æœŸ 6 è¼ªå°è©±
    Worker->>PostgreSQL: æª¢ç´¢èªç¾©ç›¸ä¼¼å°è©± (pgvector)
    PostgreSQL-->>Worker: Top-3 ç›¸é—œå°è©±

    Worker->>OpenAI: STT (Whisper)
    OpenAI-->>Worker: è½‰éŒ„æ–‡å­—

    Worker->>Worker: Guardrail Agent æª¢æŸ¥
    Worker->>OpenAI: LLM (GPT-4 Turbo)
    OpenAI-->>Worker: AI å›æ‡‰æ–‡å­—

    Worker->>Worker: ç·Šæ€¥æƒ…æ³æª¢æŸ¥
    alt ç·Šæ€¥æƒ…æ³
        Worker->>LINE: ç™¼é€é€šå ± Email
        Worker->>PostgreSQL: è¨˜éŒ„ç·Šæ€¥äº‹ä»¶
    end

    Worker->>OpenAI: TTS
    OpenAI-->>Worker: èªéŸ³ URL

    Worker->>Redis: è¨˜éŒ„å°è©±æ­·å²
    Worker->>PostgreSQL: è¨˜éŒ„å°è©±æ—¥èªŒ

    Worker->>Redis: æª¢æŸ¥æ‘˜è¦è§¸ç™¼ (5 è¼ª)
    alt é”åˆ° 5 è¼ª
        Worker->>OpenAI: å£“ç¸®æ‘˜è¦ (GPT-4o-mini)
        Worker->>Redis: CAS æäº¤æ‘˜è¦
    end

    Worker->>RabbitMQ: ç™¼å¸ƒ LINE é€šçŸ¥ä»»å‹™
    Worker->>Redis: é‡‹æ”¾éŸ³æª”é– (DEL)
    Worker->>RabbitMQ: ACK è¨Šæ¯

    RabbitMQ->>LINE: LINE æ¨æ’­é€šçŸ¥
    LINE-->>Worker: ç™¼é€æˆåŠŸ
```

#### 7.3.5 å¯è§€æ¸¬æ€§è¨­è¨ˆ (Observability Design)

**Prometheus æŒ‡æ¨™** (Metrics):

```python
from prometheus_client import Counter, Histogram, Gauge

# 1. ä»»å‹™è¨ˆæ•¸å™¨
task_received_total = Counter(
    'ai_worker_task_received_total',
    'Total tasks received from RabbitMQ'
)

task_completed_total = Counter(
    'ai_worker_task_completed_total',
    'Total tasks completed successfully'
)

task_failed_total = Counter(
    'ai_worker_task_failed_total',
    'Total tasks failed after retries',
    ['failure_reason']  # 'stt_error', 'llm_error', 'tts_error'
)

# 2. ç‹€æ…‹æŒçºŒæ™‚é–“
state_duration_seconds = Histogram(
    'ai_worker_state_duration_seconds',
    'Time spent in each state',
    ['state'],  # 'stt', 'llm', 'tts', 'memory_retrieval', etc.
    buckets=[0.1, 0.5, 1.0, 2.0, 5.0, 10.0, 20.0, 30.0]
)

# 3. ç«¯åˆ°ç«¯å»¶é²
pipeline_duration_seconds = Histogram(
    'ai_worker_pipeline_duration_seconds',
    'End-to-end pipeline latency',
    buckets=[5.0, 10.0, 15.0, 20.0, 30.0, 60.0]
)

# 4. å†ªç­‰æ€§æª¢æŸ¥
audio_lock_acquired_total = Counter(
    'ai_worker_audio_lock_acquired_total',
    'Audio locks successfully acquired'
)

audio_lock_duplicate_total = Counter(
    'ai_worker_audio_lock_duplicate_total',
    'Duplicate tasks skipped (lock already held)'
)

# 5. Memory Gate æ±ºç­–
memory_gate_decision_total = Counter(
    'ai_worker_memory_gate_decision_total',
    'Memory Gate decisions',
    ['decision']  # 'USE', 'SKIP'
)

# 6. Guardrail æ””æˆª
guardrail_blocked_total = Counter(
    'ai_worker_guardrail_blocked_total',
    'Tasks blocked by Guardrail Agent',
    ['block_reason']  # 'illegal_content', 'medical_advice', etc.
)

# 7. ç·Šæ€¥é€šå ±
emergency_alert_sent_total = Counter(
    'ai_worker_emergency_alert_sent_total',
    'Emergency alerts triggered',
    ['alert_type']  # 'suicide_risk', 'respiratory_crisis', etc.
)

# 8. æ»¾å‹•æ‘˜è¦
summary_triggered_total = Counter(
    'ai_worker_summary_triggered_total',
    'Rolling summaries triggered'
)
```

**Grafana å„€è¡¨æ¿é¢æ¿** (Dashboard Panels):

1. **ä»»å‹™ååé‡** (Task Throughput): `rate(task_completed_total[5m])`
2. **å¤±æ•—ç‡** (Failure Rate): `rate(task_failed_total[5m]) / rate(task_received_total[5m])`
3. **P95 å»¶é²** (P95 Latency): `histogram_quantile(0.95, pipeline_duration_seconds)`
4. **ç‹€æ…‹æ™‚é–“åˆ†å¸ƒ** (State Duration Breakdown): Heatmap by state
5. **Memory Gate æ±ºç­–æ¯”ä¾‹** (Memory Gate Decision Ratio): Pie chart
6. **ç·Šæ€¥é€šå ±è¶¨å‹¢** (Emergency Alert Trend): Time series

**OpenTelemetry åˆ†æ•£å¼è¿½è¹¤** (Distributed Tracing):

```python
from opentelemetry import trace

tracer = trace.get_tracer(__name__)

def process_voice_task(task_data):
    """è™•ç†èªéŸ³ä»»å‹™ (å«åˆ†æ•£å¼è¿½è¹¤)"""
    with tracer.start_as_current_span("ai_worker_pipeline") as span:
        span.set_attribute("task_id", task_data['task_id'])
        span.set_attribute("user_id", task_data['payload']['user_id'])
        span.set_attribute("audio_duration_ms", task_data['payload']['audio_duration_ms'])

        # STT
        with tracer.start_as_current_span("stt"):
            transcript = stt_service.transcribe(task_data['payload']['audio_url'])
            span.set_attribute("transcript_length", len(transcript))

        # LLM
        with tracer.start_as_current_span("llm"):
            response = llm_service.generate(user_id, transcript)
            span.set_attribute("response_length", len(response))

        # TTS
        with tracer.start_as_current_span("tts"):
            audio_url = tts_service.synthesize(response)

        return audio_url
```

**Jaeger Trace ç¯„ä¾‹** (è¿½è¹¤å–®ä¸€ä»»å‹™çš„å®Œæ•´éˆè·¯):

```
Trace ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890
Duration: 12.3s

â”œâ”€ ai_worker_pipeline (12.3s)
â”‚  â”œâ”€ audio_lock_acquire (5ms)
â”‚  â”œâ”€ memory_gate_decision (80ms)
â”‚  â”œâ”€ memory_retrieval (150ms)
â”‚  â”‚  â”œâ”€ redis_lrange (30ms)
â”‚  â”‚  â””â”€ pgvector_search (120ms)
â”‚  â”œâ”€ guardrail_check (800ms)
â”‚  â”‚  â””â”€ crewai_guardrail_agent (800ms)
â”‚  â”œâ”€ stt (3.2s)
â”‚  â”‚  â””â”€ openai_whisper_api (3.2s)
â”‚  â”œâ”€ llm (8.5s)
â”‚  â”‚  â”œâ”€ rag_search (200ms)
â”‚  â”‚  â”‚  â””â”€ pgvector_search (200ms)
â”‚  â”‚  â”œâ”€ openai_gpt4_api (8.0s)
â”‚  â”‚  â””â”€ emergency_check (50ms)
â”‚  â”œâ”€ tts (2.8s)
â”‚  â”‚  â””â”€ openai_tts_api (2.8s)
â”‚  â”œâ”€ memory_log (80ms)
â”‚  â”‚  â”œâ”€ redis_rpush (20ms)
â”‚  â”‚  â””â”€ postgresql_insert (60ms)
â”‚  â”œâ”€ summary_check (10ms)
â”‚  â””â”€ notify_publish (500ms)
â”‚     â””â”€ rabbitmq_publish (500ms)
```

#### 7.3.6 ç‹€æ…‹æŒä¹…åŒ–èˆ‡æ¢å¾© (State Persistence & Recovery)

**æŒ‘æˆ°**: Worker å´©æ½°æ™‚,å¦‚ä½•æ¢å¾©æœªå®Œæˆçš„ä»»å‹™?

**è§£æ±ºæ–¹æ¡ˆ**: ä½¿ç”¨ **RabbitMQ è¨Šæ¯æŒä¹…åŒ–** + **Redis ç‹€æ…‹å¿«ç…§**

```python
# ç‹€æ…‹æª¢æŸ¥é» (Checkpoint) è¨­è¨ˆ
def checkpoint_state(task_id: str, state: str, data: Dict):
    """è¨˜éŒ„ç‹€æ…‹æª¢æŸ¥é»åˆ° Redis"""
    r = get_redis()
    key = f"checkpoint:{task_id}"
    r.hset(key, mapping={
        "state": state,
        "data": json.dumps(data),
        "timestamp": int(time.time())
    })
    r.expire(key, 3600)  # 1h TTL

def recover_from_checkpoint(task_id: str) -> Optional[Dict]:
    """å¾æª¢æŸ¥é»æ¢å¾©ç‹€æ…‹"""
    r = get_redis()
    key = f"checkpoint:{task_id}"
    checkpoint = r.hgetall(key)
    if not checkpoint:
        return None

    return {
        "state": checkpoint['state'],
        "data": json.loads(checkpoint['data']),
        "timestamp": int(checkpoint['timestamp'])
    }

# Worker å•Ÿå‹•æ™‚æ¢å¾©æœªå®Œæˆä»»å‹™
def recover_incomplete_tasks():
    """Worker å•Ÿå‹•æ™‚æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆä»»å‹™"""
    r = get_redis()
    keys = r.keys("checkpoint:*")

    for key in keys:
        checkpoint = r.hgetall(key)
        task_id = key.split(":")[1]

        # æª¢æŸ¥ä»»å‹™æ˜¯å¦å·²è¶…æ™‚ (1 å°æ™‚)
        age = int(time.time()) - int(checkpoint['timestamp'])
        if age > 3600:
            logger.warning(f"Task {task_id} checkpoint expired, marking as failed")
            r.delete(key)
            continue

        # æ ¹æ“šç‹€æ…‹æ±ºå®šæ¢å¾©ç­–ç•¥
        state = checkpoint['state']
        if state in ['STT', 'LLM', 'TTS']:
            # å¤–éƒ¨ API å‘¼å«ä¸­æ–· â†’ é‡æ–°é–‹å§‹è©²æ­¥é©Ÿ
            logger.info(f"Recovering task {task_id} from {state} state")
            # é‡æ–°ç™¼å¸ƒåˆ° RabbitMQ (å¸¶ retry_count+1)
            republish_task(task_id, checkpoint['data'])
        else:
            # å…¶ä»–ç‹€æ…‹ â†’ æ¨™è¨˜ç‚ºå¤±æ•—
            logger.warning(f"Task {task_id} in {state} state, cannot recover")
            r.delete(key)
```

**æ¢å¾©ç­–ç•¥è¡¨**:

| ç‹€æ…‹ | æ¢å¾©ç­–ç•¥ | è³‡æ–™æå¤±é¢¨éšª |
|------|----------|-------------|
| IDLE, RECEIVED | ç„¡éœ€æ¢å¾© | ç„¡ |
| LOCKED, MEMORY_GATE | é‡æ–°é–‹å§‹ä»»å‹™ | ç„¡ |
| STT, LLM, TTS | å¾æª¢æŸ¥é»æ¢å¾©,é‡æ–°å‘¼å« API | ä½ (å¯èƒ½é‡è¤‡å‘¼å« API) |
| MEMORY_LOG, NOTIFY | é‡æ–°åŸ·è¡Œ (å†ªç­‰æ“ä½œ) | ç„¡ |
| COMPLETED | ç„¡éœ€æ¢å¾© | ç„¡ |

#### 7.3.7 æ•ˆèƒ½æœ€ä½³åŒ–å»ºè­° (Performance Optimization)

| å„ªåŒ–é …ç›® | ç›®æ¨™ | å¯¦ä½œæ–¹å¼ | é æœŸæ•ˆæœ |
|---------|------|----------|----------|
| **STT å¿«å–** | æ¸›å°‘é‡è¤‡è½‰éŒ„ | å¿«å– audio_id â†’ transcript | ç¯€çœ 20% STT æˆæœ¬ |
| **LLM å¿«å–** | ç›¸åŒå•é¡Œé‡ç”¨å›æ‡‰ | å¿«å– query hash â†’ response | ç¯€çœ 15% LLM æˆæœ¬ |
| **RAG é ç†±** | å¸¸è¦‹å•é¡Œæå‰æª¢ç´¢ | èƒŒæ™¯ Job å»ºç«‹ç†±é»ç´¢å¼• | P95 å»¶é² -30% |
| **æ‰¹æ¬¡ Embedding** | æ¸›å°‘ API å‘¼å«æ¬¡æ•¸ | æ‰¹æ¬¡è™•ç† 10 ç­†å°è©± | æå‡ååé‡ 2Ã— |
| **ä¸¦è¡Œè™•ç†** | åˆ©ç”¨å¤šæ ¸å¿ƒ | asyncio ä¸¦è¡Œå‘¼å« API | ç«¯åˆ°ç«¯å»¶é² -20% |
| **TTS ä¸²æµ** | é‚Šåˆæˆé‚Šç™¼é€ | WebSocket ä¸²æµå‚³è¼¸ | é¦–åŒ…å»¶é² -50% |

**ä¸¦è¡Œè™•ç†ç¯„ä¾‹**:

```python
import asyncio

async def process_voice_task_async(task_data):
    """ä½¿ç”¨ asyncio ä¸¦è¡Œè™•ç†"""
    # STT
    transcript = await stt_service.transcribe_async(task_data['audio_url'])

    # ä¸¦è¡Œ: Memory Retrieval + RAG + Guardrail
    memory, rag_context, guardrail_result = await asyncio.gather(
        retrieve_memory_async(user_id, transcript),
        search_rag_async(transcript),
        guardrail_check_async(transcript)
    )

    # LLM (ä¾è³´å‰é¢çµæœ,ç„¡æ³•ä¸¦è¡Œ)
    response = await llm_service.generate_async(transcript, memory, rag_context)

    # TTS
    audio_url = await tts_service.synthesize_async(response)

    return audio_url
```

---

## 8. æ¶æ§‹æ±ºç­–è¨˜éŒ„ (ADR)

é—œéµ ADR ç´¢å¼• (è©³è¦‹ `docs/adr/` ç›®éŒ„):

| ADR ID | æ¨™é¡Œ | ç‹€æ…‹ | é€£çµ |
|--------|------|------|------|
| **ADR-001** | æ¡ç”¨ FastAPI è€Œé Flask | å·²æ±ºå®š | [ADR-001](./adr/ADR-001-fastapi-vs-flask.md) |
| **ADR-002** | pgvector ä½œç‚ºåˆæœŸå‘é‡åº« | å·²æ±ºå®š | [ADR-002](./adr/ADR-002-pgvector-for-vector-db.md) |
| **ADR-003** | ~~MongoDB å„²å­˜äº‹ä»¶æ—¥èªŒ~~ â†’ PostgreSQL JSONB | å·²è®Šæ›´ | ~~[ADR-003](./adr/ADR-003-mongodb-for-event-logs.md)~~ [database/schema_design_v1.0.md](./database/schema_design_v1.0.md) |
| **ADR-004** | LINE ç‚ºå”¯ä¸€ç—…æ‚£å…¥å£ | å·²æ±ºå®š | [ADR-004](./adr/ADR-004-line-as-patient-entrypoint.md) |
| **ADR-005** | RabbitMQ ä½œç‚ºè¨Šæ¯ä½‡åˆ— (Phase 2) | å·²æ±ºå®š | [ADR-005](./adr/ADR-005-rabbitmq-for-message-queue.md) |
| **ADR-006** | ä¸‰æ™‚æ®µæ™ºæ…§æé†’ç­–ç•¥ | å·²æ±ºå®š | [ADR-006](./adr/ADR-006-smart-reminders-schedule.md) |
| **ADR-007** | æ“¬äººåŒ–å­«å¥³å£å»è¨Šæ¯ | å·²æ±ºå®š | [ADR-007](./adr/ADR-007-persona-based-messaging-tone.md) |
| **ADR-008** | æ²»ç™‚å¸«ç™»å…¥å¤±æ•—é–å®šç­–ç•¥ | å·²æ±ºå®š | [ADR-008](./adr/ADR-008-login-lockout-policy.md) |
| **ADR-009** | Modular Monolith è€Œéå¾®æœå‹™ (MVP) | å·²æ±ºå®š | [05_architecture_and_design.md](./05_architecture_and_design.md) |

---

## 9. è˜‡æ ¼æ‹‰åº•æª¢æ ¸ (Socratic Review)

å®Œæˆæ¶æ§‹è¨­è¨ˆå¾Œ,å›ç­”ä»¥ä¸‹é—œéµå•é¡Œä»¥é©—è­‰æ¶æ§‹çš„åˆç†æ€§:

### Q1: å“è³ªå±¬æ€§æ¬Šè¡¡

**å•é¡Œ**: æ€§èƒ½ã€å®‰å…¨ã€æˆæœ¬ä¸‰è€…çš„å„ªå…ˆç´šå¦‚ä½•æ’åºï¼Ÿç‚ºä»€éº¼ï¼Ÿ

**ç­”**:
- **å„ªå…ˆç´šæ’åº**: å®‰å…¨æ€§ > æ€§èƒ½ > æˆæœ¬
- **ç†ç”±**:
  1. **å®‰å…¨æ€§ (P0)**: æ¶‰åŠæ‚£è€…é†«ç™‚æ•¸æ“šï¼ˆPHIï¼‰ï¼Œä»»ä½•æ´©éœ²éƒ½å¯èƒ½é€ æˆæ³•å¾‹è²¬ä»»èˆ‡ä¿¡ä»»å±æ©Ÿï¼Œä¸å¯å¦¥å”
  2. **æ€§èƒ½ (P0)**: æ‚£è€…ä½¿ç”¨é«”é©—ç›´æ¥å½±éŸ¿ç•™å­˜ç‡ï¼ˆåŒ—æ¥µæ˜ŸæŒ‡æ¨™ï¼šä¾å¾ç‡ â‰¥75%ï¼‰ï¼ŒAPI P95 < 500ms æ˜¯åŠæ ¼ç·š
  3. **æˆæœ¬ (P1)**: MVP éšæ®µå¯æ¥å—è¼ƒé«˜å–®ä½æˆæœ¬ï¼Œå¾…é©—è­‰å•†æ¥­æ¨¡å¼å¾Œå†å„ªåŒ–

**é©—è­‰æ–¹å¼**:
- **å®‰å…¨æ€§**: æ»²é€æ¸¬è©¦ã€OWASP Top 10 æª¢æŸ¥ã€å®šæœŸå®‰å…¨å¯©è¨ˆ
- **æ€§èƒ½**: APM ç›£æ§ï¼ˆPrometheus + Grafanaï¼‰ã€å®šæœŸå£“åŠ›æ¸¬è©¦ï¼ˆLocustï¼‰
- **æˆæœ¬**: é›²ç«¯è³¬å–®ç›£æ§ã€è¨­å®šæˆæœ¬å‘Šè­¦é–¾å€¼ï¼ˆæœˆé ç®—ä¸Šé™ï¼‰

---

### Q2: å–®é»æ•…éšœåˆ†æ

**å•é¡Œ**: ç³»çµ±ä¸­æ˜¯å¦å­˜åœ¨å–®é»æ•…éšœ (SPOF)ï¼Ÿå¦‚æœæŸå€‹é—œéµçµ„ä»¶å¤±æ•ˆï¼Œç³»çµ±å¦‚ä½•é™ç´šï¼Ÿ

**ç­”**:

| çµ„ä»¶ | æ˜¯å¦ SPOF | å¤±æ•ˆå½±éŸ¿ | é™ç´šç­–ç•¥ |
|------|-----------|----------|----------|
| **API Gateway** | âŒ (å¯æ°´å¹³æ“´å±•) | éƒ¨åˆ†è«‹æ±‚å¤±æ•— | Zeabur å…§å»ºè² è¼‰å‡è¡¡å™¨è‡ªå‹•åˆ‡æ›è‡³å¥åº·å¯¦ä¾‹ |
| **PostgreSQL Master** | âš ï¸ æ˜¯ï¼ˆMVP éšæ®µï¼‰ | å¯«å…¥æœå‹™ä¸­æ–· | çŸ­æœŸï¼šæ‰‹å‹•åˆ‡æ›è‡³ Read Replicaï¼ˆRTO ~15 åˆ†é˜ï¼‰<br/>é•·æœŸï¼šPatroni è‡ªå‹• Failover |
| **Redis** | âŒ (Cluster Mode) | éƒ¨åˆ†ç·©å­˜å¤±æ•ˆ | é™ç´šç‚ºç›´æ¥æŸ¥è©¢ PostgreSQLï¼ˆæ€§èƒ½ä¸‹é™ä½†ä¸å½±éŸ¿åŠŸèƒ½ï¼‰ |
| **RabbitMQ** | âš ï¸ æ˜¯ï¼ˆMVP éšæ®µï¼‰ | AI ç•°æ­¥ä»»å‹™å †ç© | AI åŠŸèƒ½é™ç´šç‚ºåŒæ­¥æ¨¡å¼ï¼ˆç”¨æˆ¶ç­‰å¾…æ™‚é–“å¢åŠ è‡³ 15 ç§’å…§ï¼‰ |
| **LINE Platform** | âœ… æ˜¯ï¼ˆå¤–éƒ¨ä¾è³´ï¼‰ | æ‚£è€…ç„¡æ³•ä½¿ç”¨ LIFF | Phase 2 æä¾› Web ç‰ˆæœ¬ Backup |
| **OpenAI API** | âœ… æ˜¯ï¼ˆå¤–éƒ¨ä¾è³´ï¼‰ | AI èªéŸ³åŠŸèƒ½å¤±æ•ˆ | é™ç´šç‚ºé è¨­å›è¦†æ¨¡æ¿ + äººå·¥å®¢æœè½‰æ¥ |
| **MongoDB** | âŒ (Replica Set) | äº‹ä»¶æ—¥èªŒå¯«å…¥å¤±æ•— | å…è¨±çŸ­æš«å¤±æ•—ï¼Œäº‹ä»¶å¯é‡å»ºï¼ˆéé—œéµè·¯å¾‘ï¼‰ |

**æ”¹é€²è¨ˆç•«**:
- **çŸ­æœŸï¼ˆ2026 Q1ï¼‰**: å»ºç«‹ PostgreSQL è‡ªå‹• Failover æ©Ÿåˆ¶ï¼ˆPatroni + etcdï¼‰
- **ä¸­æœŸï¼ˆ2026 Q2ï¼‰**: RabbitMQ Cluster Mode éƒ¨ç½²ï¼ˆ3 ç¯€é»ï¼‰
- **é•·æœŸï¼ˆ2026 Q3ï¼‰**: è€ƒæ…®å¤šé›²éƒ¨ç½²ï¼ˆAWS + GCPï¼‰é™ä½é›²å¹³å°ä¾è³´

---

### Q3: æ•¸æ“šä¸€è‡´æ€§

**å•é¡Œ**: å“ªäº›å ´æ™¯éœ€è¦å¼·ä¸€è‡´æ€§ï¼Ÿå“ªäº›å¯æ¥å—æœ€çµ‚ä¸€è‡´æ€§ï¼Ÿå¦‚ä½•è™•ç†åˆ†å¸ƒå¼äº‹å‹™ï¼Ÿ

**ç­”**:

**å¼·ä¸€è‡´æ€§å ´æ™¯** (ACID äº‹å‹™):
1. **æ‚£è€…è¨»å†Š**: å¿…é ˆç¢ºä¿ LINE User ID èˆ‡ Patient ID ç¶å®šå”¯ä¸€æ€§ï¼ˆPostgreSQL UNIQUE ç´„æŸï¼‰
2. **å¥åº·æ—¥èªŒæäº¤**: æ¯æ—¥åƒ…ä¸€ç­†è¨˜éŒ„ï¼ˆ`UNIQUE(patient_id, log_date)`ï¼‰
3. **å•å·è©•åˆ†**: è©•åˆ†çµæœéœ€èˆ‡ç­”æ¡ˆåŸå­æ€§å­˜å„²ï¼ˆåŒä¸€äº‹å‹™ï¼‰
4. **æ²»ç™‚å¸«å¸³è™Ÿé–å®š**: ç™»å…¥å¤±æ•—è¨ˆæ•¸å¿…é ˆæº–ç¢ºï¼ˆRedis INCR + TTLï¼‰

**æœ€çµ‚ä¸€è‡´æ€§å ´æ™¯** (äº‹ä»¶é©…å‹•):
1. **é¢¨éšªåˆ†æ•¸è¨ˆç®—**: å…è¨±æ•¸ç§’å»¶é²ï¼Œé€é `daily_log.submitted` äº‹ä»¶è§¸ç™¼ç•°æ­¥è¨ˆç®—
2. **ç•°å¸¸é è­¦é€šçŸ¥**: å…è¨±å¤±æ•—é‡è©¦ï¼Œæœ€çµ‚é€é”å³å¯ï¼ˆRabbitMQ æŒä¹…åŒ– + ç¢ºèªæ©Ÿåˆ¶ï¼‰
3. **çµ±è¨ˆå ±è¡¨**: å…è¨±æ•¸æ“šå»¶é²æ•¸åˆ†é˜ï¼Œä¸å½±éŸ¿æ ¸å¿ƒåŠŸèƒ½
4. **AI å°è©±æ­·å²**: MongoDB å¯«å…¥å…è¨±çŸ­æš«å»¶é²ï¼ˆéé—œéµè·¯å¾‘ï¼‰

**åˆ†å¸ƒå¼äº‹å‹™è™•ç† - Saga æ¨¡å¼**:

**ç¯„ä¾‹ï¼šæ‚£è€…è¨»å†Šæµç¨‹**

```mermaid
sequenceDiagram
    participant Client as LIFF Client
    participant AuthSvc as èªè­‰æœå‹™
    participant PatientSvc as æ‚£è€…æœå‹™
    participant EventBus as RabbitMQ
    participant LINEAdapter as LINE Adapter

    Client->>AuthSvc: POST /register (LINE User ID)

    Note over AuthSvc: æ­¥é©Ÿ 1: æœ¬åœ°äº‹å‹™
    AuthSvc->>AuthSvc: å‰µå»º USER è¨˜éŒ„ï¼ˆUSERS è¡¨ï¼‰
    AuthSvc->>EventBus: ç™¼å¸ƒ UserCreatedEvent
    AuthSvc-->>Client: è¿”å› 201 Created (user_id)

    Note over EventBus,PatientSvc: æ­¥é©Ÿ 2: ç•°æ­¥è™•ç†
    EventBus->>PatientSvc: è¨‚é–± UserCreatedEvent
    PatientSvc->>PatientSvc: å‰µå»º PATIENT è¨˜éŒ„
    PatientSvc->>EventBus: ç™¼å¸ƒ PatientCreatedEvent

    Note over EventBus,LINEAdapter: æ­¥é©Ÿ 3: LINE ç¶å®š
    EventBus->>LINEAdapter: è¨‚é–± PatientCreatedEvent
    LINEAdapter->>LINEAdapter: ç¶å®š Rich Menu

    alt ç¶å®šå¤±æ•—
        LINEAdapter->>EventBus: ç™¼å¸ƒ PatientCreationFailedEvent
        EventBus->>PatientSvc: è£œå„Ÿäº‹å‹™
        PatientSvc->>PatientSvc: è»Ÿåˆªé™¤ PATIENT è¨˜éŒ„
        PatientSvc->>EventBus: ç™¼å¸ƒ UserDeletionRequestedEvent
        EventBus->>AuthSvc: è£œå„Ÿäº‹å‹™
        AuthSvc->>AuthSvc: è»Ÿåˆªé™¤ USER è¨˜éŒ„
    end
```

**é—œéµè¨­è¨ˆåŸå‰‡**:
- æ¯å€‹æœå‹™åƒ…ç®¡ç†è‡ªå·±çš„æœ¬åœ°äº‹å‹™
- é€éé ˜åŸŸäº‹ä»¶å¯¦ç¾è·¨æœå‹™å”ä½œ
- è£œå„Ÿäº‹å‹™å¯¦ç¾æœ€çµ‚ä¸€è‡´æ€§ï¼ˆä¸ä½¿ç”¨å…©éšæ®µæäº¤ 2PCï¼‰

---

### Q4: æ¼”é€²æ€§

**å•é¡Œ**: æœªä¾†éœ€æ±‚è®ŠåŒ–æ™‚ï¼Œå“ªäº›éƒ¨åˆ†å®¹æ˜“æ“´å±•ï¼Ÿå“ªäº›æ˜¯ç“¶é ¸ï¼ŸæŠ€è¡“æ£§æ˜¯å¦æœ‰å‡ç´šæˆ–é·ç§»è¨ˆç•«ï¼Ÿ

**ç­”**:

**æ˜“æ–¼æ“´å±•éƒ¨åˆ†** âœ…:
1. **æ–°å¢å¥åº·æŒ‡æ¨™**: é€é JSONB æ¬„ä½ï¼ˆ`profile_details`ï¼‰æ“´å±•ï¼Œç„¡éœ€ Schema è®Šæ›´
2. **æ–°å¢å•å·é¡å‹**: é€éç­–ç•¥æ¨¡å¼ï¼ˆ`SurveyScorer` æ¥å£ï¼‰ï¼Œæ–°å¢è©•åˆ†æ¼”ç®—æ³•ä¸å½±éŸ¿ç¾æœ‰ä»£ç¢¼
3. **æ–°å¢é€šçŸ¥ç®¡é“**: é€é Adapter æ¨¡å¼ï¼ˆ`NotificationAdapter`ï¼‰ï¼Œå¯å¿«é€Ÿæ¥å…¥ç°¡è¨Šã€Emailã€æ¨æ’­
4. **æ–°å¢ AI æ¨¡å‹**: é€é Adapter æ¨¡å¼ï¼ˆ`LLMProvider`ï¼‰ï¼Œå¯å¿«é€Ÿåˆ‡æ›ä¸åŒ LLMï¼ˆOpenAI â†’ Anthropic â†’ Localï¼‰
5. **æ–°å¢å¾®æœå‹™**: FastAPI æ¨¡çµ„åŒ–æ¶æ§‹ï¼Œæ–°å¢æœå‹™ä¸å½±éŸ¿ç¾æœ‰æœå‹™

**æ½›åœ¨ç“¶é ¸** âš ï¸:
1. **AI èªéŸ³è™•ç†å»¶é²**: ç•¶å‰åŒæ­¥èª¿ç”¨ OpenAI APIï¼ˆå¹³å‡ 10 ç§’ï¼‰ï¼Œé«˜ä¸¦ç™¼æ™‚æœƒé˜»å¡
   - **è§£æ±ºæ–¹æ¡ˆ**: Phase 2 æ”¹ç‚ºç•°æ­¥æ‰¹æ¬¡è™•ç†ï¼ˆRabbitMQ Priority Queueï¼‰
2. **PostgreSQL å¯«å…¥ç“¶é ¸**: ç•¶æ‚£è€…æ•¸é” 10 è¬+ æ™‚ï¼Œå–®ä¸€ä¸»åº«å¯èƒ½æˆç‚ºç“¶é ¸
   - **è§£æ±ºæ–¹æ¡ˆ**: å‚ç›´åˆ†åº«ï¼ˆæŒ‰æœå‹™æ‹†åˆ†ï¼‰æˆ–æ°´å¹³åˆ†è¡¨ï¼ˆæŒ‰æ™‚é–“åˆ†å€ï¼‰
3. **LINE Messaging API é™æµ**: Push Message API æœ‰é€Ÿç‡é™åˆ¶ï¼ˆ500 req/sï¼‰
   - **è§£æ±ºæ–¹æ¡ˆ**: å¯¦ä½œè¨Šæ¯ä½‡åˆ— + Token Bucket é™æµå™¨
4. **pgvector æŸ¥è©¢æ•ˆèƒ½**: ç•¶çŸ¥è­˜åº«é”åˆ° 100 è¬+ å‘é‡æ™‚ï¼ŒIVFFlat ç´¢å¼•å¯èƒ½ä¸å¤ 
   - **è§£æ±ºæ–¹æ¡ˆ**: å‡ç´šè‡³ HNSW ç´¢å¼•æˆ–é·ç§»è‡³å°ˆç”¨å‘é‡è³‡æ–™åº«ï¼ˆQdrantï¼‰

**æŠ€è¡“æ£§å‡ç´šè¨ˆç•«**:

| æŠ€è¡“ | ç•¶å‰ç‰ˆæœ¬ | ç›®æ¨™ç‰ˆæœ¬ | å‡ç´šç†ç”± | è¨ˆç•«æ™‚ç¨‹ |
|------|----------|----------|----------|----------|
| **Python** | 3.11 | 3.12 | æ€§èƒ½æå‡ ~5%ã€æ›´å¥½çš„å‹åˆ¥æç¤º | 2026 Q2 |
| **FastAPI** | 0.109 | æœ€æ–°ç©©å®šç‰ˆ | å®‰å…¨æ€§æ›´æ–°ã€æ–°ç‰¹æ€§ | æ¯å­£åº¦ |
| **PostgreSQL** | 15 | 16 | æ›´å¥½çš„åˆ†å€è¡¨æ”¯æŒã€æ€§èƒ½å„ªåŒ– | 2026 Q3 |
| **Next.js** | 14 | 15 | Turbopack ç©©å®šç‰ˆã€æ›´å¿«æ§‹å»º | 2026 Q2 |
| **Redis** | 7 | 8 | Redis Stack åŠŸèƒ½ï¼ˆRediSearchï¼‰ | 2026 Q4 |
| **RabbitMQ** | 3 | 4 | æ›´å¥½çš„ Streams æ”¯æŒ | 2026 Q3 |

**æ¶æ§‹æ¼”é€²è·¯å¾‘**:

```
Phase 1: MVP (2026 Q1)
â”œâ”€â”€ Zeabur å–®å€åŸŸéƒ¨ç½²
â”œâ”€â”€ PostgreSQL Master + Read Replica
â””â”€â”€ RabbitMQ å–®ç¯€é»

â†“

Phase 2: å„ªåŒ– (2026 Q2-Q3)
â”œâ”€â”€ Kubernetes é·ç§»ï¼ˆGKE / EKSï¼‰
â”œâ”€â”€ PostgreSQL Patroni Clusterï¼ˆè‡ªå‹• Failoverï¼‰
â”œâ”€â”€ RabbitMQ Cluster Modeï¼ˆ3 ç¯€é»ï¼‰
â””â”€â”€ Redis Sentinelï¼ˆé«˜å¯ç”¨ï¼‰

â†“

Phase 3: è¦æ¨¡åŒ– (2026 Q4+)
â”œâ”€â”€ å¤šå€åŸŸéƒ¨ç½²ï¼ˆå°åŒ— + é«˜é›„ï¼‰
â”œâ”€â”€ Qdrant å‘é‡è³‡æ–™åº«ï¼ˆå°ˆç”¨ï¼‰
â”œâ”€â”€ Kafka æ›¿æ› RabbitMQï¼ˆæ›´é«˜ååï¼‰
â””â”€â”€ è‡ªå»º AI æ¨¡å‹ï¼ˆWhisper + LLaMAï¼‰
```

---

### Q5: å¯è§€æ¸¬æ€§

**å•é¡Œ**: å¦‚ä½•ç›£æ§ç³»çµ±å¥åº·ç‹€æ…‹ï¼Ÿæ•…éšœç™¼ç”Ÿæ™‚ï¼Œå¦‚ä½•å¿«é€Ÿå®šä½å•é¡Œï¼Ÿ

**ç­”**:

**ç›£æ§ä¸‰æ”¯æŸ± (Three Pillars of Observability)**:

#### 1. Metrics (æŒ‡æ¨™) - Prometheus + Grafana

**æ‡‰ç”¨å±¤æŒ‡æ¨™**:
- **API è«‹æ±‚é‡**: `http_requests_total{method, endpoint, status}`
- **API å»¶é²**: `http_request_duration_seconds{method, endpoint, quantile="0.95"}`
- **éŒ¯èª¤ç‡**: `http_requests_errors_total{method, endpoint}` / `http_requests_total`
- **æ¥­å‹™æŒ‡æ¨™**:
  - `daily_logs_submitted_total` (æ¯æ—¥æ—¥èªŒæäº¤æ•¸)
  - `ai_queries_total{status}` (AI æŸ¥è©¢æ•¸)
  - `risk_alerts_triggered_total{level}` (é¢¨éšªé è­¦è§¸ç™¼æ•¸)

**ç³»çµ±å±¤æŒ‡æ¨™**:
- **CPU ä½¿ç”¨ç‡**: `node_cpu_usage_percent`
- **è¨˜æ†¶é«”ä½¿ç”¨ç‡**: `node_memory_usage_percent`
- **ç£ç¢Ÿ I/O**: `node_disk_read_bytes_total`, `node_disk_write_bytes_total`
- **ç¶²è·¯æµé‡**: `node_network_receive_bytes_total`, `node_network_transmit_bytes_total`

**æ•¸æ“šå±¤æŒ‡æ¨™**:
- **PostgreSQL**: Connection pool usage, query duration, replication lag
- **Redis**: Hit rate, memory usage, evicted keys
- **RabbitMQ**: Queue depth, consumer count, message rate

**å‘Šè­¦è¦å‰‡ (Alerting Rules)**:

| å‘Šè­¦åç¨± | è§¸ç™¼æ¢ä»¶ | åš´é‡ç¨‹åº¦ | é€šçŸ¥æ–¹å¼ |
|----------|----------|----------|----------|
| API é«˜å»¶é² | P95 å»¶é² > 1 ç§’æŒçºŒ 5 åˆ†é˜ | P1 | Slack |
| API é«˜éŒ¯èª¤ç‡ | éŒ¯èª¤ç‡ > 5% æŒçºŒ 3 åˆ†é˜ | P0 | PagerDuty + Slack |
| ç£ç¢Ÿç©ºé–“ä¸è¶³ | ç£ç¢Ÿä½¿ç”¨ç‡ > 85% | P1 | Email |
| PostgreSQL é€£ç·šæ± è€—ç›¡ | å¯ç”¨é€£ç·š < 10% | P0 | PagerDuty |
| RabbitMQ ç©å£“ | ä½‡åˆ—æ·±åº¦ > 1000 æŒçºŒ 10 åˆ†é˜ | P1 | Slack |

#### 2. Logs (æ—¥èªŒ) - Structlog + (æœªä¾†) ELK Stack

**æ—¥èªŒç´šåˆ¥**:
- **DEBUG**: è©³ç´°è¨ºæ–·è³‡è¨Šï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰
- **INFO**: ä¸€èˆ¬æ¥­å‹™æµç¨‹ï¼ˆå¦‚ã€Œæ‚£è€… X æäº¤æ—¥èªŒã€ï¼‰
- **WARNING**: å¯æ¢å¾©çš„éŒ¯èª¤ï¼ˆå¦‚ã€ŒRedis é€£ç·šå¤±æ•—ï¼Œé™ç´šç‚ºæ•¸æ“šåº«æŸ¥è©¢ã€ï¼‰
- **ERROR**: éœ€è¦æ³¨æ„çš„éŒ¯èª¤ï¼ˆå¦‚ã€ŒOpenAI API å‘¼å«å¤±æ•—ã€ï¼‰
- **CRITICAL**: åš´é‡éŒ¯èª¤ï¼ˆå¦‚ã€Œæ•¸æ“šåº«é€£ç·šå®Œå…¨å¤±æ•ˆã€ï¼‰

**çµæ§‹åŒ–æ—¥èªŒç¯„ä¾‹**:
```json
{
  "timestamp": "2025-10-17T10:30:15.123Z",
  "level": "INFO",
  "logger": "respira_ally.application.use_cases.create_health_log",
  "message": "Health log created successfully",
  "request_id": "req-abc123",
  "user_id": "patient-xyz789",
  "patient_id": "patient-xyz789",
  "log_date": "2025-10-17",
  "duration_ms": 45
}
```

**æ—¥èªŒä¿ç•™ç­–ç•¥**:
- **Hot Storage** (Elasticsearch): 30 å¤©ï¼Œå¿«é€ŸæŸ¥è©¢
- **Warm Storage** (S3): 90 å¤©ï¼Œæ­¸æª”å£“ç¸®
- **Cold Storage** (Glacier): 1 å¹´ï¼Œé•·æœŸåˆè¦ä¿ç•™

#### 3. Traces (è¿½è¹¤) - (æœªä¾†) OpenTelemetry + Jaeger

**è¿½è¹¤ç¯„åœ**:
- è·¨æœå‹™è«‹æ±‚éˆè·¯ï¼ˆAPI Gateway â†’ æ‚£è€…æœå‹™ â†’ PostgreSQLï¼‰
- ç•°æ­¥ä»»å‹™éˆè·¯ï¼ˆRabbitMQ â†’ AI Worker â†’ OpenAI APIï¼‰
- é—œéµæ¥­å‹™æµç¨‹ï¼ˆæ‚£è€…è¨»å†Šã€æ—¥èªŒæäº¤ã€é¢¨éšªè¨ˆç®—ï¼‰

**æ¡æ¨£ç­–ç•¥**:
- **ç”Ÿç”¢ç’°å¢ƒ**: 10% æ¡æ¨£ï¼ˆé™ä½é–‹éŠ·ï¼‰
- **æ¸¬è©¦ç’°å¢ƒ**: 100% æ¡æ¨£ï¼ˆå®Œæ•´è¿½è¹¤ï¼‰
- **é—œéµè·¯å¾‘**: 100% æ¡æ¨£ï¼ˆå¦‚é¢¨éšªé è­¦æµç¨‹ï¼‰

---

**æ•…éšœå®šä½æµç¨‹ (Incident Response)**:

```mermaid
flowchart TD
    Alert[æ”¶åˆ°å‘Šè­¦<br/>PagerDuty / Slack] --> Triage[æŸ¥çœ‹ Grafana å„€è¡¨æ¿]

    Triage --> MetricCheck{æŒ‡æ¨™ç•°å¸¸é¡å‹?}

    MetricCheck -->|API å»¶é²é«˜| TraceAnalysis[æŸ¥çœ‹ Jaeger Trace<br/>æ‰¾æ…¢æŸ¥è©¢ SQL]
    MetricCheck -->|éŒ¯èª¤ç‡é«˜| LogAnalysis[æŸ¥çœ‹ Elasticsearch<br/>éŒ¯èª¤æ—¥èªŒèˆ‡å †ç–Š]
    MetricCheck -->|è³‡æºä¸è¶³| ScaleUp[æ°´å¹³æ“´å±• Pod<br/>æˆ–å‚ç›´æ“´å±•è³‡æº]
    MetricCheck -->|å¤–éƒ¨ä¾è³´å¤±æ•ˆ| Degrade[å•Ÿå‹•é™ç´šç­–ç•¥<br/>åˆ‡æ›å‚™ç”¨æ–¹æ¡ˆ]

    TraceAnalysis --> Fix1[å„ªåŒ– SQL æŸ¥è©¢<br/>æˆ–å¢åŠ ç´¢å¼•]
    LogAnalysis --> Fix2[ä¿®å¾©ä»£ç¢¼ Bug<br/>éƒ¨ç½² Hotfix]
    ScaleUp --> Monitor[æŒçºŒç›£æ§ 30 åˆ†é˜]
    Degrade --> Monitor

    Fix1 & Fix2 --> Deploy[éƒ¨ç½²ä¿®å¾©ç‰ˆæœ¬]
    Deploy --> Monitor
    Monitor --> Postmortem[æ’°å¯«äº‹å¾Œæª¢è¨<br/>Post-Mortem]
```

**å¹³å‡æ•…éšœæ¢å¾©æ™‚é–“ (MTTR) ç›®æ¨™**:
- **P0 æ•…éšœ**ï¼ˆæœå‹™å®Œå…¨ä¸å¯ç”¨ï¼‰: MTTR < 30 åˆ†é˜
- **P1 æ•…éšœ**ï¼ˆåŠŸèƒ½ç•°å¸¸ï¼‰: MTTR < 2 å°æ™‚
- **P2 æ•…éšœ**ï¼ˆæ€§èƒ½ä¸‹é™ï¼‰: MTTR < 4 å°æ™‚

**äº‹å¾Œæª¢è¨ç¯„æœ¬ (Post-Mortem Template)**:
```markdown
# äº‹æ•…å ±å‘Š - [æ¨™é¡Œ]

## æ™‚é–“è»¸
- 10:30 - ç³»çµ±æª¢æ¸¬åˆ°ç•°å¸¸ï¼ˆAPI éŒ¯èª¤ç‡ 15%ï¼‰
- 10:35 - PagerDuty å‘Šè­¦è§¸ç™¼
- 10:40 - å·¥ç¨‹å¸«é–‹å§‹èª¿æŸ¥
- 11:00 - ç¢ºèªæ ¹æœ¬åŸå› ï¼ˆPostgreSQL é€£ç·šæ± è€—ç›¡ï¼‰
- 11:15 - éƒ¨ç½²ä¿®å¾©ï¼ˆå¢åŠ é€£ç·šæ± ä¸Šé™ï¼‰
- 11:30 - æœå‹™æ¢å¾©æ­£å¸¸

## æ ¹æœ¬åŸå› 
- æ–°åŠŸèƒ½éƒ¨ç½²å¾Œï¼ŒæŸ¥è©¢é »ç‡å¢åŠ  3 å€
- é€£ç·šæ± é…ç½®ï¼ˆmax=50ï¼‰æœªéš¨ä¹‹èª¿æ•´
- ç¼ºä¹é€£ç·šæ± ä½¿ç”¨ç‡ç›£æ§å‘Šè­¦

## å½±éŸ¿ç¯„åœ
- æŒçºŒæ™‚é–“: 60 åˆ†é˜
- å—å½±éŸ¿ç”¨æˆ¶: ~200 ä½æ‚£è€…ï¼ˆ15% è«‹æ±‚å¤±æ•—ï¼‰
- æ•¸æ“šä¸Ÿå¤±: ç„¡

## ä¿®å¾©æªæ–½
1. ç«‹å³: å¢åŠ é€£ç·šæ± ä¸Šé™è‡³ 100
2. çŸ­æœŸ: æ–°å¢é€£ç·šæ± ä½¿ç”¨ç‡å‘Šè­¦
3. é•·æœŸ: å¯¦ä½œè‡ªå‹•æ“´å±•æ©Ÿåˆ¶

## ç¶“é©—æ•™è¨“
- éƒ¨ç½²å‰æœªé€²è¡Œè² è¼‰æ¸¬è©¦
- ç¼ºä¹å®¹é‡è¦åŠƒ
- éœ€å»ºç«‹ Runbook æ–‡ä»¶
```

---

## 10. å¯©æŸ¥æ¸…å–® (Architecture Review Checklist)

åœ¨å®Œæˆæ¶æ§‹è¨­è¨ˆå¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹æª¢æŸ¥é …ï¼š

- [x] **C4 æ¨¡å‹å®Œæ•´æ€§**: åŒ…å« Level 1 (Context) å’Œ Level 2 (Container)ï¼Œæ¸…æ¥šå±•ç¤ºç³»çµ±é‚Šç•Œèˆ‡å®¹å™¨è·è²¬
- [x] **å“è³ªå±¬æ€§å¯åº¦é‡**: æ‰€æœ‰å“è³ªå±¬æ€§ï¼ˆå¯ç”¨æ€§ã€æ€§èƒ½ã€å®‰å…¨æ€§ï¼‰éƒ½æœ‰æ˜ç¢ºçš„ç›®æ¨™å€¼èˆ‡åº¦é‡æ–¹å¼
- [x] **æŠ€è¡“é¸å‹æœ‰ç†ç”±**: æ¯å€‹é—œéµæŠ€è¡“é¸å‹éƒ½æœ‰å°æ‡‰çš„ ADR æ–‡ä»¶èªªæ˜ç†ç”±èˆ‡æ¬Šè¡¡
- [x] **ç•Œé™ä¸Šä¸‹æ–‡æ¸…æ™°**: DDD æˆ°ç•¥è¨­è¨ˆä¸­çš„ä¸Šä¸‹æ–‡é‚Šç•Œæ˜ç¢ºï¼Œä¸Šä¸‹æ–‡é–“é—œä¿‚æ¸…æ¥šæ¨™ç¤º
- [x] **æ•¸æ“šæ¨¡å‹åˆç†**: æ•¸æ“šæ¨¡å‹éµå¾ªæ­£è¦åŒ–åŸå‰‡ï¼ŒER åœ–æ¸…æ¥šå±•ç¤ºå¯¦é«”é—œä¿‚
- [x] **ä¸€è‡´æ€§ç­–ç•¥æ˜ç¢º**: æ¸…æ¥šå€åˆ†å¼·ä¸€è‡´æ€§èˆ‡æœ€çµ‚ä¸€è‡´æ€§çš„ä½¿ç”¨å ´æ™¯
- [x] **SPOF è­˜åˆ¥èˆ‡é™ç´š**: è­˜åˆ¥æ‰€æœ‰å–®é»æ•…éšœï¼Œä¸¦æä¾›é™ç´šç­–ç•¥èˆ‡æ”¹é€²è¨ˆç•«
- [x] **æ¼”é€²æ€§è€ƒé‡**: è­˜åˆ¥æ˜“æ“´å±•éƒ¨åˆ†èˆ‡æ½›åœ¨ç“¶é ¸ï¼Œæä¾›æŠ€è¡“æ£§å‡ç´šè¨ˆç•«
- [x] **å¯è§€æ¸¬æ€§è¨­è¨ˆ**: åŒ…å« Metrics, Logs, Traces ä¸‰æ”¯æŸ±ï¼Œå®šç¾©å‘Šè­¦è¦å‰‡èˆ‡æ•…éšœå®šä½æµç¨‹
- [x] **åˆè¦æ€§è€ƒé‡**: æ•¸æ“šåˆ†é¡ã€åŠ å¯†ã€ä¿ç•™ç­–ç•¥ç¬¦åˆå°ç£å€‹è³‡æ³•è¦æ±‚

---

## 11. é—œè¯æ–‡ä»¶ (Related Documents)

- **éœ€æ±‚ä¾†æº**: [02_product_requirements_document.md](./02_product_requirements_document.md) - ç”¢å“éœ€æ±‚æ–‡ä»¶
- **æ±ºç­–è¨˜éŒ„**: [adr/](./adr/) - æ¶æ§‹æ±ºç­–è¨˜éŒ„ç›®éŒ„
- **è³‡æ–™åº«è¨­è¨ˆ**: [database/schema_design_v1.0.md](./database/schema_design_v1.0.md) - å®Œæ•´è³‡æ–™åº«è¨­è¨ˆæ–‡ä»¶
- **API è¨­è¨ˆ**: [06_api_design_specification.md](./06_api_design_specification.md) - å¾Œç«¯ API è¦ç¯„æ–‡ä»¶
- **å‰ç«¯æ¶æ§‹**: [12_frontend_architecture_specification.md](./12_frontend_architecture_specification.md) - å‰ç«¯æ¶æ§‹èˆ‡æŠ€è¡“æ£§è¦ç¯„
- **å‰ç«¯ä¿¡æ¯æ¶æ§‹**: [17_frontend_information_architecture_template.md](./17_frontend_information_architecture_template.md) - å‰ç«¯é é¢çµæ§‹èˆ‡ç”¨æˆ¶æ—…ç¨‹
- **æ¨¡çµ„è¦ç¯„**: [07_module_specification_and_tests.md](./07_module_specification_and_tests.md) - æ¨¡çµ„è¨­è¨ˆèˆ‡æ¸¬è©¦è¦ç¯„
- **BDD å ´æ™¯**: [bdd/](./bdd/) - è¡Œç‚ºé©…å‹•é–‹ç™¼å ´æ™¯
- **å°ˆæ¡ˆ README**: [../README.md](../README.md) - å°ˆæ¡ˆç¸½è¦½æ–‡ä»¶
- **WBS è¨ˆç•«**: [16_wbs_development_plan.md](./16_wbs_development_plan.md) - å·¥ä½œåˆ†è§£çµæ§‹èˆ‡æ™‚ç¨‹

---

## é™„éŒ„ A: æŠ€è¡“é¸å‹å°ç…§è¡¨

| éœ€æ±‚ | å€™é¸æ–¹æ¡ˆ | æœ€çµ‚æ±ºç­– | æ±ºç­–ä¾æ“š |
|------|----------|----------|----------|
| **Web æ¡†æ¶** | Flask vs FastAPI | FastAPI | ADR-001: ç•°æ­¥æ”¯æŒã€è‡ªå‹•æ–‡æª”ã€å‹åˆ¥æª¢æŸ¥ |
| **æ•¸æ“šåº«** | PostgreSQL vs MySQL | PostgreSQL | æˆç†Ÿç©©å®šã€pgvector æ“´å±•ã€JSON æ”¯æŒ |
| **å‘é‡è³‡æ–™åº«** | Pinecone vs Qdrant vs pgvector | pgvector | ADR-002: MVP ç°¡åŒ–æ¶æ§‹ã€æˆæœ¬ä½ |
| **äº‹ä»¶æ—¥èªŒ** | MongoDB vs Elasticsearch | MongoDB | ADR-003: Schema-lessã€æ˜“æ–¼æŸ¥è©¢ |
| **æ¶ˆæ¯éšŠåˆ—** | RabbitMQ vs Kafka | RabbitMQ | ADR-005: åœ˜éšŠç†Ÿæ‚‰ã€è¶³å¤ æ»¿è¶³éœ€æ±‚ |
| **ç·©å­˜** | Redis vs Memcached | Redis | æ•¸æ“šçµæ§‹è±å¯Œã€æŒä¹…åŒ–æ”¯æŒ |
| **å‰ç«¯æ¡†æ¶** | Next.js vs Remix | Next.js | ç”Ÿæ…‹æˆç†Ÿã€SSR æ€§èƒ½å„ªç§€ |
| **LLM Provider** | OpenAI vs Anthropic | OpenAI | æ–‡æª”å®Œå–„ã€ç¤¾ç¾¤æ”¯æŒå¼· |
| **éƒ¨ç½²å¹³å°** | Zeabur vs Railway vs Fly.io | Zeabur | å°ç£åœ¨åœ°æœå‹™ã€ä¸­æ–‡æ”¯æŒ |

---

## é™„éŒ„ B: ç¸®å¯«èˆ‡è¡“èªè¡¨

| ç¸®å¯« / è¡“èª | å…¨ç¨± / è§£é‡‹ |
|-------------|------------|
| **COPD** | Chronic Obstructive Pulmonary Disease (æ…¢æ€§é˜»å¡æ€§è‚ºç—…) |
| **PHI** | Protected Health Information (å—ä¿è­·å¥åº·è³‡è¨Š) |
| **PII** | Personal Identifiable Information (å€‹äººèº«ä»½è³‡è¨Š) |
| **RAG** | Retrieval-Augmented Generation (æª¢ç´¢å¢å¼·ç”Ÿæˆ) |
| **STT** | Speech-To-Text (èªéŸ³è½‰æ–‡å­—) |
| **TTS** | Text-To-Speech (æ–‡å­—è½‰èªéŸ³) |
| **LLM** | Large Language Model (å¤§å‹èªè¨€æ¨¡å‹) |
| **JWT** | JSON Web Token (JSON ç¶²é ä»¤ç‰Œ) |
| **RBAC** | Role-Based Access Control (è§’è‰²åŸºç¤å­˜å–æ§åˆ¶) |
| **DDD** | Domain-Driven Design (é ˜åŸŸé©…å‹•è¨­è¨ˆ) |
| **CQRS** | Command Query Responsibility Segregation (å‘½ä»¤æŸ¥è©¢è·è²¬åˆ†é›¢) |
| **SPOF** | Single Point of Failure (å–®é»æ•…éšœ) |
| **MTTR** | Mean Time To Repair (å¹³å‡æ•…éšœæ¢å¾©æ™‚é–“) |
| **RTO** | Recovery Time Objective (æ¢å¾©æ™‚é–“ç›®æ¨™) |
| **RPO** | Recovery Point Objective (æ¢å¾©é»ç›®æ¨™) |
| **APM** | Application Performance Monitoring (æ‡‰ç”¨æ€§èƒ½ç›£æ§) |

---


## é™„éŒ„ C: äº‹ä»¶é©…å‹•å¯¦ä½œç¯„ä¾‹

æœ¬é™„éŒ„æä¾›äº‹ä»¶é©…å‹•æ¶æ§‹çš„å®Œæ•´å¯¦ä½œä»£ç¢¼ç¯„ä¾‹ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ RespiraAlly ä¸­å¯¦ç¾äº‹ä»¶ç™¼å¸ƒã€è¨‚é–±èˆ‡è™•ç†ã€‚

### C.1 å¯¦ä½œç¯„ä¾‹

#### C.1.1 Publisher å¯¦ç¾ (ç™¼å¸ƒäº‹ä»¶)

**å ´æ™¯**: DailyLog Service æäº¤æ—¥èªŒå¾Œç™¼å¸ƒ `DailyLogSubmitted` äº‹ä»¶

```python
# modules/daily_log/domain/events.py
from dataclasses import dataclass
from datetime import date, datetime
from uuid import UUID

@dataclass
class DailyLogSubmitted:
    """é ˜åŸŸäº‹ä»¶ï¼šæ—¥èªŒå·²æäº¤"""
    log_id: UUID
    patient_id: UUID
    log_date: date
    medication_taken: bool
    water_intake_ml: int
    exercise_minutes: int
    symptoms: str
    submitted_at: datetime

    def to_dict(self) -> dict:
        return {
            "log_id": str(self.log_id),
            "patient_id": str(self.patient_id),
            "log_date": self.log_date.isoformat(),
            "medication_taken": self.medication_taken,
            "water_intake_ml": self.water_intake_ml,
            "exercise_minutes": self.exercise_minutes,
            "symptoms": self.symptoms,
            "submitted_at": self.submitted_at.isoformat()
        }

    @property
    def routing_key(self) -> str:
        return "daily_log.log.submitted"
```

```python
# modules/daily_log/application/use_cases/submit_daily_log.py
from modules.daily_log.domain.entities import DailyLog
from modules.daily_log.domain.events import DailyLogSubmitted
from modules.daily_log.domain.ports import IDailyLogRepository
from shared.event_bus import IEventBus
from shared.event_store import IEventStore

class SubmitDailyLogUseCase:
    def __init__(
        self,
        daily_log_repo: IDailyLogRepository,
        event_store: IEventStore,
        event_bus: IEventBus
    ):
        self.daily_log_repo = daily_log_repo
        self.event_store = event_store
        self.event_bus = event_bus

    async def execute(self, command: SubmitDailyLogCommand) -> DailyLog:
        # Step 1: å‰µå»ºé ˜åŸŸå°è±¡
        daily_log = DailyLog.create(
            patient_id=command.patient_id,
            log_date=command.log_date,
            medication_taken=command.medication_taken,
            water_intake_ml=command.water_intake_ml,
            # ...
        )

        # Step 2: åŸå­æ€§æ“ä½œ (åœ¨åŒä¸€å€‹äº‹å‹™ä¸­)
        async with self.db_session.begin():
            # 2a. æŒä¹…åŒ–èšåˆ
            saved_log = await self.daily_log_repo.save(daily_log)

            # 2b. ä¿å­˜äº‹ä»¶åˆ° event_logs (Outbox Pattern)
            event = DailyLogSubmitted(
                log_id=saved_log.log_id,
                patient_id=saved_log.patient_id,
                log_date=saved_log.log_date,
                medication_taken=saved_log.medication_taken,
                water_intake_ml=saved_log.water_intake_ml,
                exercise_minutes=saved_log.exercise_minutes,
                symptoms=saved_log.symptoms,
                submitted_at=datetime.utcnow()
            )

            await self.event_store.append(
                event_type="daily_log.DailyLogSubmitted",
                aggregate_id=saved_log.log_id,
                aggregate_type="DailyLog",
                payload=event.to_dict(),
                metadata={
                    "correlation_id": command.correlation_id,
                    "user_id": str(command.user_id)
                }
            )

        # Step 3: äº‹å‹™æˆåŠŸæäº¤ï¼Œè¿”å›çµæœ
        # (å¾Œå° Worker æœƒè‡ªå‹•ç™¼å¸ƒ event_logs ä¸­æœªç™¼å¸ƒçš„äº‹ä»¶)
        return saved_log
```

#### C.1.2 Subscriber å¯¦ç¾ (è¨‚é–±äº‹ä»¶)

**å ´æ™¯**: Risk Service è¨‚é–± `DailyLogSubmitted` äº‹ä»¶ï¼Œé‡æ–°è¨ˆç®—é¢¨éšªåˆ†æ•¸

```python
# modules/risk/application/event_handlers/daily_log_handler.py
from modules.risk.application.use_cases import CalculateRiskScoreUseCase
from modules.daily_log.domain.events import DailyLogSubmitted
from shared.event_bus import IEventHandler

class DailyLogSubmittedHandler(IEventHandler):
    """è™•ç† DailyLogSubmitted äº‹ä»¶"""

    def __init__(self, calculate_risk_use_case: CalculateRiskScoreUseCase):
        self.calculate_risk_use_case = calculate_risk_use_case

    async def handle(self, event: DailyLogSubmitted):
        """è™•ç†äº‹ä»¶é‚è¼¯"""
        try:
            # è§¸ç™¼é¢¨éšªåˆ†æ•¸é‡æ–°è¨ˆç®—
            await self.calculate_risk_use_case.execute(
                patient_id=event.patient_id
            )

            logger.info(
                f"Risk score recalculated for patient {event.patient_id} "
                f"after log submission on {event.log_date}"
            )

        except Exception as e:
            logger.error(
                f"Failed to calculate risk for patient {event.patient_id}: {e}",
                exc_info=True
            )
            # é‡æ–°æ‹‹å‡ºç•°å¸¸ï¼Œè®“ RabbitMQ é‡è©¦
            raise
```

```python
# modules/risk/infrastructure/event_subscribers.py
from shared.rabbitmq import RabbitMQEventBus

async def setup_event_subscribers(event_bus: RabbitMQEventBus):
    """è¨»å†Šæ‰€æœ‰äº‹ä»¶è¨‚é–±è€…"""

    # è¨»å†Š DailyLogSubmitted äº‹ä»¶è™•ç†å™¨
    await event_bus.subscribe(
        queue_name="risk_service.log_events",
        binding_keys=["daily_log.log.submitted", "daily_log.log.deleted"],
        handler=DailyLogSubmittedHandler(calculate_risk_use_case),
        prefetch_count=10  # æ¯æ¬¡é å– 10 æ¢è¨Šæ¯
    )

    # è¨»å†Š SurveyCompleted äº‹ä»¶è™•ç†å™¨
    await event_bus.subscribe(
        queue_name="risk_service.survey_events",
        binding_keys=["survey.survey.completed"],
        handler=SurveyCompletedHandler(calculate_risk_use_case),
        prefetch_count=10
    )
```

#### C.1.3 Event Bus ä»‹é¢å®šç¾©

```python
# shared/event_bus/interface.py
from abc import ABC, abstractmethod
from typing import Callable, List

class IEventBus(ABC):
    """äº‹ä»¶ç¸½ç·šæ¥å£ (Port)"""

    @abstractmethod
    async def publish(
        self,
        routing_key: str,
        payload: dict,
        metadata: dict = None
    ) -> None:
        """ç™¼å¸ƒäº‹ä»¶åˆ° Exchange"""
        pass

    @abstractmethod
    async def subscribe(
        self,
        queue_name: str,
        binding_keys: List[str],
        handler: Callable,
        prefetch_count: int = 1
    ) -> None:
        """è¨‚é–±äº‹ä»¶"""
        pass

    @abstractmethod
    async def close(self) -> None:
        """é—œé–‰é€£æ¥"""
        pass
```

```python
# shared/event_bus/rabbitmq_adapter.py
import aio_pika
import json
from shared.event_bus.interface import IEventBus

class RabbitMQEventBus(IEventBus):
    """RabbitMQ äº‹ä»¶ç¸½ç·šå¯¦ç¾ (Adapter)"""

    def __init__(self, connection_url: str):
        self.connection_url = connection_url
        self.connection = None
        self.channel = None
        self.exchange = None

    async def connect(self):
        """å»ºç«‹é€£æ¥"""
        self.connection = await aio_pika.connect_robust(self.connection_url)
        self.channel = await self.connection.channel()

        # è²æ˜ Exchange
        self.exchange = await self.channel.declare_exchange(
            "respira.events",
            aio_pika.ExchangeType.TOPIC,
            durable=True
        )

    async def publish(
        self,
        routing_key: str,
        payload: dict,
        metadata: dict = None
    ) -> None:
        """ç™¼å¸ƒäº‹ä»¶"""
        message_body = {
            "payload": payload,
            "metadata": metadata or {}
        }

        message = aio_pika.Message(
            body=json.dumps(message_body).encode(),
            content_type="application/json",
            delivery_mode=aio_pika.DeliveryMode.PERSISTENT  # æŒä¹…åŒ–
        )

        await self.exchange.publish(
            message,
            routing_key=routing_key
        )

        logger.debug(f"Published event to {routing_key}")

    async def subscribe(
        self,
        queue_name: str,
        binding_keys: List[str],
        handler: Callable,
        prefetch_count: int = 1
    ) -> None:
        """è¨‚é–±äº‹ä»¶"""
        # è¨­ç½® QoS
        await self.channel.set_qos(prefetch_count=prefetch_count)

        # è²æ˜ Queue
        queue = await self.channel.declare_queue(
            queue_name,
            durable=True,
            arguments={
                "x-message-ttl": 86400000,  # 24 å°æ™‚
                "x-dead-letter-exchange": "respira.dlx"
            }
        )

        # ç¶å®š Routing Keys
        for binding_key in binding_keys:
            await queue.bind(self.exchange, routing_key=binding_key)

        # é–‹å§‹æ¶ˆè²»
        async def on_message(message: aio_pika.IncomingMessage):
            async with message.process(requeue=False):
                try:
                    body = json.loads(message.body.decode())
                    await handler.handle(body["payload"])

                except Exception as e:
                    logger.error(f"Handler failed: {e}", exc_info=True)
                    # è¨Šæ¯æœƒé€²å…¥ DLQ (å› ç‚º requeue=False)
                    raise

        await queue.consume(on_message)
        logger.info(f"Subscribed to {queue_name} with bindings: {binding_keys}")

    async def close(self):
        """é—œé–‰é€£æ¥"""
        if self.connection:
            await self.connection.close()
```

#### C.1.4 å®Œæ•´æµç¨‹ç¯„ä¾‹ (ç«¯åˆ°ç«¯)

**å ´æ™¯**: ç”¨æˆ¶æäº¤æ—¥èªŒ â†’ è§¸ç™¼é¢¨éšªè¨ˆç®— â†’ ç™¼é€é€šçŸ¥

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ¶ (LINE)
    participant API as FastAPI
    participant LogUC as SubmitDailyLogUseCase
    participant DB as PostgreSQL
    participant Worker as Event Publisher Worker
    participant RabbitMQ as RabbitMQ
    participant RiskWorker as Risk Worker
    participant NotifWorker as Notification Worker

    User->>API: POST /api/v1/daily-logs
    API->>LogUC: execute(command)

    Note over LogUC,DB: åŸå­æ€§äº‹å‹™
    LogUC->>DB: 1. INSERT INTO daily_logs
    LogUC->>DB: 2. INSERT INTO event_logs<br/>(is_published=false)
    DB-->>LogUC: äº‹å‹™æäº¤æˆåŠŸ

    LogUC-->>API: è¿”å› 201 Created
    API-->>User: æ—¥èªŒæäº¤æˆåŠŸ

    Note over Worker,RabbitMQ: å¾Œå°ç•°æ­¥ç™¼å¸ƒ
    loop æ¯ 100ms
        Worker->>DB: SELECT * FROM event_logs<br/>WHERE is_published=false
        DB-->>Worker: è¿”å›æœªç™¼å¸ƒäº‹ä»¶
        Worker->>RabbitMQ: PUBLISH to respira.events<br/>Routing Key: daily_log.log.submitted
        Worker->>DB: UPDATE event_logs<br/>SET is_published=true
    end

    Note over RabbitMQ,RiskWorker: é¢¨éšªè¨ˆç®—
    RabbitMQ->>RiskWorker: Deliver: DailyLogSubmitted
    RiskWorker->>RiskWorker: CalculateRiskScoreUseCase.execute()
    RiskWorker->>DB: UPDATE risk_scores
    RiskWorker->>DB: INSERT INTO event_logs<br/>(RiskScoreCalculated)
    RiskWorker->>RabbitMQ: ACK

    Note over RabbitMQ,NotifWorker: é€šçŸ¥ç™¼é€
    RabbitMQ->>NotifWorker: Deliver: RiskScoreCalculated
    NotifWorker->>NotifWorker: SendNotificationUseCase.execute()
    NotifWorker->>NotifWorker: LINE Push Message
    NotifWorker->>RabbitMQ: ACK
```

**æ™‚åºèªªæ˜**:
1. **åŒæ­¥éšæ®µ** (0-200ms): ç”¨æˆ¶æäº¤æ—¥èªŒ â†’ æ•¸æ“šæŒä¹…åŒ– â†’ è¿”å›æˆåŠŸ
2. **ç•°æ­¥éšæ®µ** (200ms-5s): äº‹ä»¶ç™¼å¸ƒ â†’ é¢¨éšªè¨ˆç®— â†’ é€šçŸ¥ç™¼é€
3. **å¤±æ•—è™•ç†**: ä»»ä¸€éšæ®µå¤±æ•—ï¼Œä¸å½±éŸ¿å‰åºéšæ®µï¼ˆæœ€çµ‚ä¸€è‡´æ€§ï¼‰

---


---

**æ–‡ä»¶çµæŸ** | æœ€å¾Œæ›´æ–°: 2025-10-19
