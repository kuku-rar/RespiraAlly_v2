# ADR-005: 採用 RabbitMQ 作為異步任務的訊息佇列

---

**狀態 (Status):** `已接受 (Accepted)`

**決策者 (Deciders):** `[技術負責人, 開發團隊]`

**日期 (Date):** `2025-10-13`

---

## 1. 背景與問題陳述 (Context and Problem Statement)

*   **上下文 (Context):** `RespiraAlly V2` 系統中包含多個需要異步處理的耗時任務，最典型的就是 AI 語音處理鏈 (STT -> LLM -> TTS)。如果 API 服務同步處理這些請求，將會導致請求長時間阻塞，嚴重影響使用者體驗。
*   **問題陳述 (Problem Statement):** 我們需要引入一個訊息中介 (Message Broker) 來解耦服務和實現異步處理。此決策需要在不同技術方案（如任務佇列框架、訊息佇列）之間進行權衡，考量點包括開發複雜度、系統可靠性、可擴展性和運維成本。
*   **驅動因素/約束條件 (Drivers / Constraints):**
    *   **驅動因素 1:** 解耦服務：主 API 服務不應被耗時的背景任務（如 AI 推理）拖累。
    *   **驅動因素 2:** 削峰填谷：保護後端系統在高併發請求下不被衝垮。
    *   **驅動因素 3:** 可靠性：確保任務即使在短暫失敗後也能被重試，最終成功執行。
    *   **驅動因素 4:** 可擴展性：可以獨立地擴展 API 服務和 Worker 服務。

## 2. 考量的選項 (Considered Options)

### 選項一：使用 Celery + Redis/RabbitMQ

*   **描述：** 採用 Python 生態中成熟的分散式任務佇列框架 Celery。
*   **優點 (Pros)：**
    *   功能豐富，內建重試、排程、監控等。
    *   與 Python/FastAPI 整合度高，社群支持廣泛。
*   **缺點 (Cons)：**
    *   **框架過重**: 對於目前相對簡單的任務場景，可能引入不必要的複雜性。
    *   **配置複雜**: 配置選項繁多，有學習曲線。
*   **成本/複雜度評估:** 開發複雜度中等，但框架本身的複雜度較高。

### 選序二：使用 Kafka

*   **描述：** 採用為處理大規模事件流設計的分散式平台 Kafka。
*   **優點 (Pros)：**
    *   **極高吞吐量**: 性能非常出色。
    *   **持久化日誌**: 適合事件溯源 (Event Sourcing) 架構，可重播事件。
*   **缺點 (Cons)：**
    *   **運維複雜**: 運維 Kafka 叢集（包括 Zookeeper）比 RabbitMQ 複雜得多。
    *   **功能過剩**: 對於我們目前的「任務分發」場景，其事件流特性有些大材小用。
*   **成本/複雜度評估:** 運維複雜度和基礎設施成本高。

### 選項三：直接使用 RabbitMQ

*   **描述：** 採用基於 AMQP 標準協議的成熟訊息佇列 RabbitMQ。
*   **優點 (Pros)：**
    *   **成熟穩定**: 業界應用最廣泛的訊息佇列之一。
    *   **靈活的路由**: 提供多種交換機類型，可實現複雜的訊息路由策略。
    *   **功能完善**: 內建訊息確認、持久化、死信佇列等企業級特性。
    *   **輕量與平衡**: 相較於 Kafka，更輕量，更專注於訊息傳遞。
*   **缺點 (Cons)：**
    *   **吞吐量極限**: 在極端高吞吐量場景下不如 Kafka。
    *   **無內建日誌重播**: 不適合做事件溯源的底層儲存。
*   **成本/複雜度評估:** 運維複雜度中等（可透過託管服務降低），功能與需求匹配度高。

---

## 3. 決策 (Decision Outcome)

**最終選擇的方案：** `選項三：直接使用 RabbitMQ`。

**選擇理由 (Rationale):**
在 RabbitMQ 和 Kafka 之間，我們選擇了 RabbitMQ，因為它更符合我們當前的需求——一個可靠、靈活的「任務路由器」。Kafka 更像是一個「分散式事件日誌」，雖然強大，但運維複雜且與我們的使用場景不完全匹配。

同時，我們不選擇 Celery 這種重型框架，是因為希望保持架構的輕量級。直接使用一個訊息佇列客戶端 (如 aio-pika) 加上我們自訂的 Worker 邏輯，能讓我們更好地控制程式碼，避免被框架過度綁定。RabbitMQ 在功能、成熟度和運維複雜度之間取得了最佳的平衡。

---

## 4. 決策的後果與影響 (Consequences)

*   **正面影響 / 預期收益：**
    *   API 服務與 AI Worker 服務成功解耦，提高了系統的響應速度和穩定性。
    *   可利用 RabbitMQ 的特性輕鬆實現任務的可靠投遞和失敗重試（例如使用死信佇列）。
    *   架構保持了靈活性，未來可以利用 Topic 交換機來實現更複雜的發布/訂閱模式。
*   **負面影響 / 引入的風險：**
    *   **運維成本**: 引入了 RabbitMQ 這個新元件，需要對其進行監控和管理。
    *   **單點故障風險**: 在 MVP 階段，部署單節點的 RabbitMQ 會是一個潛在的單點故障。
*   **緩解策略**:
    *   在 MVP 階段，我們會使用 Zeabur 等平台的託管 RabbitMQ 服務來降低運維成本。
    *   在產品成熟後，需要規劃遷移到高可用的 RabbitMQ 叢集。
*   **未來可能需要重新評估的觸發條件：**
    *   當系統的核心需求轉向事件溯源或需要處理超高吞吐量的日誌流時，可能需要重新評估 Kafka。
