# ADR-002: 採用 pgvector 作為初期向量資料庫方案

---

**狀態 (Status):** `已接受 (Accepted)`

**決策者 (Deciders):** `[技術負責人, AI團隊]`

**日期 (Date):** `2025-10-11`

---

## 1. 背景與問題陳述 (Context and Problem Statement)

*   **上下文 (Context):** `RespiraAlly V2` 的 AI 語音互動功能，其背後需要一個 RAG (檢索增強生成) 系統來提供可信的衛教知識。RAG 系統的核心是需要一個向量資料庫，用於儲存衛教文章的向量嵌入 (Embeddings) 並進行高效的相似度搜尋。
*   **問題陳述 (Problem Statement):** 我們需要在多種向量資料庫方案中做出選擇。該選擇必須平衡 MVP 階段的開發速度、架構簡潔性、運維成本，以及未來的可擴展性。錯誤的選擇可能導致過早的架構複雜化或未來大規模重構。
*   **驅動因素/約束條件 (Drivers / Constraints):**
    *   **驅動因素 1:** 功能需求：需要儲存文字向量並執行 Top-K 相似度搜尋。
    *   **驅動因素 2:** 架構簡潔性：MVP 階段希望盡可能減少引入的外部元件。
    *   **驅動因素 3:** 數據一致性：衛教文章原文與其向量表示應易於同步管理。
    *   **約束條件 1:** 專案初期應避免昂貴的專用資料庫託管服務。

## 2. 考量的選項 (Considered Options)

### 選項一：使用專門的向量資料庫 (如 Milvus, Weaviate)

*   **描述：** 部署一個獨立的、專為向量搜尋優化的資料庫服務。
*   **優點 (Pros)：**
    *   **高性能**: 提供 HNSW, IVF 等先進索引，專為大規模向量搜尋設計。
    *   **功能豐富**: 支援混合搜尋、過濾等進階功能。
    *   **高可擴展性**: 設計用於處理數十億級別的向量。
*   **缺點 (Cons)：**
    *   **高複雜度**: 需要額外部署和維護一個獨立服務，增加運維成本。
    *   **數據同步問題**: 需額外機制保證 PostgreSQL (元數據) 與向量庫之間的資料一致性。
*   **成本/複雜度評估:** 部署與維護複雜度高，基礎設施成本高。

### 選項二：使用雲端向量資料庫服務 (如 Pinecone)

*   **描述：** 採用第三方全託管的向量資料庫 SaaS 服務。
*   **優點 (Pros)：**
    *   **全託管**: 無需擔心部署與運維。
    *   **高性能與易用性**: 提供簡單的 API 和優秀的性能。
*   **缺點 (Cons)：**
    *   **廠商鎖定**: 數據被鎖定在特定雲端廠商。
    *   **成本**: 對於初期專案來說，成本可能較高。
    *   **數據同步問題**: 與選項一類似。
*   **成本/複雜度評估:** 開發複雜度低，但長期運營成本高且有廠商鎖定風險。

### 選項三：使用 PostgreSQL 的 pgvector 擴充套件

*   **描述：** 在現有的 PostgreSQL 資料庫上安裝 `pgvector` 擴充套件，使其具備儲存和查詢向量的能力。
*   **優點 (Pros)：**
    *   **架構極簡**: 無需引入新元件，向量與元資料儲存在同一張表中。
    *   **強數據一致性**: 可利用 PostgreSQL 的 ACID 事務，確保文章內容與其向量的同步更新。
    *   **低運維成本**: 團隊熟悉 PostgreSQL 的運維。
    *   **查詢靈活**: 可在單一 SQL 查詢中混合向量搜尋與傳統的屬性過濾。
*   **缺點 (Cons)：**
    *   **性能極限**: 對於超大規模（數億級）的向量，性能可能不如專門的向量資料庫。
    *   **功能相對基礎**: 索引類型和進階功能較少。
*   **成本/複雜度評估:** 幾乎無額外成本，實現複雜度極低。

---

## 3. 決策 (Decision Outcome)

**最終選擇的方案：** `選項三：使用 PostgreSQL 的 pgvector 擴充套件`。

**選擇理由 (Rationale):**
對於專案初期（MVP），衛教文章數量預計在千至萬篇級別，對應的向量規模在百萬級以下，`pgvector` 的性能完全可以滿足需求。它帶來的 **架構簡潔性、低運維成本和強數據一致性保證**，是現階段最重要的優勢。這是一個務實的選擇，避免了過早優化和不必要的架構複雜性，完美契合敏捷開發的原則。

---

## 4. 決策的後果與影響 (Consequences)

*   **正面影響 / 預期收益：**
    *   RAG 功能的開發與部署流程簡化，可以更快交付。
    *   降低了 MVP 階段的基礎設施成本與運維負擔。
    *   從根本上確保了衛教資料的強一致性。
*   **負面影響 / 引入的風險：**
    *   **未來遷移成本**: 如果未來系統規模擴展到千萬級以上向量，可能需要將資料從 `pgvector` 遷移到專門的向量資料庫。
*   **緩解策略**: 我們將在 Repository 層的設計中預留抽象接口，將 `pgvector` 的具體實現細節封裝起來，以降低未來遷移的難度。
*   **未來可能需要重新評估的觸發條件：**
    *   當向量數據量超過 500 萬，且查詢延遲 P95 超過 1000ms 時。
