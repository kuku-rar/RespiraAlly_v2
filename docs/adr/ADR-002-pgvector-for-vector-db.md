# ADR-002: 採用 pgvector 作為初期向量資料庫方案

**狀態**: 已決定 (Accepted)

**日期**: 2025-10-11

## 背景 (Context)

RespiraAlly V2 的核心功能之一是 AI 語音互動，其背後需要一個 RAG (檢索增強生成) 系統來提供可信的衛教知識。RAG 系統的核心是向量資料庫，用於儲存衛教文章的向量嵌入 (Embeddings) 並進行高效的相似度搜尋。

## 決策驅動力 (Decision Drivers)

*   **功能需求**: 需要儲存文字向量並執行 Top-K 相似度搜尋。
*   **架構簡潔性**: 在專案初期 (MVP)，希望盡可能減少引入的外部元件數量，降低系統複雜度與運維成本。
*   **數據一致性**: 希望衛教文章的原文與其向量表示能方便地進行事務性管理。
*   **成本考量**: 避免在專案初期就投入昂貴的專用向量資料庫託管服務。

## 考量的方案 (Considered Options)

### 方案 1: 使用專門的向量資料庫 (如 Milvus, Weaviate)

*   **優點**:
    *   **高性能**: 專為大規模向量搜尋設計，提供多種先進的索引演算法 (如 HNSW, IVF)。
    *   **功能豐富**: 提供混合搜尋、過濾、標量量化等進階功能。
    *   **可擴展性好**: 設計用於處理數十億級別的向量。
*   **缺點**:
    *   **架構複雜度高**: 需要額外部署和維護一個獨立的服務。
    *   **數據同步問題**: 衛教文章的元資料 (metadata) 儲存在 PostgreSQL，向量儲存在 Milvus，需要額外的機制保證兩者之間的資料一致性。
    *   **運維成本高**: 需要專門的知識來調優和維護。

### 方案 2: 使用雲端向量資料庫服務 (如 Pinecone)

*   **優點**:
    *   **全託管**: 無需擔心部署與運維。
    *   **高性能與易用性**: 提供簡單的 API 和優秀的性能。
*   **缺點**:
    *   **廠商鎖定**: 數據被鎖定在特定雲端廠商。
    *   **成本**: 對於初期專案來說，成本可能較高。
    *   **數據同步問題**: 與方案 1 類似，存在數據一致性挑戰。

### 方案 3: 使用 PostgreSQL 的 pgvector 擴充套件 (最終選擇)

*   **優點**:
    *   **架構極簡**: 無需引入新的資料庫元件。向量與其關聯的元資料儲存在同一張表中，利用了現有的 PostgreSQL 服務。
    *   **數據一致性強**: 可以利用 PostgreSQL 的 ACID 事務，確保文章內容與其向量的同步更新。
    *   **運維成本低**: 團隊熟悉 PostgreSQL 的運維。
    *   **查詢靈活**: 可以在同一個 SQL 查詢中混合向量搜尋與傳統的屬性過濾。
*   **缺點**:
    *   **性能極限**: 對於超大規模（如數億級）的向量，其性能可能不如專門的向量資料庫。
    *   **功能相對基礎**: 相比 Milvus 等，提供的索引類型和進階功能較少。

## 決策 (Decision)

我們決定選擇 **方案 3: 使用 pgvector** 作為 RespiraAlly V2 MVP 階段的向量儲存與檢索方案。

對於專案初期，衛教文章數量預計在千至萬篇級別，向量規模在百萬級以下，pgvector 的性能完全可以滿足需求。它帶來的架構簡潔性、低運維成本和強數據一致性保證，是現階段最重要的優勢。這是一個務實的選擇，避免了過早優化和不必要的架構複雜性。

## 後果 (Consequences)

*   **正面**:
    *   開發與部署流程簡化，RAG 功能可以更快交付。
    *   降低了 MVP 階段的基礎設施成本與運維負擔。
    *   確保了衛教資料的強一致性。
*   **負面**:
    *   **未來遷移成本**: 如果未來系統規模擴展到千萬級以上向量，可能需要將資料從 pgvector 遷移到專門的向量資料庫。我們在 Repository 層的設計中會預留接口，以降低未來遷移的難度。
