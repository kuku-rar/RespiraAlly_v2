# ADR-008: 治療師登入失敗鎖定策略

---

**狀態 (Status):** `已接受 (Accepted)`

**決策者 (Deciders):** `[技術負責人, 安全顧問]`

**日期 (Date):** `2025-10-17`

---

## 1. 背景與問題陳述 (Context and Problem Statement)

*   **上下文 (Context):** 在設計治療師儀表板的認證系統時，必須考慮到安全性問題，特別是防止暴力破解 (Brute-force) 和密碼猜測攻擊。
*   **問題陳述 (Problem Statement):** 若無任何登入失敗限制，攻擊者可以無限制地嘗試密碼組合，對系統安全和使用者帳號構成嚴重威脅。我們需要選擇一種有效的防禦機制，同時平衡使用者體驗和實現複雜度。
*   **驅動因素/約束條件 (Drivers / Constraints):**
    *   **驅動因素 1:** 安全性：保護用戶帳號不被惡意行為者盜用。
    *   **驅動因素 2:** 可用性：防止合法使用者因意外輸錯密碼而被長時間鎖定。
    *   **驅動因素 3:** 系統負載：避免因大量失敗的登入請求而增加認證服務的負擔。
    *   **約束條件 1:** 選擇的方案應易於在現有技術棧 (FastAPI, Redis) 上實現。

## 2. 考量的選項 (Considered Options)

### 選項一：無鎖定策略

*   **描述：** 不對登入失敗次數做任何限制。
*   **優點 (Pros)：**
    *   實現最簡單。
    *   合法用戶不會被鎖定。
*   **缺點 (Cons)：**
    *   **極不安全**: 系統完全暴露在暴力破解攻擊之下，不可接受。
*   **成本/複雜度評估:** 零成本，但帶來無限的風險。

### 選項二：引入驗證碼 (CAPTCHA)

*   **描述：** 在偵測到幾次登入失敗後，要求使用者完成驗證碼挑戰。
*   **優點 (Pros)：**
    *   可以有效阻止自動化的腳本攻擊。
*   **缺點 (Cons)：**
    *   **影響使用者體驗**: 驗證碼對使用者來說可能很煩人且難以辨識。
    *   增加了前端和後端的實現複雜度。
*   **成本/複雜度評估:** 前後端實現複雜度中等。

### 選項三：基於時間的帳號鎖定

*   **描述：** 在一定時間窗內，當登入失敗次數達到閾值時，暫時鎖定該帳號一段時間。
*   **優點 (Pros)：**
    *   **有效減緩攻擊**: 指數級增加了暴力破解的時間成本，使其幾乎不可行。
    *   **使用者體驗影響可控**: 只要閾值和鎖定時間設定合理，對正常用戶的影響很小。
    *   **實現簡單**: 可使用 Redis 的計數器和 TTL (Time-To-Live) 功能輕鬆實現。
*   **缺點 (Cons)：**
    *   **拒絕服務風險**: 攻擊者可故意輸錯密碼來鎖定合法用戶的帳號（但由於鎖定是暫時的，此風險可接受）。
*   **成本/複雜度評估:** 後端實現複雜度低。

---

## 3. 決策 (Decision Outcome)

**最終選擇的方案：** `選項三：基於時間的帳號鎖定`。

**具體參數:**
*   **失敗閾值**: 3 次
*   **時間窗口**: 15 分鐘
*   **鎖定時長**: 15 分鐘

**選擇理由 (Rationale):**
此策略在 **安全性、使用者體驗和實現複雜度** 之間取得了最佳平衡。它能有效防禦暴力破解，同時對因誤操作而被鎖定的合法用戶影響最小（僅鎖定 15 分鐘）。利用現有的 Redis 即可輕鬆實現，無需引入新的外部依賴或增加過多的前端複雜度。

---

## 4. 決策的後果與影響 (Consequences)

*   **正面影響 / 預期收益：**
    *   系統的認證安全性得到顯著提升。
    *   此功能在後端認證服務中實現，對前端應用程式的影響最小。
*   **負面影響 / 引入的風險：**
    *   **用戶溝通**: 前端需要在登入介面明確提示使用者剩餘的嘗試次數，以及帳號被鎖定後的原因和解鎖時間，避免用戶困惑。
    *   **Redis 依賴**: 認證流程現在對 Redis 產生了硬性依賴。
*   **緩解策略**:
    *   設計降級邏輯：在 Redis 服務短暫不可用時，可以暫時禁用鎖定功能，優先保證合法用戶的登入不受影響，同時發出警報。
*   **未來可能需要重新評估的觸發條件：**
    *   當出現針對性的、大規模的帳號鎖定攻擊（拒絕服務攻擊）時。
