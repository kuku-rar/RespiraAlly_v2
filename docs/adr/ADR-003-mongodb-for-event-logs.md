# ADR-003: 採用 MongoDB 儲存事件與非結構化日誌

**狀態**: 已決定 (Accepted)

**日期**: 2025-10-12

## 背景 (Context)

在 RespiraAlly V2 中，我們需要一個地方來儲存大量的、半結構化的數據，主要有兩類：
1.  **行為事件日誌**: 用於風險評估和使用者行為分析的事件流，例如 `daily_log.submitted`, `alert.triggered` 等。這些事件的結構可能會隨著業務發展而頻繁變更。
2.  **非結構化資料**: 例如 RAG 系統中衛教文章的原始 Markdown 內容及其分塊 (Chunks)。

傳統的關聯式資料庫 (PostgreSQL) 雖然可以透過 JSONB 欄位儲存，但在查詢和索引靈活性上不如專門的 NoSQL 資料庫。

## 決策驅動力 (Decision Drivers)

*   **Schema 靈活性**: 事件和日誌的結構需要能夠輕鬆演進，而不必執行成本高昂的資料庫遷移 (migration)。
*   **寫入性能**: 事件日誌系統通常是寫入密集型，需要高吞吐量的寫入能力。
*   **查詢需求**: 需要對巢狀的 JSON 結構進行複雜的查詢和索引。
*   **數據隔離**: 將變動頻繁的事件數據與核心的結構化業務數據 (如使用者、醫囑) 分開儲存，可以降低系統耦合度。

## 考量的方案 (Considered Options)

### 方案 1: 全部使用 PostgreSQL 的 JSONB 欄位

*   **優點**:
    *   維持單一資料庫技術棧，簡化架構和運維。
    *   可以利用事務來保證事件與主業務數據的一致性。
*   **缺點**:
    *   JSONB 的查詢語法相對繁瑣。
    *   對於大規模的半結構化數據，索引和查詢性能可能不如原生 NoSQL 資料庫。
    *   頻繁變更的 Schema 會讓 ORM 層的程式碼管理變得複雜。

### 方案 2: 採用 Elasticsearch

*   **優點**:
    *   **強大的搜尋能力**: 全文搜尋和聚合分析是其核心優勢。
    *   **可觀測性生態**: 與 Logstash, Kibana (ELK Stack) 結合，非常適合日誌分析。
*   **缺點**:
    *   **資源消耗大**: 運維一個 Elasticsearch 叢集需要較高的硬體資源和專業知識。
    *   **非通用儲存**: 主要定位是搜尋引擎，作為通用的應用程式資料庫不是其強項。
    *   對於我們目前的需求來說，有些功能過剩 (overkill)。

### 方案 3: 採用 MongoDB (最終選擇)

*   **優點**:
    *   **Schema-less**: 靈活的文檔模型完美契合我們事件日誌快速迭代的需求。
    *   **豐富的查詢語言**: 提供強大且直觀的查詢 API，能輕鬆處理複雜的巢狀文檔。
    *   **開發友好**: 對於開發者來說，JSON-like 的 BSON 格式非常自然。
    *   **成熟的生態**: 擁有廣泛的社群支持和成熟的 Python 驅動程式 (PyMongo, Motor)。
    *   **平衡的選擇**: 兼顧了靈活性、性能和通用性，適合做為應用的第二資料庫。
*   **缺點**:
    *   **引入雙資料庫**: 增加了系統的運維複雜性，需要同時管理 PostgreSQL 和 MongoDB。
    *   **無事務保證**: 與 PostgreSQL 之間無法進行 ACID 事務，跨資料庫的一致性需要由應用程式層面來保證（例如通過異步事件）。

## 決策 (Decision)

我們決定選擇 **方案 3: 採用 MongoDB** 來儲存事件日誌和 RAG 的非結構化內容。

MongoDB 的靈活文檔模型是應對事件 Schema 快速變化的最佳選擇。儘管這引入了維護雙資料庫的複雜性，但我們認為這種「因地制宜」的策略是值得的。將關聯性強、需要事務保證的核心業務數據放在 PostgreSQL，將變動快、結構靈活的事件數據放在 MongoDB，可以讓兩個系統各自發揮最大優勢。

## 後果 (Consequences)

*   **正面**:
    *   產品團隊可以更快地迭代事件日誌，增加新的追蹤欄位，而無需後端執行複雜的 DB Migration。
    *   核心資料庫 (PostgreSQL) 的負載降低，結構更穩定。
    *   開發人員可以利用 MongoDB 靈活的查詢能力，更容易地實現複雜的行為分析功能。
*   **負面**:
    *   **運維複雜度增加**: 需要部署、監控和備份 MongoDB。在 MVP 階段，我們會使用 Zeabur 的託管服務來降低此成本。
    *   **跨庫一致性挑戰**: 應用程式需要處理 PostgreSQL 和 MongoDB 之間的最終一致性問題。例如，一個操作可能成功寫入了 PostgreSQL 但寫入 MongoDB 失敗，需要設計重試或補償機制。
