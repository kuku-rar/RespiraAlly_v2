# ADR-003: 採用 MongoDB 儲存事件與非結構化日誌

---

**狀態 (Status):** `已接受 (Accepted)`

**決策者 (Deciders):** `[技術負責人, 開發團隊]`

**日期 (Date):** `2025-10-12`

---

## 1. 背景與問題陳述 (Context and Problem Statement)

*   **上下文 (Context):** 在 `RespiraAlly V2` 中，我們需要儲存大量的、半結構化的數據，主要包括用於行為分析的**事件流** (如 `daily_log.submitted`) 和 RAG 系統的**非結構化內容** (如衛教文章原文)。這些數據的結構可能會隨著業務發展而頻繁變更。
*   **問題陳述 (Problem Statement):** 使用傳統的關聯式資料庫 (PostgreSQL) 來儲存這些高度動態和半結構化的數據，會在 Schema 管理、查詢靈活性和寫入性能方面遇到挑戰，可能拖慢迭代速度並增加維護複雜性。
*   **驅動因素/約束條件 (Drivers / Constraints):**
    *   **驅動因素 1:** Schema 靈活性：事件結構需要能夠輕鬆演進，無需執行成本高昂的資料庫遷移。
    *   **驅動因素 2:** 寫入性能：事件日誌系統是寫入密集型，需要高吞吐量。
    *   **驅動因素 3:** 查詢靈活性：需要對巢狀的 JSON 結構進行複雜的查詢和索引。

## 2. 考量的選項 (Considered Options)

### 選項一：全部使用 PostgreSQL 的 JSONB 欄位

*   **描述：** 維持單一資料庫技術棧，利用 PostgreSQL 內建的 `JSONB` 類型來儲存半結構化數據。
*   **優點 (Pros)：**
    *   簡化架構和運維。
    *   可利用事務保證事件與主業務數據的一致性。
*   **缺點 (Cons)：**
    *   `JSONB` 的查詢語法相對繁瑣。
    *   大規模半結構化數據的索引和查詢性能可能不如原生 NoSQL 資料庫。
    *   頻繁變更的 Schema 會讓 ORM 層的程式碼管理變得複雜。
*   **成本/複雜度評估:** 運維複雜度低，但開發與長期維護複雜度中等。

### 選項二：採用 Elasticsearch

*   **描述：** 引入專為搜尋和日誌分析設計的 Elasticsearch。
*   **優點 (Pros)：**
    *   **強大的搜尋能力**: 全文搜尋和聚合分析是其核心優勢。
    *   **可觀測性生態**: 與 ELK Stack 結合，非常適合日誌分析。
*   **缺點 (Cons)：**
    *   **資源消耗大**: 運維一個 Elasticsearch 叢集需要較高的硬體資源和專業知識。
    *   **功能過剩**: 主要定位是搜尋引擎，作為通用的應用程式資料庫有些大材小用。
*   **成本/複雜度評估:** 運維複雜度和基礎設施成本高。

### 選項三：採用 MongoDB

*   **描述：** 引入一個文檔導向的 NoSQL 資料庫來專門處理半結構化數據。
*   **優點 (Pros)：**
    *   **Schema-less**: 靈活的文檔模型完美契合事件日誌快速迭代的需求。
    *   **豐富的查詢語言**: 提供強大且直觀的 API，能輕鬆處理複雜的巢狀文檔。
    *   **開發友好**: JSON-like 的 BSON 格式對開發者非常自然。
    *   **成熟的生態**: 擁有廣泛的社群支持和成熟的 Python 驅動程式。
*   **缺點 (Cons)：**
    *   **引入雙資料庫**: 增加了系統的運維複雜性。
    *   **無跨庫事務**: 與 PostgreSQL 之間無法進行 ACID 事務，一致性需由應用層保證。
*   **成本/複雜度評估:** 運維複雜度中等（可透過託管服務降低），開發複雜度低。

---

## 3. 決策 (Decision Outcome)

**最終選擇的方案：** `選項三：採用 MongoDB`。

**選擇理由 (Rationale):**
MongoDB 的靈活文檔模型是應對事件 Schema 快速變化的最佳選擇。儘管這引入了維護雙資料庫的複雜性，但我們認為這種「Polyglot Persistence (多語言持久化)」的策略是值得的。將關聯性強、需要事務保證的核心業務數據放在 PostgreSQL，將變動快、結構靈活的事件數據放在 MongoDB，可以讓兩個系統各自發揮最大優勢，實現了架構上的關注點分離。

---

## 4. 決策的後果與影響 (Consequences)

*   **正面影響 / 預期收益：**
    *   產品團隊可以更快地迭代事件日誌，增加新的追蹤欄位，而無需後端執行複雜的 DB Migration。
    *   核心資料庫 (PostgreSQL) 的負載降低，結構更穩定。
    *   開發人員可以利用 MongoDB 靈活的查詢能力，更容易地實現複雜的用戶行為分析功能。
*   **負面影響 / 引入的風險：**
    *   **運維複雜度增加**: 需要部署、監控和備份 MongoDB。
    *   **跨庫一致性挑戰**: 應用程式需要處理 PostgreSQL 和 MongoDB 之間的最終一致性問題。
*   **緩解策略**:
    *   在 MVP 階段，我們會使用 Zeabur 等平台的託管 MongoDB 服務來降低運維成本。
    *   跨庫一致性將通過異步事件和冪等消費者來保證，接受最終一致性模型。
*   **未來可能需要重新評估的觸發條件：**
    *   如果未來出現需要跨兩個資料庫進行強事務一致性的業務場景。
