# 模組規格與測試案例: 風險引擎

---

**文件版本:** `v1.0`
**最後更新:** `2025-10-16`
**主要作者:** `Claude Code AI`
**狀態:** `待開發 (To Do)`

---

## 模組: `RiskEngineService`

**對應架構文件**: `[./architecture_and_design.md#risk-svc]`
**對應 BDD Feature**: `N/A` (系統內部邏輯)
**對應使用者故事**: `US-601`

---

### 規格 1: `calculate_health_score`

**描述 (Description)**: 根據病患近期的一系列健康指標，計算其綜合健康分數。此分數用於動態更新風險等級。

**函式簽名 (Python Type Hints)**:
```python
def calculate_health_score(
    adherence_7d: float,         # 7 日依從率 (0.0 - 1.0)
    water_avg_30d: float,        # 30 日平均飲水量 (ml)
    exercise_avg_30d: float,     # 30 日平均運動時長 (min)
    smoke_avg_7d: float,         # 7 日平均抽菸量 (支)
    latest_cat_score: int,       # 最新 CAT 問卷分數 (0 - 40)
    # 假設已正規化為風險值 R̂ (0-100)
    survey_risk_normalized: int, # 最新問卷正規化風險 (0 - 100) 
) -> int:
    """Calculates the patient's health score based on multiple factors."""
    ...
```

**核心公式** (源自 `US-601`):
`S = 0.35×A₇ + 0.15×H₃₀ + 0.15×(100-N₃₀) + 0.15×(100-C) + 0.20×(100-R̂)`
*備註: 這裡的變數與函式簽名中的變數是對應的，但公式中的 H, N, C, R̂ 都是經過正規化 (normalized) 到 0-100 區間的值。*

**契約式設計 (Design by Contract, DbC)**:
*   **前置條件 (Preconditions)**:
    1.  `adherence_7d` 必須在 `0.0` 到 `1.0` 之間。
    2.  所有 `avg` 輸入值必須 `≥ 0`。
    3.  `latest_cat_score` 必須在 `0` 到 `40` 之間。
    4.  `survey_risk_normalized` 必須在 `0` 到 `100` 之間。
*   **後置條件 (Postconditions)**:
    1.  返回的健康分數必須是一個 `0` 到 `100` 之間的整數。
*   **不變性 (Invariants)**:
    1.  權重總和 (`0.35 + 0.15 + 0.15 + 0.15 + 0.20`) 必須恆等於 `1.0`。

---

### 測試情境與案例 (Test Scenarios & Cases)

#### 情境 1: 正常路徑 - 健康狀況良好的病患

*   **測試案例 ID**: `TC-RiskEngine-001`
*   **描述**: 一個各項指標都表現良好的病患，應得到一個高的健康分數。
*   **輸入值 (假設已正規化)**:
    *   `A₇` (依從率): 100 (100%)
    *   `H₃₀` (飲水): 90
    *   `N₃₀` (運動): 85
    *   `C` (抽菸): 0
    *   `R̂` (問卷風險): 10
*   **預期計算**: `0.35*100 + 0.15*90 + 0.15*(100-0) + 0.15*(100-10) + 0.20*(100-85)` -> `35 + 13.5 + 15 + 13.5 + 1 = 78` (這裡公式似乎有誤，應為 `0.20*R̂` or `0.20*(100-R̂)`. 根據AC，分數越高越好，所以應為 `0.20×(100-R̂)`)
    * `S = 0.35*100 + 0.15*90 + 0.15*85 + 0.15*(100-0) + 0.20*(100-10) = 35 + 13.5 + 12.75 + 15 + 18 = 94.25` 
    * 根據`AGILE_DESIGN_DOCUMENT`的公式 `S = 0.35×A₇ + 0.15×H₃₀ + 0.15×(100-N₃₀) + 0.15×(100-C) + 0.20×(100-R̂)`，其中A7是依從率，H30是飲水，N30是運動，C是抽菸，R̂是問卷風險。 A, H, N, C 都是越大越好, R̂ 是越小越好。
    * 讓我們重新根據 `AGILE_DESIGN_DOCUMENT` 的公式 `S = 0.35×A₇ + 0.15×H₃₀ + 0.15×(100-N₃₀) + 0.15×(100-C) + 0.20×(100-R̂)`
    *   `A₇` (依從率): 100
    *   `H₃₀` (飲水): 90
    *   `N₃₀` (運動): 85
    *   `C` (抽菸): 0
    *   `R̂` (問卷風險): 10
    * `S = 0.35*100 + 0.15*90 + 0.15*(100-85) + 0.15*(100-0) + 0.20*(100-10)`
    * `S = 35 + 13.5 + 0.15*15 + 0.15*100 + 0.20*90 = 35 + 13.5 + 2.25 + 15 + 18 = 83.75`
*   **預期結果**: `round(83.75)` -> `84`。屬於 "Low" risk bucket (≥80)。

#### 情境 2: 正常路徑 - 健康狀況較差的病患

*   **測試案例 ID**: `TC-RiskEngine-002`
*   **描述**: 一個多項指標不佳的病患，應得到一個低的健康分數。
*   **輸入值 (假設已正規化)**:
    *   `A₇` (依從率): 30
    *   `H₃₀` (飲水): 40
    *   `N₃₀` (運動): 20
    *   `C` (抽菸): 50
    *   `R̂` (問卷風險): 70
*   **預期計算**: `S = 0.35*30 + 0.15*40 + 0.15*(100-20) + 0.15*(100-50) + 0.20*(100-70) = 10.5 + 6 + 12 + 7.5 + 6 = 42`
*   **預期結果**: `42`。屬於 "High" risk bucket (<60)。

#### 情境 3: 邊界情況 - 所有指標均為最差

*   **測試案例 ID**: `TC-RiskEngine-003`
*   **描述**: 測試分數的下限。
*   **輸入值**: `A₇=0, H₃₀=0, N₃₀=0, C=100, R̂=100`
*   **預期計算**: `S = 0.35*0 + 0.15*0 + 0.15*(100-0) + 0.15*(100-100) + 0.20*(100-100) = 0 + 0 + 15 + 0 + 0 = 15`
*   **預期結果**: `15`。

#### 情境 4: 邊界情況 - 所有指標均為最佳

*   **測試案例 ID**: `TC-RiskEngine-004`
*   **描述**: 測試分數的上限。
*   **輸入值**: `A₇=100, H₃₀=100, N₃₀=100, C=0, R̂=0`
*   **預期計算**: `S = 0.35*100 + 0.15*100 + 0.15*(100-100) + 0.15*(100-0) + 0.20*(100-0) = 35 + 15 + 0 + 15 + 20 = 85`
*   **預期結果**: `85`。
*   *Note: 根據公式，滿分似乎不是100，這是一個需要和產品經理確認的點。*

#### 情境 5: 無效輸入 (違反前置條件)

*   **測試案例 ID**: `TC-RiskEngine-005`
*   **描述**: 輸入的依從率為負數。
*   **測試步驟**: 呼叫 `calculate_health_score(adherence_7d=-0.5, ...)`
*   **預期結果**: 拋出 `ValueError` 或類似的例外，並提示 "adherence_7d must be between 0.0 and 1.0"。
